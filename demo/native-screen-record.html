<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç”ŸJSå½•å±+éŸ³é¢‘è½¬å­—å¹•ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 300;
            margin-bottom: 10px;
        }
        .main-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .control-panel, .video-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        .section-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }
        .btn-success { background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%); }
        .video-container {
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .video-container video { width: 100%; display: block; }
        .status-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .transcript-panel {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        .transcript-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }
        .translation-panel {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        .translation-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }
        .language-selector {
            margin-bottom: 15px;
        }
        .language-selector select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            margin-right: 10px;
        }
        .translation-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¹ å½•å±+éŸ³é¢‘è½¬å­—å¹•ç³»ç»Ÿ</h1>
            <p>åŸºäºåŸç”ŸJavaScriptçš„å±å¹•å½•åˆ¶ä¸å®æ—¶è¯­éŸ³è½¬æ–‡å­—è§£å†³æ–¹æ¡ˆ</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <h2 class="section-title">ğŸ® æ§åˆ¶é¢æ¿</h2>
                <div class="status-info" id="statusInfo">
                    <strong>ç³»ç»ŸçŠ¶æ€ï¼š</strong>å°±ç»ª
                </div>
                <button class="btn" id="startBtn" onclick="startRecording()">ğŸ¬ å¼€å§‹å½•åˆ¶</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢å½•åˆ¶</button>
                <button class="btn btn-success" id="downloadBtn" onclick="downloadVideo()" disabled>ğŸ’¾ ä¸‹è½½è§†é¢‘</button>
                <button class="btn" onclick="clearTranscript()">ğŸ—‘ï¸ æ¸…ç©ºå­—å¹•</button>
            </div>

            <div class="video-panel">
                <h2 class="section-title">ğŸ“º è§†é¢‘é¢„è§ˆ</h2>
                <div class="video-container">
                    <video id="previewVideo" controls style="display: none;"></video>
                    <div id="videoPlaceholder" style="height: 200px; display: flex; align-items: center; justify-content: center; color: #666;">
                        ç‚¹å‡»"å¼€å§‹å½•åˆ¶"å¼€å§‹å½•å±
                    </div>
                </div>
                <div class="status-info">
                    <strong>å½•åˆ¶ä¿¡æ¯ï¼š</strong>
                    <div id="recordingInfo">ç­‰å¾…å¼€å§‹å½•åˆ¶...</div>
                </div>
            </div>
        </div>

        <div class="transcript-panel">
            <h2 class="section-title">ğŸ“ å®æ—¶å­—å¹•</h2>
            <div class="transcript-content" id="transcriptContent">ç­‰å¾…è¯­éŸ³è¾“å…¥...</div>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="exportTranscript()">ğŸ“„ å¯¼å‡ºå­—å¹•</button>
                <button class="btn" onclick="copyTranscript()">ğŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
            </div>
        </div>

        <div class="translation-panel">
            <h2 class="section-title">ğŸŒ ç¿»è¯‘åŠŸèƒ½</h2>
            <div class="language-selector">
                <select id="translateAPI" onchange="changeTranslateAPI()">
                    <option value="localTranslate">æœ¬åœ°ç¿»è¯‘ (æ— CORSé—®é¢˜)</option>
                    <option value="myMemory">MyMemory (å…è´¹)</option>
                    <option value="googleTranslate">Google Translate (å…è´¹)</option>
                    <option value="libreTranslate">LibreTranslate (å…è´¹)</option>
                </select>
                <select id="targetLanguage">
                    <option value="en">è‹±è¯­ (English)</option>
                    <option value="ja">æ—¥è¯­ (æ—¥æœ¬èª)</option>
                    <option value="ko">éŸ©è¯­ (í•œêµ­ì–´)</option>
                    <option value="fr">æ³•è¯­ (FranÃ§ais)</option>
                    <option value="de">å¾·è¯­ (Deutsch)</option>
                    <option value="es">è¥¿ç­ç‰™è¯­ (EspaÃ±ol)</option>
                    <option value="ru">ä¿„è¯­ (Ğ ÑƒÑÑĞºĞ¸Ğ¹)</option>
                    <option value="ar">é˜¿æ‹‰ä¼¯è¯­ (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
                    <option value="pt">è‘¡è„ç‰™è¯­ (PortuguÃªs)</option>
                    <option value="it">æ„å¤§åˆ©è¯­ (Italiano)</option>
                </select>
                <button class="btn btn-warning" onclick="translateTranscript()">ğŸ”„ ç¿»è¯‘å­—å¹•</button>
                <button class="btn" onclick="clearTranslation()">ğŸ—‘ï¸ æ¸…ç©ºç¿»è¯‘</button>
            </div>
            <div class="translation-status" id="translationStatus" style="display: none;">
                <strong>ç¿»è¯‘çŠ¶æ€ï¼š</strong><span id="translationStatusText">å‡†å¤‡ç¿»è¯‘...</span>
            </div>
            <div class="translation-content" id="translationContent">ç­‰å¾…ç¿»è¯‘...</div>
            <div style="margin-top: 15px;">
                <button class="btn" onclick="exportTranslation()">ğŸ“„ å¯¼å‡ºç¿»è¯‘</button>
                <button class="btn" onclick="copyTranslation()">ğŸ“‹ å¤åˆ¶ç¿»è¯‘</button>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder = null;
        let recordedChunks = [];
        let stream = null;
        let recognition = null;
        let isRecording = false;
        let startTime = null;
        let transcriptText = '';
        let translationText = '';
        let isTranslating = false;

        // ç¿»è¯‘APIé…ç½® - æä¾›å¤šä¸ªé€‰é¡¹
        const TRANSLATE_APIS = {
            localTranslate: {
                url: 'local',
                name: 'æœ¬åœ°ç¿»è¯‘ (æ— CORSé—®é¢˜)',
                cors: true
            },
            myMemory: {
                url: 'https://api.mymemory.translated.net/get',
                name: 'MyMemory (å…è´¹)',
                cors: true
            },
            googleTranslate: {
                url: 'https://translate.googleapis.com/translate_a/single',
                name: 'Google Translate (å…è´¹)',
                cors: true
            },
            libreTranslate: {
                url: 'https://libretranslate.de/translate',
                name: 'LibreTranslate (å…è´¹)',
                cors: false
            }
        };
        
        // æ£€æµ‹æ˜¯å¦ä¸ºæœ¬åœ°æ–‡ä»¶è¿è¡Œ
        const isLocalFile = window.location.protocol === 'file:';
        let currentTranslateAPI = isLocalFile ? 'localTranslate' : 'myMemory'; // æœ¬åœ°æ–‡ä»¶é»˜è®¤ä½¿ç”¨æœ¬åœ°ç¿»è¯‘

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.lang = 'zh-CN';
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        }
                    }

                    if (finalTranscript) {
                        const timestamp = getTimestamp();
                        const line = `[${timestamp}] ${finalTranscript}\n`;
                        transcriptText += line;
                        document.getElementById('transcriptContent').textContent = transcriptText;
                    }
                };

                recognition.onend = function() {
                    if (isRecording) {
                        setTimeout(() => recognition.start(), 100);
                    }
                };

                return true;
            }
            return false;
        }

        async function startRecording() {
            try {
                // é‡ç½®ä¹‹å‰çš„å½•åˆ¶çŠ¶æ€
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: 1280, height: 720, frameRate: 30 },
                    audio: true
                });

                // è®¾ç½®å®æ—¶é¢„è§ˆ
                const previewVideo = document.getElementById('previewVideo');
                previewVideo.srcObject = stream;
                previewVideo.style.display = 'block';
                document.getElementById('videoPlaceholder').style.display = 'none';
                
                // ç¡®ä¿è§†é¢‘åŠ è½½å®Œæˆåæ’­æ”¾
                previewVideo.onloadedmetadata = function() {
                    previewVideo.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e));
                };
                
                // æ·»åŠ è§†é¢‘é”™è¯¯å¤„ç†
                previewVideo.onerror = function(e) {
                    console.error('è§†é¢‘é¢„è§ˆé”™è¯¯:', e);
                    document.getElementById('recordingInfo').innerHTML = 'è§†é¢‘é¢„è§ˆåŠ è½½å¤±è´¥';
                };

                recordedChunks = [];
                // æ£€æŸ¥æ”¯æŒçš„MIMEç±»å‹
                let mimeType = 'video/webm;codecs=vp9';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm;codecs=vp8';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm';
                }
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType
                });

                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = function() {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    // å½•åˆ¶ç»“æŸåï¼Œå°†é¢„è§ˆè§†é¢‘æºæ”¹ä¸ºå½•åˆ¶çš„æ–‡ä»¶
                    previewVideo.srcObject = null;
                    previewVideo.src = url;
                    document.getElementById('downloadBtn').disabled = false;
                };

                mediaRecorder.start(1000);
                isRecording = true;
                startTime = Date.now();

                if (initSpeechRecognition()) {
                    recognition.start();
                }

                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('statusInfo').innerHTML = '<strong>ç³»ç»ŸçŠ¶æ€ï¼š</strong>æ­£åœ¨å½•åˆ¶ä¸­...';
                document.getElementById('recordingInfo').innerHTML = 'å½•åˆ¶è¿›è¡Œä¸­...';

                stream.getVideoTracks()[0].onended = function() {
                    stopRecording();
                };

            } catch (err) {
                console.error('å½•åˆ¶å¤±è´¥:', err);
                alert('å½•åˆ¶å¤±è´¥: ' + err.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                if (recognition) {
                    recognition.stop();
                }

                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('statusInfo').innerHTML = '<strong>ç³»ç»ŸçŠ¶æ€ï¼š</strong>å½•åˆ¶å®Œæˆ';
                document.getElementById('recordingInfo').innerHTML = 'å½•åˆ¶å·²å®Œæˆ';
                
                // ç¡®ä¿å½•åˆ¶å®Œæˆåè§†é¢‘é¢„è§ˆæ­£å¸¸æ˜¾ç¤º
                const previewVideo = document.getElementById('previewVideo');
                if (previewVideo.srcObject) {
                    previewVideo.srcObject = null;
                }
            }
        }

        function downloadVideo() {
            if (recordedChunks.length > 0) {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `screen-recording-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.webm`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function getTimestamp() {
            if (!startTime) return '00:00:00';
            
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function clearTranscript() {
            transcriptText = '';
            document.getElementById('transcriptContent').textContent = 'ç­‰å¾…è¯­éŸ³è¾“å…¥...';
        }

        function exportTranscript() {
            if (!transcriptText) {
                alert('æ²¡æœ‰å­—å¹•å†…å®¹å¯å¯¼å‡º');
                return;
            }
            
            const blob = new Blob([transcriptText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyTranscript() {
            if (!transcriptText) {
                alert('æ²¡æœ‰å­—å¹•å†…å®¹å¯å¤åˆ¶');
                return;
            }
            
            navigator.clipboard.writeText(transcriptText).then(() => {
                alert('å­—å¹•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥');
            });
        }

        // ç¿»è¯‘åŠŸèƒ½
        async function translateTranscript() {
            if (!transcriptText || transcriptText === 'ç­‰å¾…è¯­éŸ³è¾“å…¥...') {
                alert('æ²¡æœ‰å­—å¹•å†…å®¹å¯ç¿»è¯‘');
                return;
            }

            if (isTranslating) {
                alert('æ­£åœ¨ç¿»è¯‘ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }

            const targetLang = document.getElementById('targetLanguage').value;
            const statusDiv = document.getElementById('translationStatus');
            const statusText = document.getElementById('translationStatusText');

            isTranslating = true;
            statusDiv.style.display = 'block';
            statusText.textContent = 'æ­£åœ¨ç¿»è¯‘...';

            try {
                // å°†å­—å¹•æ–‡æœ¬æŒ‰è¡Œåˆ†å‰²å¹¶ç¿»è¯‘
                const lines = transcriptText.split('\n').filter(line => line.trim());
                let translatedLines = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.trim()) {
                        // æå–æ—¶é—´æˆ³å’Œæ–‡æœ¬å†…å®¹
                        const match = line.match(/^(\[.*?\]) (.*)$/);
                        if (match) {
                            const timestamp = match[1];
                            const text = match[2];
                            
                            try {
                                const translatedText = await translateText(text, 'zh', targetLang);
                                translatedLines.push(`${timestamp} ${translatedText}`);
                                statusText.textContent = `æ­£åœ¨ç¿»è¯‘ç¬¬ ${i + 1}/${lines.length} è¡Œ...`;
                            } catch (err) {
                                console.error('ç¿»è¯‘å¤±è´¥:', err);
                                translatedLines.push(`${timestamp} [ç¿»è¯‘å¤±è´¥] ${text}`);
                            }
                        } else {
                            translatedLines.push(line);
                        }
                    }
                }

                translationText = translatedLines.join('\n');
                document.getElementById('translationContent').textContent = translationText;
                statusText.textContent = 'ç¿»è¯‘å®Œæˆ';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);

                                } catch (err) {
                        console.error('ç¿»è¯‘è¿‡ç¨‹å‡ºé”™:', err);
                        let errorMessage = 'ç¿»è¯‘å¤±è´¥: ' + err.message;
                        
                        // å¦‚æœæ˜¯CORSé”™è¯¯ï¼Œæä¾›è§£å†³æ–¹æ¡ˆ
                        if (err.message.includes('CORS') || err.message.includes('preflight')) {
                            errorMessage = 'ç¿»è¯‘å¤±è´¥: CORSè·¨åŸŸé—®é¢˜ã€‚è¯·å°è¯•åˆ‡æ¢åˆ°å…¶ä»–ç¿»è¯‘APIï¼Œæˆ–ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œæ­¤æ–‡ä»¶ã€‚';
                        }
                        
                        statusText.textContent = errorMessage;
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 8000);
                    } finally {
                        isTranslating = false;
                    }
        }

        function changeTranslateAPI() {
            currentTranslateAPI = document.getElementById('translateAPI').value;
            console.log('åˆ‡æ¢åˆ°ç¿»è¯‘API:', TRANSLATE_APIS[currentTranslateAPI].name);
            
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶ä¸”é€‰æ‹©äº†éœ€è¦ç½‘ç»œçš„APIï¼Œç»™å‡ºæç¤º
            if (isLocalFile && currentTranslateAPI !== 'localTranslate') {
                alert('æ³¨æ„ï¼šåœ¨æœ¬åœ°æ–‡ä»¶è¿è¡Œæ—¶ï¼Œç½‘ç»œç¿»è¯‘APIå¯èƒ½é‡åˆ°CORSé—®é¢˜ã€‚å»ºè®®ä½¿ç”¨"æœ¬åœ°ç¿»è¯‘"é€‰é¡¹ã€‚');
            }
        }

        async function translateText(text, sourceLang, targetLang) {
            const api = TRANSLATE_APIS[currentTranslateAPI];
            
            try {
                let response;
                
                switch (currentTranslateAPI) {
                    case 'localTranslate':
                        // æœ¬åœ°ç¿»è¯‘é€»è¾‘
                        console.log('ä½¿ç”¨æœ¬åœ°ç¿»è¯‘API');
                        // åœ¨æœ¬åœ°æ–‡ä»¶è¿è¡Œæ—¶ï¼Œç›´æ¥è¿”å›åŸå§‹æ–‡æœ¬
                        if (isLocalFile) {
                            return text;
                        }
                        // åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œæ—¶ï¼Œæ¨¡æ‹ŸAPIè°ƒç”¨
                        await new Promise(resolve => setTimeout(resolve, 100)); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                        return `[æœ¬åœ°ç¿»è¯‘] ${text}`; // ç¤ºä¾‹æœ¬åœ°ç¿»è¯‘
                        
                    case 'myMemory':
                        // MyMemory API - GETè¯·æ±‚ï¼ŒCORSå‹å¥½
                        const myMemoryUrl = `${api.url}?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
                        response = await fetch(myMemoryUrl);
                        if (!response.ok) {
                            throw new Error(`MyMemory APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                        }
                        const myMemoryData = await response.json();
                        return myMemoryData.responseData.translatedText;
                        
                    case 'googleTranslate':
                        // Google Translate API - GETè¯·æ±‚ï¼ŒCORSå‹å¥½
                        const googleUrl = `${api.url}?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                        response = await fetch(googleUrl);
                        if (!response.ok) {
                            throw new Error(`Google Translate APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                        }
                        const googleData = await response.json();
                        return googleData[0][0][0];
                        
                    case 'libreTranslate':
                        // LibreTranslate API - POSTè¯·æ±‚ï¼Œå¯èƒ½æœ‰CORSé—®é¢˜
                        response = await fetch(api.url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                q: text,
                                source: sourceLang,
                                target: targetLang,
                                format: 'text'
                            })
                        });
                        if (!response.ok) {
                            throw new Error(`LibreTranslate APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                        }
                        const libreData = await response.json();
                        return libreData.translatedText;
                        
                    default:
                        throw new Error('æœªçŸ¥çš„ç¿»è¯‘API');
                }
            } catch (error) {
                console.error('ç¿»è¯‘è¯·æ±‚å¤±è´¥:', error);
                // å¦‚æœå½“å‰APIå¤±è´¥ï¼Œå°è¯•åˆ‡æ¢åˆ°å…¶ä»–API
                if (currentTranslateAPI !== 'localTranslate') { // é¿å…æ— é™å¾ªç¯
                    console.log('å°è¯•åˆ‡æ¢åˆ°æœ¬åœ°ç¿»è¯‘API...');
                    currentTranslateAPI = 'localTranslate';
                    document.getElementById('translateAPI').value = 'localTranslate';
                    return await translateText(text, sourceLang, targetLang);
                }
                throw error;
            }
        }

        function clearTranslation() {
            translationText = '';
            document.getElementById('translationContent').textContent = 'ç­‰å¾…ç¿»è¯‘...';
            document.getElementById('translationStatus').style.display = 'none';
        }

        function exportTranslation() {
            if (!translationText || translationText === 'ç­‰å¾…ç¿»è¯‘...') {
                alert('æ²¡æœ‰ç¿»è¯‘å†…å®¹å¯å¯¼å‡º');
                return;
            }
            
            const targetLang = document.getElementById('targetLanguage').value;
            const blob = new Blob([translationText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `translation-${targetLang}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyTranslation() {
            if (!translationText || translationText === 'ç­‰å¾…ç¿»è¯‘...') {
                alert('æ²¡æœ‰ç¿»è¯‘å†…å®¹å¯å¤åˆ¶');
                return;
            }
            
            navigator.clipboard.writeText(translationText).then(() => {
                alert('ç¿»è¯‘å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                alert('æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å½•åˆ¶åŠŸèƒ½');
                document.getElementById('startBtn').disabled = true;
            }
        });
    </script>
</body>
</html>
