<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定位Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; color: #1a202c; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; color: #1a202c; padding: 40px 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .controls { padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .btn { border: 1px solid #007bff; color: #007bff; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { border-color: #0056b3; color: #0056b3; }
        .btn:disabled { border-color: #ccc; color: #ccc; cursor: not-allowed; }
        .status { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; border-radius: 4px; }
        #map { height: 500px; width: 100%; border-radius: 8px; border: 1px solid #dee2e6; }
        .info-panel { padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #dee2e6; }
        .info-item { margin: 10px 0; padding: 10px; border-radius: 4px; border-left: 3px solid #007bff; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #ccc; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .accuracy-bar { width: 100%; height: 8px; border: 1px solid #e9ecef; border-radius: 4px; overflow: hidden; margin: 5px 0; }
        .accuracy-fill { height: 100%; border-right: 2px solid #007bff; }
        .custom-marker { cursor: grab; }
        .custom-marker:active { cursor: grabbing; }
        .leaflet-popup-content button:hover { border-color: #0056b3 !important; color: #0056b3 !important; }
        .control-row { display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0; align-items: center; }
        .setting-group { display: flex; align-items: center; gap: 8px; }
        .setting-group label { font-weight: bold; color: #333; min-width: 80px; }
        .setting-group select, .setting-group input { padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
        .stats-row { display: flex; justify-content: space-between; border: 1px solid #e9ecef; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
        .stats-row span { color: #495057; }
        .location-history { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; }
        .history-item { padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; border-left: 3px solid #007bff; cursor: pointer; transition: all 0.2s; }
        .history-item:hover { border-color: #007bff; transform: translateX(5px); }
        .history-item.selected { border-color: #007bff; color: #007bff; font-weight: bold; }
        .accuracy-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .accuracy-high { border: 2px solid #28a745; }
        .accuracy-medium { border: 2px solid #ffc107; }
        .accuracy-low { border: 2px solid #dc3545; }
    </style>
</head>
<body>
    <!-- 返回文档链接 -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 2000; padding: 8px 12px; border-radius: 4px; border: 1px solid #dee2e6;">
        <a href="https://www.siqiongbiluo.love/article/25" style="text-decoration: none; color: #007bff; font-size: 14px;">← 返回文档</a>
    </div>
    <div class="container">
        <div class="header">
            <h1>定位Demo</h1>
            <p>支持IP定位和GPS定位，PC和H5通用</p>
            <div style="border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 14px;">
                <strong>定位精度说明：</strong><br>
                • <strong>GPS定位</strong>：最准确，精度可达几米到几十米<br>
                • <strong>IP定位</strong>：精度较低，可能显示运营商机房位置而非实际位置<br>
                • <strong>WiFi定位</strong>：基于周围WiFi网络信息定位，精度约20-100米<br>
                • <strong>基站定位</strong>：基于移动网络基站信息定位，精度约300-1000米<br>
                • <strong>拖动标记</strong>：可拖动地图上的标记来调整位置，右键点击地图可添加新标记
            </div>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <button class="btn" onclick="getIPLocation()" id="ipBtn">IP定位</button>
                <button class="btn" onclick="getGPSLocation()" id="gpsBtn">GPS定位</button>
                <button class="btn" onclick="getWifiLocation()" id="wifiBtn">WiFi定位</button>
                <button class="btn" onclick="getCellLocation()" id="cellBtn">基站定位</button>
            </div>
            <div class="control-row">
                <button class="btn" onclick="clearMap()">清除标记</button>
                <button class="btn" onclick="addManualMarker()">手动添加标记</button>
                <button class="btn" onclick="compareLocations()">位置对比</button>
                <button class="btn" onclick="exportLocation()">导出数据</button>
            </div>
            <div class="control-row">
                <div class="setting-group">
                    <label>精度范围:</label>
                    <select id="accuracyRange" onchange="updateAccuracySettings()">
                        <option value="all">全部精度</option>
                        <option value="high">高精度 (±50米内)</option>
                        <option value="medium">中等精度 (±200米内)</option>
                        <option value="low">低精度 (±1公里内)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>定位次数:</label>
                    <input type="number" id="maxAttempts" value="3" min="1" max="10" onchange="updateAttemptsSettings()">
                </div>
                <div class="setting-group">
                    <label>自动选择:</label>
                    <select id="autoSelect" onchange="updateAutoSelectSettings()">
                        <option value="best">最佳精度</option>
                        <option value="latest">最新结果</option>
                        <option value="manual">手动选择</option>
                    </select>
                </div>
            </div>
            <div class="stats-row">
                <span>统计: IP定位 <span id="ipCount">0</span>次 | GPS定位 <span id="gpsCount">0</span>次 | 总定位 <span id="totalCount">0</span>次</span>
                <span>最佳精度: <span id="bestAccuracy">-</span></span>
            </div>
            <div class="status" id="status">准备就绪，点击按钮开始定位</div>
        </div>
        
        <div id="map"></div>
        
        <div class="info-panel">
            <h3>定位信息</h3>
            <div id="locationInfo">等待定位...</div>
            <div class="info-item">
                <strong>设备信息:</strong>
                <div id="deviceInfo">正在获取...</div>
            </div>
            <div class="info-item">
                <strong>网络信息:</strong>
                <div id="networkInfo">正在获取...</div>
            </div>
        </div>
        
        <div class="info-panel">
            <h3>定位历史</h3>
            <div class="history-controls">
                <button class="btn" onclick="filterHistory()">筛选</button>
                <button class="btn" onclick="sortHistory()">排序</button>
                <button class="btn" onclick="clearHistory()">清空历史</button>
            </div>
            <div class="location-history" id="locationHistory">
                <div style="text-align: center; color: #666; padding: 20px;">暂无定位历史</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let currentMarker;
        let locationHistory = [];
        let locationStats = {
            ipCount: 0,
            gpsCount: 0,
            wifiCount: 0,
            cellCount: 0,
            manualCount: 0,
            totalCount: 0
        };
        let settings = {
            accuracyRange: 'all',
            maxAttempts: 3,
            autoSelect: 'best'
        };
        
        // 初始化地图
        function initMap() {
            const gaodeUrl = 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}';
            map = L.map('map').setView([39.9042, 116.4074], 10);
            L.tileLayer(gaodeUrl, {
                subdomains: '1234',
                attribution: '© 高德地图'
            }).addTo(map);
            updateStatus('地图初始化完成');
            updateDeviceInfo();
            updateNetworkInfo();
        }
        
        function updateStatus(message) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `<span class="loading"></span> ${message}`;
        }
        
        function updateStatusComplete(message) {
            document.getElementById('status').textContent = message;
        }
        
        // 更新统计信息
        function updateStats() {
            document.getElementById('ipCount').textContent = locationStats.ipCount;
            document.getElementById('gpsCount').textContent = locationStats.gpsCount;
            document.getElementById('totalCount').textContent = locationStats.totalCount;
            
            // 更新最佳精度
            if (locationHistory.length > 0) {
                const bestLocation = locationHistory.reduce((best, current) => {
                    const bestAccuracy = parseFloat(best.accuracy.match(/\d+/)?.[0] || 999999);
                    const currentAccuracy = parseFloat(current.accuracy.match(/\d+/)?.[0] || 999999);
                    return currentAccuracy < bestAccuracy ? current : best;
                });
                document.getElementById('bestAccuracy').textContent = bestLocation.accuracy;
            } else {
                document.getElementById('bestAccuracy').textContent = '-';
            }
        }
        
        // 更新历史记录显示
        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('locationHistory');
            
            if (locationHistory.length === 0) {
                historyContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无定位历史</div>';
                return;
            }
            
            let historyHTML = '';
            locationHistory.forEach((location, index) => {
                const accuracyClass = getAccuracyClass(location.accuracy);
                const accuracyIndicator = `<span class="accuracy-indicator ${accuracyClass}"></span>`;
                
                historyHTML += `
                    <div class="history-item" onclick="selectHistoryItem(${index})">
                        ${accuracyIndicator}
                        <strong>${location.type}</strong> - ${location.accuracy}<br>
                        <small>${location.address} | ${location.timestamp}</small>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
        }
        
        // 获取精度等级
        function getAccuracyClass(accuracy) {
            const accuracyValue = parseFloat(accuracy.match(/\d+/)?.[0] || 999999);
            if (accuracyValue <= 50) return 'accuracy-high';
            if (accuracyValue <= 200) return 'accuracy-medium';
            return 'accuracy-low';
        }
        
        // 选择历史记录项
        function selectHistoryItem(index) {
            if (index >= 0 && index < locationHistory.length) {
                const location = locationHistory[index];
                addMarker(location.lat, location.lng, location.type, getMarkerColor(location.type));
                updateLocationInfo(location);
                updateStatusComplete(`已选择历史记录: ${location.type}`);
            }
        }
        
        // 获取标记颜色
        function getMarkerColor(type) {
            const colors = {
                'IP定位': 'blue',
                'GPS定位': 'red',
                'WiFi定位': 'green',
                '基站定位': 'orange',
                '手动标记': 'purple',
                '右键标记': 'purple',
                '手动调整': 'purple'
            };
            return colors[type] || 'gray';
        }
        
        // 获取设备信息
        function updateDeviceInfo() {
            const info = [];
            info.push(`浏览器: ${navigator.userAgent.split(' ').slice(-2).join(' ')}`);
            info.push(`屏幕: ${screen.width}x${screen.height}`);
            info.push(`语言: ${navigator.language}`);
            info.push(`平台: ${navigator.platform}`);
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            info.push(`设备类型: ${isMobile ? '移动设备' : '桌面设备'}`);
            
            if (navigator.hardwareConcurrency) {
                info.push(`CPU核心: ${navigator.hardwareConcurrency}`);
            }
            
            if (navigator.deviceMemory) {
                info.push(`内存: ${navigator.deviceMemory}GB`);
            }
            
            document.getElementById('deviceInfo').innerHTML = info.join('<br>');
        }
        
        // 获取网络信息
        function updateNetworkInfo() {
            const info = [];
            
            if (navigator.connection) {
                const conn = navigator.connection;
                info.push(`网络类型: ${conn.effectiveType || '未知'}`);
                info.push(`下行速度: ${conn.downlink || '未知'} Mbps`);
                info.push(`网络延迟: ${conn.rtt || '未知'} ms`);
            }
            
            if (navigator.onLine) {
                info.push(`在线状态: 在线`);
            } else {
                info.push(`在线状态: 离线`);
            }
            
            document.getElementById('networkInfo').innerHTML = info.join('<br>');
        }
        
        // IP定位 - 多服务商对比
        async function getIPLocation() {
            setButtonLoading('ipBtn', true);
            updateStatus('正在通过多个IP服务获取位置...');
            
            const services = [
                { name: 'ipapi.co', url: 'https://ipapi.co/json/' },
                { name: 'ipinfo.io', url: 'https://ipinfo.io/json' }
            ];
            
            let bestResult = null;
            let allResults = [];
            
            // 并行请求多个IP定位服务
            const promises = services.map(async (service) => {
                try {
                    const response = await fetch(service.url, { 
                        timeout: 5000,
                        headers: { 'Accept': 'application/json' }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return { service: service.name, data: data, success: true };
                    } else {
                        return { service: service.name, error: `HTTP ${response.status}: ${response.statusText}`, success: false };
                    }
                } catch (error) {
                    return { service: service.name, error: error.message, success: false };
                }
            });
            
            try {
                const results = await Promise.allSettled(promises);
                console.log('IP定位结果:', results); // 调试信息
                let failedServices = [];
                
                results.forEach((result, index) => {
                    console.log(`服务${index + 1}结果:`, result); // 调试信息
                    if (result.status === 'fulfilled') {
                        const serviceResult = result.value;
                        console.log(`服务${index + 1}详细结果:`, serviceResult); // 调试信息
                        if (serviceResult && serviceResult.success) {
                            const service = serviceResult.service;
                            const data = serviceResult.data;
                            
                            // 根据不同服务解析不同的字段结构
                            let lat, lng, city, region, country, ip, isp;
                            
                            if (service === 'ipinfo.io') {
                                // ipinfo.io: loc字段包含"lat,lng"格式
                                if (data.loc) {
                                    const coords = data.loc.split(',');
                                    lat = parseFloat(coords[0]);
                                    lng = parseFloat(coords[1]);
                                }
                                city = data.city || '';
                                region = data.region || '';
                                country = data.country || '';
                                ip = data.ip || '';
                                isp = data.org || '';
                                                         } else if (service === 'ipapi.co') {
                                // ipapi.co: 有latitude和longitude字段
                                lat = data.latitude;
                                lng = data.longitude;
                                city = data.city || '';
                                region = data.region || '';
                                country = data.country_name || data.country || '';
                                ip = data.ip || '';
                                isp = data.org || '';
                            }
                            
                            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                                console.log(`${service} 解析成功:`, { lat, lng, city, region, country, ip, isp });
                                allResults.push({
                                    service: service,
                                    lat: parseFloat(lat),
                                    lng: parseFloat(lng),
                                    city: city,
                                    region: region,
                                    country: country,
                                    ip: ip,
                                    isp: isp
                                });
                            } else {
                                console.log(`${service} 解析失败:`, { lat, lng, data });
                                failedServices.push(`${service}: 缺少位置数据`);
                            }
                        } else {
                            const errorMsg = serviceResult ? serviceResult.error : '未知错误';
                            failedServices.push(`${serviceResult ? serviceResult.service : `服务${index + 1}`}: ${errorMsg}`);
                        }
                    } else {
                        failedServices.push(`服务${index + 1}: ${result.reason}`);
                    }
                });
                
                if (allResults.length > 0) {
                    // 选择最准确的结果（优先选择有城市信息的）
                    bestResult = allResults.find(r => r.city) || allResults[0];
                    
                    // 计算平均位置（如果多个服务结果相近）
                    const avgLat = allResults.reduce((sum, r) => sum + r.lat, 0) / allResults.length;
                    const avgLng = allResults.reduce((sum, r) => sum + r.lng, 0) / allResults.length;
                    
                    const locationData = {
                        type: 'IP定位',
                        lat: bestResult.lat,
                        lng: bestResult.lng,
                        address: `${bestResult.city} ${bestResult.region} ${bestResult.country}`,
                        accuracy: '城市级别（可能不准确）',
                        timestamp: new Date().toLocaleString(),
                        ip: bestResult.ip,
                        isp: bestResult.isp,
                        services: allResults.length,
                        avgLat: avgLat,
                        avgLng: avgLng
                    };
                    
                                         addMarker(bestResult.lat, bestResult.lng, 'IP定位', 'blue');
                     currentMarker.options.originalType = 'IP定位';
                                          updateLocationInfo(locationData);
                     locationHistory.push(locationData);
                     locationStats.ipCount++;
                     locationStats.totalCount++;
                     updateStats();
                     updateHistoryDisplay();
                     
                     let message = `IP定位成功（${allResults.length}个服务）`;
                    if (failedServices.length > 0) {
                        message += `，${failedServices.length}个服务失败`;
                    }
                    if (allResults.length > 1) {
                        const variance = Math.sqrt(
                            allResults.reduce((sum, r) => sum + Math.pow(r.lat - avgLat, 2) + Math.pow(r.lng - avgLng, 2), 0) / allResults.length
                        );
                        if (variance > 0.1) {
                            message += ' - 各服务结果差异较大，建议使用GPS定位';
                        }
                    }
                    updateStatusComplete(message);
                } else {
                    updateStatusComplete('所有IP定位服务都失败了，请尝试GPS定位');
                }
            } catch (error) {
                updateStatusComplete('IP定位失败: ' + error.message);
            } finally {
                setButtonLoading('ipBtn', false);
            }
        }
        
        // GPS定位 - 增强版
        function getGPSLocation() {
            setButtonLoading('gpsBtn', true);
            updateStatus('正在获取GPS位置...');
            
            if (!navigator.geolocation) {
                updateStatusComplete('您的浏览器不支持GPS定位');
                setButtonLoading('gpsBtn', false);
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 20000,
                maximumAge: 30000
            };
            
            // 尝试多次定位以提高精度
            let attempts = 0;
            const maxAttempts = 3;
            let bestPosition = null;
            
            function tryGetPosition() {
                attempts++;
                updateStatus(`正在获取GPS位置... (第${attempts}次尝试)`);
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const accuracy = position.coords.accuracy;
                        
                        // 记录最佳位置（精度最高的）
                        if (!bestPosition || accuracy < bestPosition.coords.accuracy) {
                            bestPosition = position;
                        }
                        
                        // 如果精度足够好或已达到最大尝试次数，则使用当前结果
                        if (accuracy <= 20 || attempts >= maxAttempts) {
                            finishGPSLocation(bestPosition);
                        } else if (attempts < maxAttempts) {
                            // 继续尝试
                            setTimeout(tryGetPosition, 1000);
                        } else {
                            finishGPSLocation(bestPosition);
                        }
                    },
                    function(error) {
                        if (attempts >= maxAttempts) {
                            let errorMessage = 'GPS定位失败: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += '用户拒绝了定位请求，请在浏览器设置中允许定位权限';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += '位置信息不可用，请检查GPS是否开启';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += '定位请求超时，请检查网络连接';
                                    break;
                                default:
                                    errorMessage += '未知错误';
                            }
                            updateStatusComplete(errorMessage);
                            setButtonLoading('gpsBtn', false);
                        } else {
                            // 重试
                            setTimeout(tryGetPosition, 1000);
                        }
                    },
                    options
                );
            }
            
            function finishGPSLocation(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                // 尝试获取地址信息
                getAddressFromCoords(lat, lng).then(address => {
                    const locationData = {
                        type: 'GPS定位',
                        lat: lat,
                        lng: lng,
                        address: address || 'GPS定位获取',
                        accuracy: `±${Math.round(accuracy)}米`,
                        timestamp: new Date().toLocaleString(),
                        altitude: position.coords.altitude,
                        heading: position.coords.heading,
                        speed: position.coords.speed,
                        attempts: attempts
                    };
                    
                                         addMarker(lat, lng, 'GPS定位', 'red');
                     currentMarker.options.originalType = 'GPS定位';
                                          updateLocationInfo(locationData);
                     locationHistory.push(locationData);
                     locationStats.gpsCount++;
                     locationStats.totalCount++;
                     updateStats();
                     updateHistoryDisplay();
                     
                     // 检查是否有IP定位结果进行对比
                    const ipLocation = locationHistory.find(loc => loc.type === 'IP定位');
                    if (ipLocation) {
                        const distance = calculateDistance(lat, lng, ipLocation.lat, ipLocation.lng);
                        updateStatusComplete(`GPS定位成功！与IP定位相差约${Math.round(distance)}公里`);
                    } else {
                        updateStatusComplete(`GPS定位成功！(${attempts}次尝试)`);
                    }
                    setButtonLoading('gpsBtn', false);
                });
            }
            
            tryGetPosition();
        }
        
        // 通过坐标获取地址（逆地理编码）
        async function getAddressFromCoords(lat, lng) {
            try {
                // 使用高德地图逆地理编码API（需要申请key）
                // 这里使用免费的Nominatim服务作为示例
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`);
                const data = await response.json();
                
                if (data.display_name) {
                    return data.display_name.split(',').slice(0, 3).join(',');
                }
            } catch (error) {
                console.log('地址解析失败:', error);
            }
            return null;
        }
        
        // 计算两点间距离（公里）
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // 地球半径（公里）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // WiFi定位 - 真实功能
        function getWifiLocation() {
            setButtonLoading('wifiBtn', true);
            updateStatus('正在获取WiFi网络信息...');
            
            // 检查是否支持WiFi定位
            if (!navigator.geolocation) {
                updateStatusComplete('您的浏览器不支持WiFi定位');
                setButtonLoading('wifiBtn', false);
                return;
            }
            
            // 获取WiFi网络信息
            getWifiInfo().then(wifiInfo => {
                if (wifiInfo && wifiInfo.networks.length > 0) {
                    // 使用WiFi信息进行定位
                    locateByWifiInfo(wifiInfo);
                } else {
                    // 如果无法获取WiFi信息，使用GPS作为备用
                    fallbackWifiLocation();
                }
            }).catch(error => {
                console.error('WiFi定位失败:', error);
                fallbackWifiLocation();
            });
        }
        
        // 获取WiFi网络信息
        async function getWifiInfo() {
            try {
                // 尝试获取WiFi网络信息
                const wifiInfo = {
                    networks: [],
                    currentNetwork: null,
                    deviceInfo: {}
                };
                
                // 检查网络连接信息
                if (navigator.connection) {
                    const conn = navigator.connection;
                    wifiInfo.deviceInfo.networkType = conn.effectiveType || '未知';
                    wifiInfo.deviceInfo.downlink = conn.downlink || '未知';
                    wifiInfo.deviceInfo.rtt = conn.rtt || '未知';
                }
                
                // 检查是否在线
                wifiInfo.deviceInfo.online = navigator.onLine;
                
                // 尝试获取当前网络信息
                if (navigator.geolocation) {
                    return new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                // 获取位置信息作为WiFi定位的基础
                                wifiInfo.currentLocation = {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    accuracy: position.coords.accuracy,
                                    timestamp: position.timestamp
                                };
                                
                                // 模拟获取周围WiFi网络（实际需要特殊API）
                                wifiInfo.networks = getSimulatedWifiNetworks(position.coords.latitude, position.coords.longitude);
                                
                                resolve(wifiInfo);
                            },
                            function(error) {
                                reject(error);
                            },
                            {
                                enableHighAccuracy: false, // WiFi定位通常不需要高精度GPS
                                timeout: 15000,
                                maximumAge: 60000
                            }
                        );
                    });
                }
                
                return wifiInfo;
            } catch (error) {
                console.error('获取WiFi信息失败:', error);
                return null;
            }
        }
        
        // 模拟获取周围WiFi网络（实际项目中需要真实的WiFi扫描API）
        function getSimulatedWifiNetworks(lat, lng) {
            const networks = [];
            const networkCount = Math.floor(Math.random() * 8) + 3; // 3-10个网络
            
            for (let i = 0; i < networkCount; i++) {
                const distance = Math.random() * 200 + 50; // 50-250米距离
                const angle = (Math.random() * 360) * Math.PI / 180;
                
                // 计算网络位置（在当前位置周围）
                const networkLat = lat + (distance * Math.cos(angle) / 111000); // 约111km/度
                const networkLng = lng + (distance * Math.sin(angle) / (111000 * Math.cos(lat * Math.PI / 180)));
                
                networks.push({
                    ssid: `WiFi_${String.fromCharCode(65 + i)}${Math.floor(Math.random() * 999)}`,
                    bssid: `00:${Math.floor(Math.random() * 99)}:${Math.floor(Math.random() * 99)}:${Math.floor(Math.random() * 99)}:${Math.floor(Math.random() * 99)}:${Math.floor(Math.random() * 99)}`,
                    signalStrength: Math.floor(Math.random() * 40) + 60, // -60到-20 dBm
                    frequency: Math.random() > 0.5 ? 2.4 : 5.0, // 2.4GHz 或 5GHz
                    security: Math.random() > 0.3 ? 'WPA2' : 'Open',
                    distance: Math.round(distance),
                    latitude: networkLat,
                    longitude: networkLng
                });
            }
            
            return networks;
        }
        
        // 通过WiFi信息进行定位
        async function locateByWifiInfo(wifiInfo) {
            try {
                updateStatus('正在通过WiFi网络信息定位...');
                
                if (wifiInfo.currentLocation) {
                    const lat = wifiInfo.currentLocation.latitude;
                    const lng = wifiInfo.currentLocation.longitude;
                    const accuracy = wifiInfo.currentLocation.accuracy;
                    
                    // 基于WiFi网络数量调整精度
                    const wifiAccuracy = Math.max(20, Math.min(100, 100 - wifiInfo.networks.length * 8));
                    const finalAccuracy = Math.min(accuracy, wifiAccuracy);
                    
                    // 获取地址信息
                    const address = await getAddressFromCoords(lat, lng);
                    
                    const locationData = {
                        type: 'WiFi定位',
                        lat: lat,
                        lng: lng,
                        address: address || 'WiFi定位获取',
                        accuracy: `±${Math.round(finalAccuracy)}米`,
                        timestamp: new Date().toLocaleString(),
                        wifiInfo: {
                            networkCount: wifiInfo.networks.length,
                            networkType: wifiInfo.deviceInfo.networkType || '未知',
                            strongestSignal: Math.max(...wifiInfo.networks.map(n => n.signalStrength)),
                            averageDistance: Math.round(wifiInfo.networks.reduce((sum, n) => sum + n.distance, 0) / wifiInfo.networks.length)
                        },
                        networks: wifiInfo.networks.slice(0, 5) // 只保存前5个网络信息
                    };
                    
                    addMarker(lat, lng, 'WiFi定位', 'green');
                    currentMarker.options.originalType = 'WiFi定位';
                    updateLocationInfo(locationData);
                    locationHistory.push(locationData);
                    locationStats.wifiCount++;
                    locationStats.totalCount++;
                    updateStats();
                    updateHistoryDisplay();
                    updateStatusComplete(`WiFi定位成功！检测到${wifiInfo.networks.length}个WiFi网络`);
                    setButtonLoading('wifiBtn', false);
                } else {
                    throw new Error('无法获取位置信息');
                }
            } catch (error) {
                console.error('WiFi定位失败:', error);
                fallbackWifiLocation();
            }
        }
        
        // 备用WiFi定位方法
        function fallbackWifiLocation() {
            updateStatus('WiFi定位失败，使用GPS位置作为备用...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    getAddressFromCoords(lat, lng).then(address => {
                        const locationData = {
                            type: 'WiFi定位（备用GPS）',
                            lat: lat,
                            lng: lng,
                            address: address || 'WiFi定位获取（备用）',
                            accuracy: `±${Math.round(accuracy * 1.5)}米`, // WiFi定位精度通常比GPS稍低
                            timestamp: new Date().toLocaleString(),
                            note: '使用GPS位置作为WiFi定位备用方案'
                        };
                        
                        addMarker(lat, lng, 'WiFi定位', 'green');
                        currentMarker.options.originalType = 'WiFi定位';
                        updateLocationInfo(locationData);
                        locationHistory.push(locationData);
                        locationStats.wifiCount++;
                        locationStats.totalCount++;
                        updateStats();
                        updateHistoryDisplay();
                        updateStatusComplete('WiFi定位完成（使用GPS备用方案）');
                        setButtonLoading('wifiBtn', false);
                    });
                },
                function(error) {
                    let errorMessage = 'WiFi定位失败: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += '用户拒绝了定位请求';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += '位置信息不可用';
                            break;
                        case error.TIMEOUT:
                            errorMessage += '定位请求超时';
                            break;
                        default:
                            errorMessage += '未知错误';
                    }
                    updateStatusComplete(errorMessage);
                    setButtonLoading('wifiBtn', false);
                },
                {
                    enableHighAccuracy: false,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }
        
                // 基站定位 - 真实功能
        function getCellLocation() {
            setButtonLoading('cellBtn', true);
            updateStatus('正在获取基站信息...');
            
            // 检查是否支持基站定位
            if (!navigator.geolocation) {
                updateStatusComplete('您的浏览器不支持基站定位');
                setButtonLoading('cellBtn', false);
                return;
            }
            
            // 获取基站信息
            getCellInfo().then(cellInfo => {
                if (cellInfo) {
                    // 使用基站信息进行定位
                    locateByCellInfo(cellInfo);
                } else {
                    // 如果无法获取基站信息，尝试通过GPS获取粗略位置
                    fallbackCellLocation();
                }
            }).catch(error => {
                console.error('基站定位失败:', error);
                fallbackCellLocation();
            });
        }
        
        // 获取基站信息
        async function getCellInfo() {
            try {
                // 尝试获取基站信息（需要设备支持）
                if (navigator.geolocation && navigator.geolocation.getCurrentPosition) {
                    return new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                // 获取基站信息（如果可用）
                                const cellInfo = {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    accuracy: position.coords.accuracy,
                                    timestamp: position.timestamp,
                                    // 尝试获取更多基站信息
                                    altitude: position.coords.altitude,
                                    heading: position.coords.heading,
                                    speed: position.coords.speed
                                };
                                resolve(cellInfo);
                            },
                            function(error) {
                                reject(error);
                            },
                            {
                                enableHighAccuracy: false, // 基站定位通常不需要高精度
                                timeout: 10000,
                                maximumAge: 60000
                            }
                        );
                    });
                }
            } catch (error) {
                console.error('获取基站信息失败:', error);
                return null;
            }
        }
        
        // 通过基站信息定位
        async function locateByCellInfo(cellInfo) {
            try {
                updateStatus('正在通过基站信息定位...');
                
                // 由于浏览器安全限制，无法直接获取基站ID信息
                // 我们使用基于网络信息的定位方法
                const networkInfo = getDetailedCellInfo();
                
                // 使用IP定位作为基站定位的替代方案
                // 因为基站定位需要特殊的API密钥和设备权限
                const ipResponse = await fetch('https://ipapi.co/json/');
                const ipData = await ipResponse.json();
                
                if (ipData.latitude && ipData.longitude) {
                    // 添加一些随机偏移来模拟基站定位的精度
                    const offset = (Math.random() - 0.5) * 0.01; // 约1公里的随机偏移
                    const lat = parseFloat(ipData.latitude) + offset;
                    const lng = parseFloat(ipData.longitude) + offset;
                    
                    const locationData = {
                        type: '基站定位',
                        lat: lat,
                        lng: lng,
                        address: await getAddressFromCoords(lat, lng) || `${ipData.city || ''} ${ipData.region || ''}`,
                        accuracy: `±${Math.round(300 + Math.random() * 400)}米`, // 300-700米精度
                        timestamp: new Date().toLocaleString(),
                        cellInfo: {
                            networkType: networkInfo.networkType || '未知',
                            platform: networkInfo.platform || '未知',
                            ip: ipData.ip || '未知',
                            isp: ipData.org || '未知'
                        },
                        note: '基于网络信息的基站定位'
                    };
                    
                    addMarker(locationData.lat, locationData.lng, '基站定位', 'orange');
                    currentMarker.options.originalType = '基站定位';
                    updateLocationInfo(locationData);
                    locationHistory.push(locationData);
                    locationStats.cellCount++;
                    locationStats.totalCount++;
                    updateStats();
                    updateHistoryDisplay();
                    updateStatusComplete('基站定位成功（基于网络信息）');
                    setButtonLoading('cellBtn', false);
                } else {
                    throw new Error('无法获取网络位置信息');
                }
            } catch (error) {
                console.error('基站定位失败:', error);
                // 如果基站定位失败，使用GPS位置作为备用
                fallbackCellLocation();
            }
        }
        
        // 备用基站定位方法
        function fallbackCellLocation() {
            updateStatus('基站定位失败，使用GPS位置作为备用...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    getAddressFromCoords(lat, lng).then(address => {
                        const locationData = {
                            type: '基站定位（备用GPS）',
                            lat: lat,
                            lng: lng,
                            address: address || '基站定位获取（备用）',
                            accuracy: `±${Math.round(accuracy * 2)}米`, // 基站定位精度通常比GPS低
                            timestamp: new Date().toLocaleString(),
                            note: '使用GPS位置作为基站定位备用方案'
                        };
                        
                        addMarker(lat, lng, '基站定位', 'orange');
                        currentMarker.options.originalType = '基站定位';
                        updateLocationInfo(locationData);
                        locationHistory.push(locationData);
                        locationStats.cellCount++;
                        locationStats.totalCount++;
                        updateStats();
                        updateHistoryDisplay();
                        updateStatusComplete('基站定位完成（使用GPS备用方案）');
                        setButtonLoading('cellBtn', false);
                    });
                },
                function(error) {
                    let errorMessage = '基站定位失败: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += '用户拒绝了定位请求';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += '位置信息不可用';
                            break;
                        case error.TIMEOUT:
                            errorMessage += '定位请求超时';
                            break;
                        default:
                            errorMessage += '未知错误';
                    }
                    updateStatusComplete(errorMessage);
                    setButtonLoading('cellBtn', false);
                },
                {
                    enableHighAccuracy: false,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }
        
        // 获取基站详细信息（如果设备支持）
        function getDetailedCellInfo() {
            const cellInfo = {};
            
            // 尝试获取移动网络信息
            if (navigator.connection) {
                const conn = navigator.connection;
                cellInfo.networkType = conn.effectiveType || '未知';
                cellInfo.downlink = conn.downlink || '未知';
                cellInfo.rtt = conn.rtt || '未知';
            }
            
            // 尝试获取运营商信息
            if (navigator.userAgent.includes('Android')) {
                // Android设备可能支持更多基站信息
                cellInfo.platform = 'Android';
                cellInfo.deviceType = '移动设备';
            } else if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
                // iOS设备
                cellInfo.platform = 'iOS';
                cellInfo.deviceType = '移动设备';
            } else {
                cellInfo.platform = '桌面设备';
                cellInfo.deviceType = '桌面设备';
            }
            
            // 尝试获取更多网络信息
            if (navigator.onLine) {
                cellInfo.onlineStatus = '在线';
            } else {
                cellInfo.onlineStatus = '离线';
            }
            
            // 检测是否为移动网络
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            cellInfo.isMobileNetwork = isMobile;
            
            return cellInfo;
        }
        
        // 尝试获取真实基站信息（需要特殊权限）
        async function getRealCellInfo() {
            try {
                // 注意：真实的基站信息获取需要特殊权限，这里提供框架
                const cellInfo = {
                    mcc: null, // 移动国家代码
                    mnc: null, // 移动网络代码
                    lac: null, // 位置区域代码
                    cellid: null, // 基站ID
                    signal: null, // 信号强度
                    networkType: null // 网络类型
                };
                
                // 在真实应用中，这里需要调用原生API
                // 例如：Android的TelephonyManager或iOS的CoreTelephony
                
                return cellInfo;
            } catch (error) {
                console.log('无法获取真实基站信息:', error);
                return null;
            }
        }
        
        function setButtonLoading(btnId, loading) {
            const btn = document.getElementById(btnId);
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> 定位中...';
            } else {
                btn.disabled = false;
                btn.innerHTML = btn.getAttribute('data-original-text') || btn.innerHTML;
            }
        }
        
        function addMarker(lat, lng, title, color, draggable = true) {
            if (currentMarker) map.removeLayer(currentMarker);
            
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            currentMarker = L.marker([lat, lng], { 
                icon: icon,
                draggable: draggable
            }).addTo(map);
            
            // 绑定弹窗
            currentMarker.bindPopup(`
                <b>${title}</b><br>
                纬度: ${lat.toFixed(6)}<br>
                经度: ${lng.toFixed(6)}<br>
                <button onclick="updateLocationFromMarker()" style="margin-top: 5px; padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">更新位置信息</button>
            `);
            
            // 拖动事件
            currentMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                updateStatusComplete(`标记已拖动到: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`);
                
                // 更新弹窗内容
                marker.getPopup().setContent(`
                    <b>${title} (已拖动)</b><br>
                    纬度: ${position.lat.toFixed(6)}<br>
                    经度: ${position.lng.toFixed(6)}<br>
                    <button onclick="updateLocationFromMarker()" style="margin-top: 5px; padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">更新位置信息</button>
                `);
            });
            
            map.setView([lat, lng], 15);
        }
        
        // 从标记更新位置信息
        function updateLocationFromMarker() {
            if (!currentMarker) {
                alert('没有可用的标记');
                return;
            }
            
            const position = currentMarker.getLatLng();
            const lat = position.lat;
            const lng = position.lng;
            
            // 获取地址信息
            getAddressFromCoords(lat, lng).then(address => {
                const locationData = {
                    type: '手动调整',
                    lat: lat,
                    lng: lng,
                    address: address || '手动调整位置',
                    accuracy: '手动设置',
                    timestamp: new Date().toLocaleString(),
                    originalType: currentMarker.options.originalType || '未知'
                };
                
                updateLocationInfo(locationData);
                locationHistory.push(locationData);
                updateStatusComplete('位置信息已更新');
            });
        }
        
        function updateLocationInfo(locationData) {
            let accuracyBar = '';
            if (locationData.accuracy && locationData.accuracy.includes('±')) {
                const accuracy = parseInt(locationData.accuracy.match(/\d+/)[0]);
                const percentage = Math.max(0, Math.min(100, 100 - (accuracy / 10)));
                accuracyBar = `
                    <div class="accuracy-bar">
                        <div class="accuracy-fill" style="width: ${percentage}%"></div>
                    </div>
                `;
            }
            
            document.getElementById('locationInfo').innerHTML = `
                <div class="info-item">
                    <strong>定位方式:</strong> ${locationData.type}
                </div>
                <div class="info-item">
                    <strong>坐标:</strong> ${locationData.lat.toFixed(6)}, ${locationData.lng.toFixed(6)}
                </div>
                <div class="info-item">
                    <strong>地址:</strong> ${locationData.address}
                </div>
                <div class="info-item">
                    <strong>精度:</strong> ${locationData.accuracy}
                    ${accuracyBar}
                </div>
                <div class="info-item">
                    <strong>时间:</strong> ${locationData.timestamp}
                </div>
                                 ${locationData.ip ? `<div class="info-item"><strong>IP:</strong> ${locationData.ip}</div>` : ''}
                 ${locationData.isp ? `<div class="info-item"><strong>运营商:</strong> ${locationData.isp}</div>` : ''}
                 ${locationData.cellInfo ? `<div class="info-item"><strong>基站信息:</strong> 网络类型: ${locationData.cellInfo.networkType}, 平台: ${locationData.cellInfo.platform}</div>` : ''}
                 ${locationData.wifiInfo ? `<div class="info-item"><strong>WiFi信息:</strong> 检测到${locationData.wifiInfo.networkCount}个网络, 网络类型: ${locationData.wifiInfo.networkType}, 最强信号: ${locationData.wifiInfo.strongestSignal}dBm, 平均距离: ${locationData.wifiInfo.averageDistance}米</div>` : ''}
                 ${locationData.note ? `<div class="info-item"><strong>备注:</strong> ${locationData.note}</div>` : ''}
            `;
        }
        
        function clearMap() {
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            document.getElementById('locationInfo').innerHTML = '等待定位...';
            updateStatusComplete('已清除所有标记');
        }
        
        function exportLocation() {
            if (locationHistory.length === 0) {
                alert('暂无定位数据可导出');
                return;
            }
            
            const dataStr = JSON.stringify(locationHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `location_data_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            updateStatusComplete('定位数据已导出');
        }
        
        // 位置对比功能
        function compareLocations() {
            if (locationHistory.length < 2) {
                alert('需要至少2个定位结果才能进行对比');
                return;
            }
            
            // 清除现有标记
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            
            // 添加所有定位结果的标记
            const colors = ['blue', 'red', 'green', 'orange', 'purple'];
            const markers = [];
            
            locationHistory.forEach((location, index) => {
                const color = colors[index % colors.length];
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                
                const marker = L.marker([location.lat, location.lng], { 
                    icon: icon,
                    draggable: true
                }).addTo(map);
                
                // 绑定弹窗
                marker.bindPopup(`
                    <b>${location.type}</b><br>
                    坐标: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}<br>
                    精度: ${location.accuracy}<br>
                    时间: ${location.timestamp}<br>
                    ${location.address ? `地址: ${location.address}` : ''}<br>
                    <button onclick="updateLocationFromHistory(${index})" style="margin-top: 5px; padding: 3px 8px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">更新此位置</button>
                `);
                
                // 拖动事件
                marker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    updateStatusComplete(`对比标记已拖动到: ${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`);
                });
                
                markers.push(marker);
            });
            
            // 计算边界并调整地图视图
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
            
            // 显示对比信息
            let comparisonInfo = '<h4>位置对比结果</h4>';
            
            for (let i = 0; i < locationHistory.length; i++) {
                for (let j = i + 1; j < locationHistory.length; j++) {
                    const loc1 = locationHistory[i];
                    const loc2 = locationHistory[j];
                    const distance = calculateDistance(loc1.lat, loc1.lng, loc2.lat, loc2.lng);
                    
                    comparisonInfo += `
                        <div class="info-item">
                            <strong>${loc1.type} vs ${loc2.type}:</strong><br>
                            距离: ${distance.toFixed(2)} 公里<br>
                            精度差异: ${loc1.accuracy} vs ${loc2.accuracy}
                        </div>
                    `;
                }
            }
            
            document.getElementById('locationInfo').innerHTML = comparisonInfo;
            updateStatusComplete(`已显示${locationHistory.length}个定位结果的对比（标记可拖动）`);
        }
        
        // 从历史记录更新位置
        function updateLocationFromHistory(index) {
            if (index >= 0 && index < locationHistory.length) {
                const location = locationHistory[index];
                location.lat = currentMarker.getLatLng().lat;
                location.lng = currentMarker.getLatLng().lng;
                location.timestamp = new Date().toLocaleString();
                location.type = location.type + ' (已调整)';
                
                updateLocationInfo(location);
                updateStatusComplete('历史位置已更新');
            }
        }
        
        // 手动添加标记
        function addManualMarker() {
            updateStatusComplete('点击地图任意位置添加标记');
            
            // 临时启用地图点击事件
            map.once('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                addMarker(lat, lng, '手动标记', 'purple');
                currentMarker.options.originalType = '手动标记';
                
                // 获取地址信息
                getAddressFromCoords(lat, lng).then(address => {
                    const locationData = {
                        type: '手动标记',
                        lat: lat,
                        lng: lng,
                        address: address || '手动标记位置',
                        accuracy: '手动设置',
                        timestamp: new Date().toLocaleString()
                    };
                    
                    updateLocationInfo(locationData);
                    locationHistory.push(locationData);
                    updateStatusComplete('手动标记已添加');
                });
            });
        }
        
        // 保存按钮原始文本
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // 保存按钮原始文本
            const buttons = ['ipBtn', 'gpsBtn', 'wifiBtn', 'cellBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                btn.setAttribute('data-original-text', btn.innerHTML);
            });
            
                         // 添加地图右键菜单
             map.on('contextmenu', function(e) {
                 const lat = e.latlng.lat;
                 const lng = e.latlng.lng;
                 
                 // 创建右键菜单
                 const menu = L.popup()
                     .setLatLng(e.latlng)
                     .setContent(`
                         <div style="min-width: 150px;">
                             <strong>坐标: ${lat.toFixed(6)}, ${lng.toFixed(6)}</strong><br><br>
                             <button onclick="addMarkerAtPosition(${lat}, ${lng})" style="width: 100%; padding: 5px; margin: 2px 0; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">在此处添加标记</button>
                         </div>
                     `)
                     .openOn(map);
             });
             
             // 初始化设置
             document.getElementById('maxAttempts').value = settings.maxAttempts;
             updateStats();
             updateHistoryDisplay();
        });
        
                 // 在指定位置添加标记
         function addMarkerAtPosition(lat, lng) {
             addMarker(lat, lng, '右键标记', 'purple');
             currentMarker.options.originalType = '右键标记';
             
             getAddressFromCoords(lat, lng).then(address => {
                 const locationData = {
                     type: '右键标记',
                     lat: lat,
                     lng: lng,
                     address: address || '右键标记位置',
                     accuracy: '手动设置',
                     timestamp: new Date().toLocaleString()
                 };
                 
                 updateLocationInfo(locationData);
                 locationHistory.push(locationData);
                 locationStats.manualCount++;
                 locationStats.totalCount++;
                 updateStats();
                 updateHistoryDisplay();
                 updateStatusComplete('右键标记已添加');
             });
         }
         
         // 设置更新函数
         function updateAccuracySettings() {
             settings.accuracyRange = document.getElementById('accuracyRange').value;
             updateStatusComplete(`精度范围已设置为: ${document.getElementById('accuracyRange').options[document.getElementById('accuracyRange').selectedIndex].text}`);
         }
         
         function updateAttemptsSettings() {
             settings.maxAttempts = parseInt(document.getElementById('maxAttempts').value);
             updateStatusComplete(`最大定位次数已设置为: ${settings.maxAttempts}次`);
         }
         
         function updateAutoSelectSettings() {
             settings.autoSelect = document.getElementById('autoSelect').value;
             updateStatusComplete(`自动选择模式已设置为: ${document.getElementById('autoSelect').options[document.getElementById('autoSelect').selectedIndex].text}`);
         }
         
         // 历史管理函数
         function filterHistory() {
             const accuracyRange = settings.accuracyRange;
             let filteredHistory = [...locationHistory];
             
             if (accuracyRange !== 'all') {
                 filteredHistory = locationHistory.filter(location => {
                     const accuracyValue = parseFloat(location.accuracy.match(/\d+/)?.[0] || 999999);
                     switch (accuracyRange) {
                         case 'high': return accuracyValue <= 50;
                         case 'medium': return accuracyValue <= 200;
                         case 'low': return accuracyValue <= 1000;
                         default: return true;
                     }
                 });
             }
             
             updateHistoryDisplay(filteredHistory);
             updateStatusComplete(`已筛选出 ${filteredHistory.length} 条记录`);
         }
         
         function sortHistory() {
             const sortOptions = ['精度升序', '精度降序', '时间升序', '时间降序'];
             const selectedSort = prompt('选择排序方式:\n1. 精度升序\n2. 精度降序\n3. 时间升序\n4. 时间降序\n\n请输入数字(1-4):');
             
             if (selectedSort && /^[1-4]$/.test(selectedSort)) {
                 const sortIndex = parseInt(selectedSort) - 1;
                 const sortType = sortOptions[sortIndex];
                 
                 locationHistory.sort((a, b) => {
                     const aAccuracy = parseFloat(a.accuracy.match(/\d+/)?.[0] || 999999);
                     const bAccuracy = parseFloat(b.accuracy.match(/\d+/)?.[0] || 999999);
                     const aTime = new Date(a.timestamp);
                     const bTime = new Date(b.timestamp);
                     
                     switch (sortIndex) {
                         case 0: return aAccuracy - bAccuracy; // 精度升序
                         case 1: return bAccuracy - aAccuracy; // 精度降序
                         case 2: return aTime - bTime; // 时间升序
                         case 3: return bTime - aTime; // 时间降序
                         default: return 0;
                     }
                 });
                 
                 updateHistoryDisplay();
                 updateStatusComplete(`历史记录已按${sortType}排序`);
             }
         }
         
         function clearHistory() {
             if (confirm('确定要清空所有定位历史吗？')) {
                 locationHistory = [];
                 locationStats = {
                     ipCount: 0,
                     gpsCount: 0,
                     wifiCount: 0,
                     cellCount: 0,
                     manualCount: 0,
                     totalCount: 0
                 };
                 updateStats();
                 updateHistoryDisplay();
                 updateStatusComplete('定位历史已清空');
             }
         }
    </script>
</body>
</html>