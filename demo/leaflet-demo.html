<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet地图演示</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
                 body {
             margin: 0;
             padding: 0;
             font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
             height: 100vh;
             overflow: hidden;
             line-height: 1.6;
         }
        
         .container {
             max-width: 100%;
             margin: 0;
             overflow: hidden;
         }
        
         .header {
             display: none;
         }
        
         .controls {
             padding: 15px;
             color: #1a202c;
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             z-index: 1000;
             border-bottom: 1px solid #e2e8f0;
         }
        
        .control-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #1a202c;
        }
        
        .control-group input, .control-group select, .control-group button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .control-group button {
            border: 1px solid #007bff;
            color: #007bff;
            background: transparent;
            cursor: pointer;
        }
        
        .control-group button:hover {
            border-color: #0056b3;
            color: #0056b3;
        }
        
        .control-group button.danger {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .control-group button.danger:hover {
            border-color: #c82333;
            color: #c82333;
        }
        
                 #map {
             height: 100vh;
             width: 100%;
             position: absolute;
             top: 0;
             left: 0;
         }
        
                 .info-panel {
             position: absolute;
             top: 80px;
             right: 10px;
             padding: 15px;
             border-radius: 4px;
             box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
             border: 1px solid #dee2e6;
             z-index: 1000;
             max-width: 300px;
             font-size: 14px;
         }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .info-panel p {
            margin: 5px 0;
            color: #666;
        }
        
        .status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #333;
            padding: 8px 12px;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
                 @media (max-width: 768px) {
             .controls {
                 text-align: center;
                 padding: 10px;
             }
             
             .control-group {
                 display: block;
                 margin-bottom: 10px;
             }
             
             #map {
                 height: 100vh;
             }
             
             .info-panel {
                 top: 120px;
                 max-width: 250px;
                 font-size: 12px;
             }
         }
    </style>
</head>
<body>
    <!-- 返回文档链接 -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 2000; padding: 8px 12px; border-radius: 4px; border: 1px solid #dee2e6;">
        <a href="https://www.siqiongbiluo.love/article/25" style="text-decoration: none; color: #007bff; font-size: 14px;">← 返回文档</a>
    </div>
         <div class="container">
         <div class="controls">
            <div class="control-group">
                <label>图层源:</label>
                                 <select id="tileSource" onchange="changeTileSource()">
                     <option value="osm">OpenStreetMap (国外)</option>
                     <option value="gaode">高德地图 (国内)</option>
                     <option value="cartodb">CartoDB (国外)</option>
                     <option value="satellite">卫星影像 (国外)</option>
                     <option value="terrain">地形图 (国外)</option>
                 </select>
            </div>
            
            <div class="control-group">
                <label>搜索地址:</label>
                <input type="text" id="searchInput" placeholder="输入地址..." style="width: 200px;">
                <button onclick="searchLocation()">搜索</button>
            </div>
            
            <div class="control-group">
                <label>标记类型:</label>
                <select id="markerType">
                    <option value="default">默认标记</option>
                    <option value="custom">自定义标记</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>绘制工具:</label>
                <button id="circleBtn" onclick="startCircleDrawing()">绘制圆形</button>
                <button id="polygonBtn" onclick="startPolygonDrawing()">绘制多边形</button>
                <button id="polylineBtn" onclick="startPolylineDrawing()">绘制路径</button>
                <button onclick="cancelDrawing()">取消绘制</button>
            </div>
            
            <div class="control-group">
                <button onclick="clearAll()" class="danger">清除所有</button>
            </div>
        </div>
        
        <div id="map"></div>
    </div>
    
                                       <div class="info-panel">
           <h3>功能说明</h3>
           <p><strong>图层源:</strong> 选择国内或国外地图服务</p>
           <p><strong>点击地图:</strong> 在点击位置添加标记</p>
           <p><strong>图层控制:</strong> 右上角控件切换标记显示</p>
           <p><strong>标记交互:</strong> 鼠标悬停显示弹窗</p>
           <p><strong>搜索功能:</strong> 输入地址进行地理编码</p>
           <p><strong>绘制工具:</strong> 点击按钮开始绘制，鼠标交互完成绘制</p>
           <p><strong>圆形绘制:</strong> 点击选择圆心，再次点击确定半径</p>
           <p><strong>多边形绘制:</strong> 点击添加顶点，双击完成绘制</p>
           <p><strong>路径绘制:</strong> 点击添加路径点，双击完成绘制</p>
       </div>
    
    <div class="status" id="status">准备就绪</div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
         <script>
         // 初始化地图
         const map = L.map('map', {
             zoomControl: false  // 禁用默认的缩放控件
         }).setView([39.9042, 116.4074], 13);
         
                                       // 定义不同的图层源
           const tileSources = {
               osm: {
                   url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                   attribution: '© OpenStreetMap contributors',
                   name: 'OpenStreetMap'
               },
                               gaode: {
                    url: 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
                    attribution: '© 高德地图',
                    name: '高德地图',
                    subdomains: '1234'
                },
               cartodb: {
                   url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                   attribution: '© CartoDB',
                   name: 'CartoDB'
               },
               satellite: {
                   url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                   attribution: '© Esri',
                   name: '卫星影像'
               },
               terrain: {
                   url: 'https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.png',
                   attribution: '© Stamen Design',
                   name: '地形图'
               }
           };
         
         // 当前图层
         let currentTileLayer;
         
         // 创建图层组
         const markers = L.layerGroup();
         const shapes = L.layerGroup();
         
         // 绘制状态变量
         let drawingMode = null;
         let drawingShape = null;
         let drawingPoints = [];
         let circleCenter = null;
         
         // 添加图层到地图
         markers.addTo(map);
         shapes.addTo(map);
         
         // 初始化默认图层
         function initDefaultTileLayer() {
             const options = {
                 attribution: tileSources.osm.attribution
             };
             
             // 如果图源有子域名配置，添加子域名
             if (tileSources.osm.subdomains) {
                 options.subdomains = tileSources.osm.subdomains;
             }
             
             currentTileLayer = L.tileLayer(tileSources.osm.url, options).addTo(map);
         }
         
         // 切换图层源
         function changeTileSource() {
             const source = document.getElementById('tileSource').value;
             const tileSource = tileSources[source];
             
             // 移除当前图层
             if (currentTileLayer) {
                 map.removeLayer(currentTileLayer);
             }
             
             // 添加新图层
             const options = {
                 attribution: tileSource.attribution
             };
             
             // 如果图源有子域名配置，添加子域名
             if (tileSource.subdomains) {
                 options.subdomains = tileSource.subdomains;
             }
             
             currentTileLayer = L.tileLayer(tileSource.url, options).addTo(map);
             
             updateStatus(`已切换到${tileSource.name}`);
         }
         
         // 初始化默认图层
         initDefaultTileLayer();
        
                 // 添加一些示例标记
         const cities = [
             { name: "北京天安门", lat: 39.9042, lng: 116.4074 },
             { name: "上海外滩", lat: 31.2304, lng: 121.4737 },
             { name: "广州塔", lat: 23.1291, lng: 113.2644 },
             { name: "深圳平安金融中心", lat: 22.5431, lng: 114.0579 }
         ];
         
         // 添加图层控制
         const overlayMaps = {
             "标记点": markers,
             "几何图形": shapes
         };
         
         L.control.layers(null, overlayMaps).addTo(map);
        
        cities.forEach(city => {
            const marker = L.marker([city.lat, city.lng])
                .bindPopup(`<b>${city.name}</b><br>坐标: ${city.lat}, ${city.lng}`)
                .addTo(markers);
            
            // 添加鼠标悬停事件
            marker.on('mouseover', function() {
                this.openPopup();
            });
        });
        
        // 地图点击事件
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // 如果正在绘制模式，处理绘制逻辑
            if (drawingMode) {
                handleMapClick(e);
                return;
            }
            
            updateStatus(`点击位置: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            
            // 根据选择的标记类型创建标记
            const markerType = document.getElementById('markerType').value;
            let marker;
            
            if (markerType === 'custom') {
                // 创建自定义图标
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });
                
                marker = L.marker([lat, lng], { icon: customIcon });
            } else {
                marker = L.marker([lat, lng]);
            }
            
            marker.bindPopup(`<b>新标记</b><br>坐标: ${lat.toFixed(4)}, ${lng.toFixed(4)}`)
                .addTo(markers);
        });
        
        // 地图双击事件
        map.on('dblclick', function(e) {
            if (drawingMode) {
                handleMapDoubleClick(e);
                return;
            }
        });
        
        // 地图移动事件
        map.on('moveend', function() {
            const center = map.getCenter();
            updateStatus(`地图中心: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
        });
        
        // 地图鼠标移动事件 - 用于圆形绘制的实时预览
        map.on('mousemove', function(e) {
            if (drawingMode === 'circle' && circleCenter && drawingShape) {
                const radius = circleCenter.distanceTo(e.latlng);
                drawingShape.setRadius(radius);
                updateStatus(`圆形半径: ${Math.round(radius)} 米`);
            }
        });
        
        // 搜索功能
        async function searchLocation() {
            const address = document.getElementById('searchInput').value;
            if (!address) {
                alert('请输入地址');
                return;
            }
            
            updateStatus('正在搜索...');
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`
                );
                const data = await response.json();
                
                if (data.length > 0) {
                    const location = data[0];
                    const lat = parseFloat(location.lat);
                    const lng = parseFloat(location.lon);
                    
                    // 移动到搜索位置
                    map.setView([lat, lng], 15);
                    
                    // 添加标记
                    const marker = L.marker([lat, lng])
                        .bindPopup(`<b>${address}</b><br>坐标: ${lat}, ${lng}`)
                        .addTo(markers);
                    
                    updateStatus(`找到位置: ${address}`);
                } else {
                    alert('未找到该地址');
                    updateStatus('搜索失败');
                }
            } catch (error) {
                console.error('搜索错误:', error);
                alert('搜索失败，请稍后重试');
                updateStatus('搜索失败');
            }
        }
        
        // 添加圆形
        function addCircle() {
            const center = map.getCenter();
            const circle = L.circle([center.lat, center.lng], {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5,
                radius: 5000
            }).addTo(shapes);
            
            circle.bindPopup('这是一个圆形区域');
            updateStatus('已添加圆形');
        }
        
        // 添加多边形
        function addPolygon() {
            const center = map.getCenter();
            const polygon = L.polygon([
                [center.lat + 0.01, center.lng - 0.01],
                [center.lat + 0.01, center.lng + 0.01],
                [center.lat - 0.01, center.lng + 0.01],
                [center.lat - 0.01, center.lng - 0.01]
            ], {
                color: 'blue',
                fillColor: '#03f',
                fillOpacity: 0.3
            }).addTo(shapes);
            
            polygon.bindPopup('这是一个多边形区域');
            updateStatus('已添加多边形');
        }
        
        // 添加路径
        function addPolyline() {
            const center = map.getCenter();
            const polyline = L.polyline([
                [center.lat - 0.01, center.lng - 0.01],
                [center.lat, center.lng],
                [center.lat + 0.01, center.lng + 0.01]
            ], {
                color: 'green',
                weight: 4
            }).addTo(shapes);
            
            polyline.bindPopup('这是一条路径');
            updateStatus('已添加路径');
        }

        // 开始绘制圆形
        function startCircleDrawing() {
            cancelDrawing();
            drawingMode = 'circle';
            updateStatus('点击地图选择圆心，再次点击确定半径');
            updateButtonStates();
        }
        
        // 开始绘制多边形
        function startPolygonDrawing() {
            cancelDrawing();
            drawingMode = 'polygon';
            drawingPoints = [];
            updateStatus('点击地图添加多边形顶点，双击完成绘制');
            updateButtonStates();
        }
        
        // 开始绘制路径
        function startPolylineDrawing() {
            cancelDrawing();
            drawingMode = 'polyline';
            drawingPoints = [];
            updateStatus('点击地图添加路径点，双击完成绘制');
            updateButtonStates();
        }
        
        // 取消绘制
        function cancelDrawing() {
            drawingMode = null;
            drawingShape = null;
            drawingPoints = [];
            circleCenter = null;
            
            // 移除临时绘制图形
            if (drawingShape) {
                map.removeLayer(drawingShape);
                drawingShape = null;
            }
            
            updateStatus('已取消绘制');
            updateButtonStates();
        }
        
        // 更新按钮状态
        function updateButtonStates() {
            const circleBtn = document.getElementById('circleBtn');
            const polygonBtn = document.getElementById('polygonBtn');
            const polylineBtn = document.getElementById('polylineBtn');
            
            if (drawingMode === 'circle') {
                circleBtn.style.borderColor = '#28a745';
                circleBtn.style.color = '#28a745';
                polygonBtn.style.borderColor = '#007bff';
                polygonBtn.style.color = '#007bff';
                polylineBtn.style.borderColor = '#007bff';
                polylineBtn.style.color = '#007bff';
            } else if (drawingMode === 'polygon') {
                circleBtn.style.borderColor = '#007bff';
                circleBtn.style.color = '#007bff';
                polygonBtn.style.borderColor = '#28a745';
                polygonBtn.style.color = '#28a745';
                polylineBtn.style.borderColor = '#007bff';
                polylineBtn.style.color = '#007bff';
            } else if (drawingMode === 'polyline') {
                circleBtn.style.borderColor = '#007bff';
                circleBtn.style.color = '#007bff';
                polygonBtn.style.borderColor = '#007bff';
                polygonBtn.style.color = '#007bff';
                polylineBtn.style.borderColor = '#28a745';
                polylineBtn.style.color = '#28a745';
            } else {
                circleBtn.style.borderColor = '#007bff';
                circleBtn.style.color = '#007bff';
                polygonBtn.style.borderColor = '#007bff';
                polygonBtn.style.color = '#007bff';
                polylineBtn.style.borderColor = '#007bff';
                polylineBtn.style.color = '#007bff';
            }
        }
        
        // 处理地图点击事件
        function handleMapClick(e) {
            if (!drawingMode) return;
            
            const latlng = e.latlng;
            
            if (drawingMode === 'circle') {
                if (!circleCenter) {
                    // 第一次点击，设置圆心
                    circleCenter = latlng;
                    drawingShape = L.circle(latlng, {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.5,
                        radius: 0
                    }).addTo(map);
                    updateStatus('再次点击确定半径');
                                 } else {
                     // 第二次点击，确定半径
                     const radius = circleCenter.distanceTo(latlng);
                     drawingShape.setRadius(radius);
                     drawingShape.addTo(shapes);
                     drawingShape.bindPopup('这是一个圆形区域');
                     
                     updateStatus('圆形绘制完成');
                     cancelDrawing();
                 }
            } else if (drawingMode === 'polygon') {
                drawingPoints.push(latlng);
                
                if (drawingShape) {
                    map.removeLayer(drawingShape);
                }
                
                drawingShape = L.polygon(drawingPoints, {
                    color: 'blue',
                    fillColor: '#03f',
                    fillOpacity: 0.3
                }).addTo(map);
                
                updateStatus(`多边形顶点: ${drawingPoints.length} 个，双击完成绘制`);
            } else if (drawingMode === 'polyline') {
                drawingPoints.push(latlng);
                
                if (drawingShape) {
                    map.removeLayer(drawingShape);
                }
                
                drawingShape = L.polyline(drawingPoints, {
                    color: 'green',
                    weight: 4
                }).addTo(map);
                
                updateStatus(`路径点: ${drawingPoints.length} 个，双击完成绘制`);
            }
        }
        
        // 处理地图双击事件
        function handleMapDoubleClick(e) {
            if (!drawingMode || drawingMode === 'circle') return;
            
            if (drawingMode === 'polygon' && drawingPoints.length >= 3) {
                drawingShape.addTo(shapes);
                drawingShape.bindPopup('这是一个多边形区域');
                map.removeLayer(drawingShape);
                updateStatus('多边形绘制完成');
                cancelDrawing();
            } else if (drawingMode === 'polyline' && drawingPoints.length >= 2) {
                drawingShape.addTo(shapes);
                drawingShape.bindPopup('这是一条路径');
                map.removeLayer(drawingShape);
                updateStatus('路径绘制完成');
                cancelDrawing();
            }
        }
        
        // 清除所有
        function clearAll() {
            markers.clearLayers();
            shapes.clearLayers();
            
            // 重新添加示例标记
            cities.forEach(city => {
                const marker = L.marker([city.lat, city.lng])
                    .bindPopup(`<b>${city.name}</b><br>坐标: ${city.lat}, ${city.lng}`)
                    .addTo(markers);
                
                marker.on('mouseover', function() {
                    this.openPopup();
                });
            });
            
            updateStatus('已清除所有标记和图形');
        }
        
        // 更新状态
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // 回车键搜索
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });
        
        // 初始化状态
        updateStatus('地图已加载完成');
    </script>
</body>
</html>