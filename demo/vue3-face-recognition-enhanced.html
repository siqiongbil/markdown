<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue3 增强版人脸识别 - 包含人脸库对比</title>
    
    <!-- Vue3 + Element Plus -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    
    <!-- face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <!-- 人脸数据库管理器 -->
    <script src="face-db-manager.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, sans-serif;
            color: #333;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
        }
        
        .header p {
            margin: 8px 0 0 0;
            color: #666;
        }
        
        .content {
            padding: 20px;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .video-section {
            text-align: center;
        }
        
        .video-container {
            position: relative;
            display: inline-block;
            border: 1px solid #ddd;
            margin: 15px 0;
        }
        
        #video {
            display: block;
            width: 640px;
            height: 480px;
            max-width: 100%;
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .controls {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .face-library-panel {
            border: 1px solid #ddd;
            padding: 15px;
        }
        
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #999;
        }
        
        .face-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .face-card {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            position: relative;
        }
        
        .face-card.matched {
            border-color: #28a745;
        }
        
        .face-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
        }
        
        .face-name {
            font-size: 11px;
            color: #333;
            margin-bottom: 4px;
        }
        
        .confidence-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            border: 1px solid #28a745;
            color: #28a745;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
        }
        
        .delete-btn {
            position: absolute;
            top: -5px;
            left: -5px;
            border: 1px solid #dc3545;
            color: #dc3545;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        .recognition-results {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
        }
        
        .match-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 8px;
        }
        
        .match-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .match-info {
            flex: 1;
        }
        
        .match-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 3px;
        }
        
        .match-confidence {
            font-size: 12px;
            color: #666;
        }
        
        .settings-panel {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .setting-label {
            min-width: 100px;
            color: #666;
        }
        
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .stat-card {
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            display: block;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }
        
        .comparison-mode {
            padding: 12px;
            margin: 12px 0;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .tech-specs {
            border: 1px solid #ddd;
            padding: 12px;
            margin-top: 12px;
        }
        
        .spec-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }
        
        .spec-item:last-child {
            border-bottom: none;
        }
        
        .spec-label {
            color: #666;
        }
        
        .spec-value {
            color: #333;
        }
        
        @media (max-width: 1000px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            #video {
                width: 100%;
                height: auto;
            }
            
            .face-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- 返回文档链接 -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 2000; background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
        <a href="https://www.siqiongbiluo.love/article/17" style="text-decoration: none; color: #4fc08d; font-size: 14px; font-weight: 500;">← 返回文档</a>
    </div>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>Vue3 增强版人脸识别系统</h1>
                <p>支持人脸库管理和实时识别对比功能</p>
            </div>
            
            <div class="content">
                <div class="main-layout">
                    <!-- 左侧：视频检测区域 -->
                    <div class="video-section">
                        <div class="video-container">
                            <video
                                id="video"
                                ref="videoRef"
                                autoplay
                                muted
                                playsinline
                            ></video>
                            <canvas
                                id="overlay"
                                ref="canvasRef"
                                width="640"
                                height="480"
                            ></canvas>
                        </div>
                        
                        <!-- 控制按钮 -->
                        <div class="controls">
                            <el-button 
                                type="primary" 
                                @click="startCamera" 
                                :disabled="isRunning"
                                :loading="isLoading"
                                size="large"
                            >
                                {{ isLoading ? '加载中...' : '启动摄像头' }}
                            </el-button>
                            
                            <el-button 
                                type="danger" 
                                @click="stopCamera" 
                                :disabled="!isRunning"
                                size="large"
                            >
                                停止摄像头
                            </el-button>
                            
                            <el-button 
                                type="success" 
                                @click="captureAndAdd" 
                                :disabled="!isRunning || faceData.length === 0"
                                size="large"
                            >
                                添加到人脸库
                            </el-button>
                            
                            <el-button 
                                type="info" 
                                @click="toggleComparison" 
                                :disabled="!isRunning"
                                size="large"
                            >
                                {{ comparisonMode ? '关闭识别' : '开启识别' }}
                            </el-button>
                        </div>
                        
                        <!-- 对比模式提示 -->
                        <div v-if="comparisonMode" class="comparison-mode">
                            <h4 style="margin: 0 0 10px 0;">人脸识别模式已开启</h4>
                            <p style="margin: 0;">正在与人脸库中的 {{ faceLibrary.length }} 个人脸进行实时对比</p>
                        </div>
                        
                        <!-- 统计信息 -->
                        <div class="stats-section">
                            <div class="stat-card">
                                <span class="stat-value">{{ faceData.length }}</span>
                                <div class="stat-label">检测人脸</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value">{{ matchedFaces.length }}</span>
                                <div class="stat-label">识别匹配</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value">{{ fps }}</span>
                                <div class="stat-label">FPS</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value">{{ faceLibrary.length }}</span>
                                <div class="stat-label">人脸库</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value">{{ detectionCount }}</span>
                                <div class="stat-label">检测次数</div>
                            </div>
                            <div class="stat-card">
                                <span class="stat-value">{{ averageConfidence }}%</span>
                                <div class="stat-label">平均置信度</div>
                            </div>
                        </div>
                        
                        <!-- 识别结果 -->
                        <div v-if="matchedFaces.length > 0" class="recognition-results">
                            <h3 style="margin: 0 0 15px 0; color: #333;">识别结果</h3>
                            <div 
                                v-for="(match, index) in matchedFaces" 
                                :key="index"
                                class="match-item"
                            >
                                <img :src="match.faceImage" class="match-avatar" alt="匹配人脸">
                                <div class="match-info">
                                    <div class="match-name">{{ match.name }}</div>
                                    <div class="match-confidence">
                                        相似度: {{ (match.confidence * 100).toFixed(1) }}%
                                        <span v-if="match.distance < 0.4" style="color: #67c23a; margin-left: 10px;">高度匹配</span>
                                        <span v-else-if="match.distance < 0.6" style="color: #e6a23c; margin-left: 10px;">可能匹配</span>
                                        <span v-else style="color: #f56c6c; margin-left: 10px;">低匹配度</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 设置面板 -->
                        <div class="settings-panel">
                            <h3 style="margin: 0 0 15px 0; color: #333;">检测设置</h3>
                            
                            <div class="setting-item">
                                <span class="setting-label">检测阈值:</span>
                                <el-slider
                                    v-model="detectionScore"
                                    :min="0.1"
                                    :max="1"
                                    :step="0.1"
                                    show-input
                                    style="flex: 1;"
                                />
                            </div>
                            
                            <div class="setting-item">
                                <span class="setting-label">识别阈值:</span>
                                <el-slider
                                    v-model="recognitionThreshold"
                                    :min="0.3"
                                    :max="0.8"
                                    :step="0.05"
                                    show-input
                                    style="flex: 1;"
                                />
                            </div>
                            
                            <div class="setting-item">
                                <span class="setting-label">检测间隔:</span>
                                <el-slider
                                    v-model="detectionInterval"
                                    :min="100"
                                    :max="1000"
                                    :step="100"
                                    show-input
                                    style="flex: 1;"
                                />
                            </div>
                            
                            <div class="setting-item">
                                <span class="setting-label">输入尺寸:</span>
                                <el-select v-model="inputSize" size="small" style="width: 120px;">
                                    <el-option label="128" :value="128" />
                                    <el-option label="160" :value="160" />
                                    <el-option label="224" :value="224" />
                                    <el-option label="320" :value="320" />
                                    <el-option label="416" :value="416" />
                                    <el-option label="512" :value="512" />
                                </el-select>
                            </div>
                            
                            <div class="setting-item">
                                <span class="setting-label">目标FPS:</span>
                                <el-select v-model="targetFPS" size="small" style="width: 120px;">
                                    <el-option label="15 FPS" :value="15" />
                                    <el-option label="30 FPS" :value="30" />
                                    <el-option label="60 FPS" :value="60" />
                                </el-select>
                            </div>
                            
                            <div class="setting-item">
                                <span class="setting-label">显示关键点:</span>
                                <el-switch
                                    v-model="showLandmarks"
                                    active-text="开启"
                                    inactive-text="关闭"
                                />
                            </div>
                            
                            <div class="setting-item">
                                <span class="setting-label">显示表情:</span>
                                <el-switch
                                    v-model="showExpressions"
                                    active-text="开启"
                                    inactive-text="关闭"
                                />
                            </div>
                        </div>
                        
                        <!-- 系统信息面板 -->
                        <div class="settings-panel">
                            <h3 style="margin: 0 0 15px 0; color: #333;">系统信息</h3>
                            
                            <div class="tech-specs">
                                <div class="spec-item">
                                    <span class="spec-label">框架版本:</span>
                                    <span class="spec-value">Vue 3.x</span>
                                </div>
                                
                                <div class="spec-item">
                                    <span class="spec-label">检测引擎:</span>
                                    <span class="spec-value">TinyFaceDetector</span>
                                </div>
                                
                                <div class="spec-item">
                                    <span class="spec-label">输入尺寸:</span>
                                    <span class="spec-value">{{ inputSize }}x{{ inputSize }}</span>
                                </div>
                                
                                <div class="spec-item">
                                    <span class="spec-label">当前阈值:</span>
                                    <span class="spec-value">{{ detectionScore }}</span>
                                </div>
                                
                                <div class="spec-item">
                                    <span class="spec-label">检测间隔:</span>
                                    <span class="spec-value">{{ detectionInterval }}ms</span>
                                </div>
                                
                                <div class="spec-item">
                                    <span class="spec-label">浏览器支持:</span>
                                    <span class="spec-value">
                                        <el-tag :type="browserSupport ? 'success' : 'danger'" size="small">
                                            {{ browserSupport ? '支持' : '不支持' }}
                                        </el-tag>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- 功能特性 -->
                            <h4 style="margin: 20px 0 15px 0; color: #666;">功能特性</h4>
                            <div>
                                <el-tag v-for="feature in features" :key="feature" style="margin: 3px;">
                                    {{ feature }}
                                </el-tag>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧：人脸库管理 -->
                    <div class="face-library-panel">
                        <h3 style="margin: 0 0 20px 0; color: #333;">人脸库管理</h3>
                        
                        <!-- 上传区域 -->
                        <div 
                            class="upload-area"
                            @click="$refs.fileInput.click()"
                            @dragover.prevent="handleDragOver"
                            @dragleave.prevent="handleDragLeave"
                            @drop.prevent="handleDrop"
                            :class="{ dragover: isDragging }"
                        >
                            <div style="font-size: 48px; color: #909399; margin-bottom: 10px;">
                                文件夹
                            </div>
                            <div style="color: #606266; margin-bottom: 10px;">
                                点击或拖拽上传人脸照片
                            </div>
                            <div style="color: #909399; font-size: 12px;">
                                支持 JPG、PNG 格式
                            </div>
                        </div>
                        
                        <input 
                            ref="fileInput" 
                            type="file" 
                            accept="image/*" 
                            multiple
                            style="display: none"
                            @change="handleFileSelect"
                        >
                        
                        <!-- 批量操作 -->
                                                    <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                                <el-button 
                                    size="small" 
                                    type="primary"
                                    @click="importLibrary"
                                >
                                    导入数据
                                </el-button>
                                <el-button 
                                    size="small" 
                                    type="info"
                                    @click="exportLibrary"
                                    :disabled="faceLibrary.length === 0"
                                >
                                    导出JSON
                                </el-button>
                                <el-button 
                                    size="small" 
                                    type="success"
                                    @click="exportImages"
                                    :disabled="faceLibrary.length === 0"
                                >
                                    导出图片
                                </el-button>
                                <el-button 
                                    size="small" 
                                    type="warning"
                                    @click="clearLibrary"
                                    :disabled="faceLibrary.length === 0"
                                >
                                    清空人脸库
                                </el-button>
                            </div>
                            
                            <!-- 高级操作 -->
                            <div style="margin: 15px 0; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <el-button 
                                        size="small" 
                                        type="success"
                                        @click="showStorageUsage"
                                    >
                                        存储使用情况
                                    </el-button>
                                    <el-button 
                                        size="small" 
                                        type="danger"
                                        @click="clearAllCache"
                                    >
                                        清除所有缓存
                                    </el-button>
                                </div>
                                <div style="margin-top: 8px; font-size: 11px; color: #999; line-height: 1.4;">
                                    "清除所有缓存"将彻底删除所有本地数据，包括人脸库、设置和缓存，操作不可撤销
                                </div>
                            </div>
                        
                        <!-- 人脸库展示 -->
                        <div v-if="faceLibrary.length === 0" style="text-align: center; color: #909399; padding: 40px 0;">
                            暂无人脸数据<br>
                            <small>请上传照片或从摄像头添加</small>
                        </div>
                        
                        <div v-else class="face-grid">
                            <div 
                                v-for="(face, index) in faceLibrary" 
                                :key="face.id"
                                class="face-card"
                                :class="{ matched: isMatched(face.id) }"
                            >
                                <button 
                                    class="delete-btn"
                                    @click="removeFace(index)"
                                    title="删除"
                                >
                                    ×
                                </button>
                                
                                <img :src="face.image" class="face-image" :alt="face.name">
                                <div class="face-name">{{ face.name }}</div>
                                <div style="font-size: 11px; color: #909399;">
                                    {{ new Date(face.timestamp).toLocaleDateString() }}
                                </div>
                                
                                <div 
                                    v-if="isMatched(face.id)" 
                                    class="confidence-badge"
                                    :title="`匹配度: ${getMatchConfidence(face.id)}%`"
                                >
                                    {{ getMatchConfidence(face.id) }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 添加人脸对话框 -->
        <el-dialog 
            v-model="showAddDialog" 
            title="添加到人脸库"
            width="500px"
            center
        >
            <div style="text-align: center;">
                <canvas 
                    ref="captureCanvas" 
                    width="300" 
                    height="300" 
                    style="border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 20px; max-width: 250px; max-height: 250px;"
                ></canvas>
                
                <el-form label-width="80px">
                    <el-form-item label="姓名:">
                        <el-input 
                            v-model="newFaceName" 
                            placeholder="请输入姓名"
                            maxlength="20"
                            show-word-limit
                        />
                    </el-form-item>
                    <el-form-item label="备注:">
                        <el-input 
                            v-model="newFaceNote" 
                            placeholder="可选备注信息"
                            maxlength="50"
                            show-word-limit
                        />
                    </el-form-item>
                </el-form>
            </div>
            
            <template #footer>
                <el-button @click="showAddDialog = false">取消</el-button>
                <el-button type="primary" @click="confirmAddFace" :disabled="!newFaceName.trim()">
                    添加到人脸库
                </el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue
        const { ElMessage, ElMessageBox } = ElementPlus
        
        createApp({
            setup() {
                // 基础状态
                const videoRef = ref(null)
                const canvasRef = ref(null)
                const captureCanvas = ref(null)
                const fileInput = ref(null)
                
                const isRunning = ref(false)
                const isDetecting = ref(true)
                const isLoading = ref(false)
                const modelsLoaded = ref(false)
                const comparisonMode = ref(false)
                
                // 检测数据
                const faceData = ref([])
                const matchedFaces = ref([])
                const stream = ref(null)
                const detectionTimer = ref(null)
                
                // 人脸库
                const faceLibrary = ref([])
                const faceMatcher = ref(null)
                const faceDB = ref(null)
                
                // 设置
                const recognitionThreshold = ref(0.6)
                const detectionInterval = ref(200)
                const showLandmarks = ref(true)
                const showExpressions = ref(true)
                
                // 检测参数
                const detectionScore = ref(0.5)
                const inputSize = ref(416)
                const targetFPS = ref(30)
                
                // 统计信息
                const detectionCount = ref(0)
                
                // 浏览器支持检测
                const browserSupport = ref(false)
                
                // UI 状态
                const showAddDialog = ref(false)
                const newFaceName = ref('')
                const newFaceNote = ref('')
                const currentCapturedFace = ref(null)
                const isDragging = ref(false)
                
                // 性能统计
                const fps = ref(0)
                const fpsCounter = ref(0)
                const lastFpsUpdate = ref(Date.now())
                
                // 生命周期
                onMounted(async () => {
                    // 检查浏览器支持
                    checkBrowserSupport()
                    
                    // 初始化数据库
                    faceDB.value = window.faceDB || new FaceDBManager()
                    await faceDB.value.init()
                    
                    // 加载模型和人脸库
                    await loadModels()
                    await loadFaceLibrary()
                })
                
                onUnmounted(() => {
                    cleanup()
                })
                
                // 监听设置变化
                watch(detectionInterval, () => {
                    if (isDetecting.value) {
                        stopDetection()
                        startDetection()
                    }
                })
                
                watch(recognitionThreshold, () => {
                    updateFaceMatcher()
                })
                
                watch(faceLibrary, () => {
                    updateFaceMatcher()
                }, { deep: true })
                
                // 计算属性
                const isMatched = computed(() => {
                    return (faceId) => matchedFaces.value.some(match => match.faceId === faceId)
                })
                
                const getMatchConfidence = computed(() => {
                    return (faceId) => {
                        const match = matchedFaces.value.find(m => m.faceId === faceId)
                        return match ? Math.round(match.confidence * 100) : 0
                    }
                })
                
                const averageConfidence = computed(() => {
                    if (faceData.value.length === 0) return 0
                    const total = faceData.value.reduce((sum, face) => 
                        sum + face.detection.score, 0
                    )
                    return ((total / faceData.value.length) * 100).toFixed(1)
                })
                
                const features = ref([
                    '实时人脸检测',
                    '68个关键点',
                    '7种表情识别', 
                    '年龄性别预测',
                    '多人脸检测',
                    '人脸库管理',
                    '实时识别对比',
                    '数据持久化'
                ])
                
                // 浏览器支持检测
                const checkBrowserSupport = () => {
                    browserSupport.value = !!(
                        navigator.mediaDevices && 
                        navigator.mediaDevices.getUserMedia &&
                        document.createElement('canvas').getContext('webgl')
                    )
                }
                
                // 表情标签映射
                const getExpressionLabel = (expression) => {
                    const labels = {
                        neutral: '中性',
                        happy: '开心',
                        sad: '悲伤',
                        angry: '愤怒',
                        fearful: '恐惧',
                        disgusted: '厌恶',
                        surprised: '惊讶'
                    }
                    return labels[expression] || expression
                }
                
                // 模型加载
                const loadModels = async () => {
                    isLoading.value = true
                    
                    try {
                        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model'
                        
                        await Promise.all([
                            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                            faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
                            faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
                        ])
                        
                        modelsLoaded.value = true
                        ElMessage.success('人脸识别模型加载完成')
                    } catch (error) {
                        console.error('模型加载失败:', error)
                        ElMessage.error('模型加载失败，请检查网络连接')
                    } finally {
                        isLoading.value = false
                    }
                }
                
                // 摄像头控制
                const startCamera = async () => {
                    if (!modelsLoaded.value) {
                        ElMessage.warning('模型尚未加载完成')
                        return
                    }
                    
                    try {
                        stream.value = await navigator.mediaDevices.getUserMedia({
                            video: { width: 640, height: 480, facingMode: 'user' },
                            audio: false
                        })
                        
                        videoRef.value.srcObject = stream.value
                        
                        videoRef.value.addEventListener('loadedmetadata', () => {
                            isRunning.value = true
                            isDetecting.value = true  // 确保检测状态为开启
                            startDetection()
                        })
                        
                        ElMessage.success('摄像头启动成功')
                    } catch (error) {
                        ElMessage.error('摄像头访问失败: ' + error.message)
                    }
                }
                
                const stopCamera = () => {
                    cleanup()
                    isRunning.value = false
                    isDetecting.value = false
                    comparisonMode.value = false
                    faceData.value = []
                    matchedFaces.value = []
                    fps.value = 0
                    ElMessage.info('摄像头已停止')
                }
                
                // 检测控制
                const startDetection = () => {
                    if (!isDetecting.value) return
                    
                    detectionTimer.value = setInterval(async () => {
                        await detectFaces()
                        updateFPS()
                    }, detectionInterval.value)
                }
                
                const stopDetection = () => {
                    if (detectionTimer.value) {
                        clearInterval(detectionTimer.value)
                        detectionTimer.value = null
                    }
                }
                
                // 人脸检测
                const detectFaces = async () => {
                    const video = videoRef.value
                    const canvas = canvasRef.value
                    
                    if (!video || !canvas || !modelsLoaded.value) return
                    
                    try {
                        const options = new faceapi.TinyFaceDetectorOptions({
                            inputSize: inputSize.value,
                            scoreThreshold: detectionScore.value
                        })
                        
                        // 基础检测（始终可用）
                        let detections = await faceapi
                            .detectAllFaces(video, options)
                            .withFaceLandmarks()
                            .withFaceExpressions()
                            .withAgeAndGender()
                        
                        // 如果需要人脸识别功能，添加描述符
                        if (comparisonMode.value && detections.length > 0) {
                            try {
                                detections = await faceapi
                                    .detectAllFaces(video, options)
                                    .withFaceLandmarks()
                                    .withFaceDescriptors()
                                    .withFaceExpressions()
                                    .withAgeAndGender()
                            } catch (descriptorError) {
                                console.warn('描述符提取失败，使用基础检测:', descriptorError)
                                // 继续使用基础检测结果
                            }
                        }
                        
                        // 清除画布
                        const ctx = canvas.getContext('2d')
                        ctx.clearRect(0, 0, canvas.width, canvas.height)
                        
                        // 更新检测数据
                        faceData.value = detections.map(detection => ({
                            detection: detection.detection,
                            landmarks: detection.landmarks,
                            descriptor: detection.descriptor || null,
                            expressions: detection.expressions,
                            age: detection.age,
                            gender: detection.gender
                        }))
                        
                        // 人脸识别对比
                        if (comparisonMode.value && faceMatcher.value && detections.some(d => d.descriptor)) {
                            performFaceRecognition(detections)
                        } else {
                            matchedFaces.value = []
                        }
                        
                        // 绘制结果
                        drawDetections(detections, canvas)
                        
                        // 更新统计信息
                        detectionCount.value++
                        
                    } catch (error) {
                        console.error('检测失败:', error)
                    }
                }
                
                // 人脸识别对比
                const performFaceRecognition = (detections) => {
                    const matches = []
                    
                    detections.forEach((detection, index) => {
                        if (detection.descriptor && faceMatcher.value) {
                            try {
                                const bestMatch = faceMatcher.value.findBestMatch(detection.descriptor)
                                
                                if (bestMatch.distance < recognitionThreshold.value) {
                                    const faceInLibrary = faceLibrary.value.find(f => f.name === bestMatch.label)
                                    if (faceInLibrary) {
                                        matches.push({
                                            faceId: faceInLibrary.id,
                                            name: bestMatch.label,
                                            distance: bestMatch.distance,
                                            confidence: 1 - bestMatch.distance,
                                            faceImage: faceInLibrary.image,
                                            detectionIndex: index
                                        })
                                    }
                                }
                            } catch (error) {
                                console.warn('人脸匹配失败:', error)
                            }
                        }
                    })
                    
                    matchedFaces.value = matches
                }
                
                // 绘制检测结果
                const drawDetections = (detections, canvas) => {
                    const ctx = canvas.getContext('2d')
                    
                    detections.forEach((detection, index) => {
                        const { x, y, width, height } = detection.detection.box
                        
                        // 检查是否有匹配
                        const match = matchedFaces.value.find(m => m.detectionIndex === index)
                        const isMatched = !!match
                        
                        // 绘制人脸框
                        ctx.strokeStyle = isMatched ? '#67c23a' : '#00ff00'
                        ctx.lineWidth = isMatched ? 4 : 3
                        ctx.strokeRect(x, y, width, height)
                        
                        // 绘制标签
                        const score = (detection.detection.score * 100).toFixed(1)
                        let label = `人脸 ${index + 1} (${score}%)`
                        
                        if (isMatched) {
                            label = `${match.name} (${(match.confidence * 100).toFixed(1)}%)`
                        }
                        
                        ctx.font = 'bold 16px Arial'
                        const textWidth = ctx.measureText(label).width
                        
                        ctx.fillStyle = isMatched ? 'rgba(103, 194, 58, 0.9)' : 'rgba(0, 255, 0, 0.8)'
                        ctx.fillRect(x, y - 30, textWidth + 10, 25)
                        
                        ctx.fillStyle = 'white'
                        ctx.fillText(label, x + 5, y - 10)
                        
                        // 绘制年龄性别信息
                        if (detection.age && detection.gender) {
                            const ageText = `年龄: ${Math.round(detection.age)}岁`
                            const genderText = `性别: ${detection.gender === 'male' ? '男' : '女'}`
                            const genderConfidence = Math.round(detection.genderProbability * 100)
                            
                            ctx.font = '12px Arial'
                            const ageWidth = ctx.measureText(ageText).width
                            const genderWidth = ctx.measureText(genderText).width
                            const maxWidth = Math.max(ageWidth, genderWidth)
                            
                            // 年龄信息
                            ctx.fillStyle = 'rgba(255, 165, 0, 0.8)'
                            ctx.fillRect(x, y + height + 5, ageWidth + 8, 18)
                            ctx.fillStyle = 'white'
                            ctx.fillText(ageText, x + 4, y + height + 18)
                            
                            // 性别信息
                            ctx.fillStyle = 'rgba(255, 20, 147, 0.8)'
                            ctx.fillRect(x, y + height + 25, genderWidth + 8, 18)
                            ctx.fillStyle = 'white'
                            ctx.fillText(genderText, x + 4, y + height + 38)
                            
                            // 性别置信度
                            if (genderConfidence < 80) {
                                const confidenceText = `置信度: ${genderConfidence}%`
                                ctx.font = '10px Arial'
                                const confWidth = ctx.measureText(confidenceText).width
                                ctx.fillStyle = 'rgba(255, 0, 0, 0.7)'
                                ctx.fillRect(x, y + height + 45, confWidth + 6, 14)
                                ctx.fillStyle = 'white'
                                ctx.fillText(confidenceText, x + 3, y + height + 55)
                            }
                        }
                        
                        // 绘制关键点
                        if (showLandmarks.value && detection.landmarks) {
                            ctx.fillStyle = isMatched ? '#67c23a' : '#ff0000'
                            detection.landmarks.positions.forEach(point => {
                                ctx.beginPath()
                                ctx.arc(point.x, point.y, 2, 0, 2 * Math.PI)
                                ctx.fill()
                            })
                        }
                        
                        // 绘制表情信息
                        if (showExpressions.value && detection.expressions) {
                            const expressions = Object.entries(detection.expressions)
                                .sort(([,a], [,b]) => b - a)
                                .slice(0, 2) // 显示前2个表情
                            
                            expressions.forEach(([expression, confidence], i) => {
                                if (confidence > 0.3) { // 只显示置信度较高的表情
                                    const expressionText = `${getExpressionLabel(expression)}: ${Math.round(confidence * 100)}%`
                                    
                                    ctx.font = '12px Arial'
                                    const textWidth = ctx.measureText(expressionText).width
                                    const yPos = y + height + (detection.age && detection.gender ? 65 : 20) + i * 20
                                    
                                    ctx.fillStyle = 'rgba(0, 0, 255, 0.8)'
                                    ctx.fillRect(x, yPos - 15, textWidth + 8, 18)
                                    
                                    ctx.fillStyle = 'white'
                                    ctx.fillText(expressionText, x + 4, yPos)
                                }
                            })
                        }
                    })
                }
                
                // 人脸库管理
                const updateFaceMatcher = () => {
                    if (faceLibrary.value.length === 0) {
                        faceMatcher.value = null
                        console.log('📚 人脸库为空，清除人脸匹配器')
                        return
                    }
                    
                    try {
                        // 严格验证人脸描述符
                        const facesWithValidDescriptors = faceLibrary.value.filter(face => {
                            if (!face.descriptor) {
                                console.log(`⚠️ 人脸 "${face.name}" 缺少描述符，跳过`)
                                return false
                            }
                            
                            // 检查描述符类型和维度
                            const isValidType = Array.isArray(face.descriptor) || face.descriptor instanceof Float32Array
                            if (!isValidType) {
                                console.warn(`❌ 人脸 "${face.name}" 描述符类型无效:`, typeof face.descriptor)
                                return false
                            }
                            
                            if (face.descriptor.length !== 128) {
                                console.warn(`❌ 人脸 "${face.name}" 描述符维度错误: ${face.descriptor.length}，期望128维`)
                                return false
                            }
                            
                            // 检查数值有效性
                            const hasValidNumbers = Array.from(face.descriptor).every(val => 
                                typeof val === 'number' && !isNaN(val) && isFinite(val)
                            )
                            
                            if (!hasValidNumbers) {
                                console.warn(`❌ 人脸 "${face.name}" 描述符包含无效数值`)
                                return false
                            }
                            
                            console.log(`✅ 人脸 "${face.name}" 描述符验证通过`)
                            return true
                        })
                        
                        if (facesWithValidDescriptors.length === 0) {
                            faceMatcher.value = null
                            console.log('⚠️ 没有有效的人脸描述符，无法创建人脸匹配器')
                            return
                        }
                        
                        const labeledDescriptors = facesWithValidDescriptors.map(face => {
                            // 确保描述符是Float32Array格式
                            const descriptor = face.descriptor instanceof Float32Array 
                                ? face.descriptor 
                                : new Float32Array(face.descriptor)
                            
                            return new faceapi.LabeledFaceDescriptors(
                                face.name,
                                [descriptor]
                            )
                        })
                        
                        faceMatcher.value = new faceapi.FaceMatcher(labeledDescriptors, recognitionThreshold.value)
                        console.log(`✅ 人脸匹配器已更新，包含 ${labeledDescriptors.length} 个可识别的人脸`)
                        console.log(`📊 人脸库统计：总计 ${faceLibrary.value.length} 个，可识别 ${facesWithValidDescriptors.length} 个`)
                    } catch (error) {
                        console.error('❌ 更新人脸匹配器失败:', error)
                        console.error('错误详情:', error.message)
                        faceMatcher.value = null
                    }
                }
                
                const captureAndAdd = async () => {
                    console.log('🎯 开始捕获人脸，当前检测到的人脸数量:', faceData.value.length)
                    
                    if (faceData.value.length === 0) {
                        ElMessage.warning('未检测到人脸')
                        return
                    }
                    
                    // 选择置信度最高的人脸
                    const bestFace = faceData.value.reduce((best, current) => 
                        current.detection.score > best.detection.score ? current : best
                    )
                    
                    console.log('选择的最佳人脸:', {
                        score: bestFace.detection.score,
                        hasDescriptor: !!bestFace.descriptor,
                        box: bestFace.detection.box
                    })
                    
                    // 检查视频元素
                    const video = videoRef.value
                    
                    console.log('视频元素状态:', {
                        video: !!video,
                        videoReady: video && video.readyState >= 2
                    })
                    
                    if (!video) {
                        ElMessage.error('视频元素未找到')
                        return
                    }
                    
                    if (video.readyState < 2) {
                        ElMessage.warning('视频尚未准备就绪，请稍后再试')
                        return
                    }
                    
                    // 先创建临时canvas来捕获人脸图像
                    const tempCanvas = document.createElement('canvas')
                    tempCanvas.width = 300  // 增大尺寸
                    tempCanvas.height = 300
                    const ctx = tempCanvas.getContext('2d')
                    
                    const { x, y, width, height } = bestFace.detection.box
                    
                    // 添加padding，扩展捕获区域
                    const padding = Math.max(width, height) * 0.3  // 30%的padding
                    const expandedX = Math.max(0, x - padding)
                    const expandedY = Math.max(0, y - padding)
                    const expandedWidth = Math.min(video.videoWidth - expandedX, width + padding * 2)
                    const expandedHeight = Math.min(video.videoHeight - expandedY, height + padding * 2)
                    
                    console.log('🖼️ 图像捕获参数:', {
                        original: { x, y, width, height },
                        expanded: { x: expandedX, y: expandedY, width: expandedWidth, height: expandedHeight },
                        padding: padding,
                        videoSize: { width: video.videoWidth, height: video.videoHeight }
                    })
                    
                    const scale = Math.min(300 / expandedWidth, 300 / expandedHeight)
                    const scaledWidth = expandedWidth * scale
                    const scaledHeight = expandedHeight * scale
                    
                    ctx.clearRect(0, 0, 300, 300)
                    ctx.drawImage(
                        video,
                        expandedX, expandedY, expandedWidth, expandedHeight,
                        (300 - scaledWidth) / 2, (300 - scaledHeight) / 2, scaledWidth, scaledHeight
                    )
                    
                    console.log('✅ 人脸捕获成功:', {
                        scale,
                        scaledWidth,
                        scaledHeight,
                        hasDescriptor: !!bestFace.descriptor
                    })
                    
                                            // 严格的描述符提取和验证逻辑
                         let descriptor = bestFace.descriptor
                         
                         // 验证现有描述符的有效性
                         if (descriptor) {
                             if (!Array.isArray(descriptor) && !(descriptor instanceof Float32Array)) {
                                 console.warn('现有描述符格式无效，重新提取')
                                 descriptor = null
                             } else if (descriptor.length !== 128) {
                                 console.warn(`现有描述符维度错误：${descriptor.length}，期望128维，重新提取`)
                                 descriptor = null
                             } else {
                                 // 检查数值有效性
                                 const hasValidNumbers = Array.from(descriptor).every(val => 
                                     typeof val === 'number' && !isNaN(val) && isFinite(val)
                                 )
                                 if (!hasValidNumbers) {
                                     console.warn('现有描述符包含无效数值，重新提取')
                                     descriptor = null
                                 } else {
                                     console.log('✅ 现有描述符验证通过，128维有效描述符')
                                 }
                             }
                         }
                         
                         // 如果没有有效描述符，尝试重新提取
                         if (!descriptor) {
                             console.log('🔄 开始重新提取描述符...')
                             
                             // 检查 Face Recognition 模型是否已加载
                             if (!modelsLoaded.value) {
                                 console.error('❌ 模型未加载，无法提取描述符')
                                 ElMessage.error('人脸识别模型未加载完成，请等待模型加载后再试')
                             } else {
                                 console.log('✅ 模型已加载，开始重新提取描述符')
                                 
                                 // 优化的参数组合，按成功率排序
                                 const detectionOptions = [
                                     new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.4 }),
                                     new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.3 }),
                                     new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }),
                                     new faceapi.TinyFaceDetectorOptions({ inputSize: 608, scoreThreshold: 0.2 })
                                 ]
                                 
                                 for (let i = 0; i < detectionOptions.length && !descriptor; i++) {
                                     try {
                                         console.log(`🔍 尝试参数组合 ${i + 1}/${detectionOptions.length}:`, {
                                             inputSize: detectionOptions[i].inputSize,
                                             scoreThreshold: detectionOptions[i].scoreThreshold
                                         })
                                         
                                         const faceDetection = await faceapi
                                             .detectSingleFace(tempCanvas, detectionOptions[i])
                                             .withFaceLandmarks()
                                             .withFaceDescriptor()
                                         
                                         if (faceDetection && faceDetection.descriptor) {
                                             const extractedDescriptor = Array.from(faceDetection.descriptor)
                                             
                                             // 严格验证提取的描述符
                                             if (extractedDescriptor.length === 128) {
                                                 const hasValidNumbers = extractedDescriptor.every(val => 
                                                     typeof val === 'number' && !isNaN(val) && isFinite(val)
                                                 )
                                                 
                                                 if (hasValidNumbers) {
                                                     descriptor = extractedDescriptor
                                                     console.log(`✅ 参数组合 ${i + 1} 成功提取有效的128维描述符`)
                                                     console.log(`📊 描述符统计: 最小值=${Math.min(...descriptor).toFixed(4)}, 最大值=${Math.max(...descriptor).toFixed(4)}`)
                                                     break
                                                 } else {
                                                     console.warn(`⚠️ 参数组合 ${i + 1} 提取的描述符包含无效数值`)
                                                 }
                                             } else {
                                                 console.warn(`⚠️ 参数组合 ${i + 1} 提取的描述符维度错误：${extractedDescriptor.length}`)
                                             }
                                         } else {
                                             console.warn(`⚠️ 参数组合 ${i + 1} 未检测到人脸或无法提取描述符`)
                                         }
                                     } catch (error) {
                                         console.error(`❌ 参数组合 ${i + 1} 出错:`, error.message)
                                     }
                                 }
                                 
                                 if (!descriptor) {
                                     console.error('❌ 所有参数组合都无法提取有效的128维描述符')
                                     console.log('💡 建议：')
                                     console.log('  1. 确保人脸清晰、光线充足')
                                     console.log('  2. 保持人脸正面朝向摄像头')
                                     console.log('  3. 避免遮挡（眼镜、帽子、口罩等）')
                                     console.log('  4. 确保摄像头分辨率足够')
                                     ElMessage.warning('无法提取人脸特征，该人脸将仅作为图片存储，无法用于识别')
                                 }
                             }
                         }
                    
                    currentCapturedFace.value = {
                        detection: bestFace.detection,
                        descriptor: descriptor,
                        image: tempCanvas.toDataURL('image/jpeg', 0.9) // 提高图片质量
                    }
                    
                    console.log('🔧 对话框状态:', {
                        showAddDialog: showAddDialog.value,
                        currentCapturedFace: !!currentCapturedFace.value,
                        hasDescriptor: !!descriptor,
                        descriptorLength: descriptor ? descriptor.length : 'N/A'
                    })
                    
                    newFaceName.value = ''
                    newFaceNote.value = ''
                    showAddDialog.value = true
                    
                    // 等待对话框渲染完成后，将图像绘制到对话框中的canvas
                    Vue.nextTick(() => {
                        drawCapturedFaceToDialog()
                    })
                }
                
                const drawCapturedFaceToDialog = () => {
                    if (!currentCapturedFace.value || !currentCapturedFace.value.image) {
                        console.warn('⚠️ 没有捕获的人脸图像')
                        return
                    }
                    
                    const canvas = captureCanvas.value // 获取对话框中的canvas
                    if (!canvas) {
                        console.warn('⚠️ 对话框canvas元素未找到，可能对话框还未完全渲染')
                        setTimeout(() => {
                            drawCapturedFaceToDialog()
                        }, 100)
                        return
                    }
                    
                    const ctx = canvas.getContext('2d')
                    if (!ctx) {
                        console.error('❌ 无法获取对话框canvas上下文')
                        return
                    }
                    
                    const img = new Image()
                    img.onload = () => {
                        ctx.clearRect(0, 0, 300, 300)
                        ctx.drawImage(img, 0, 0, 300, 300)
                        console.log('✅ 人脸图像已绘制到对话框')
                    }
                    img.onerror = (error) => {
                        console.error('❌ 图像加载失败:', error)
                    }
                    img.src = currentCapturedFace.value.image
                }
                
                const confirmAddFace = async () => {
                    console.log('💾 开始确认添加人脸:', {
                        currentCapturedFace: !!currentCapturedFace.value,
                        newFaceName: newFaceName.value.trim(),
                        newFaceNote: newFaceNote.value.trim(),
                        hasDescriptor: !!(currentCapturedFace.value?.descriptor)
                    })
                    
                    if (!currentCapturedFace.value || !newFaceName.value.trim()) {
                        ElMessage.warning('请输入姓名')
                        return
                    }
                    
                    try {
                        const newFace = {
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                            name: newFaceName.value.trim(),
                            note: newFaceNote.value.trim(),
                            image: currentCapturedFace.value.image,
                            descriptor: currentCapturedFace.value.descriptor ? Array.from(currentCapturedFace.value.descriptor) : null,
                            timestamp: new Date().toISOString()
                        }
                        
                        console.log('📋 准备添加的人脸数据:', {
                            id: newFace.id,
                            name: newFace.name,
                            note: newFace.note,
                            hasImage: !!newFace.image,
                            hasDescriptor: !!newFace.descriptor,
                            descriptorLength: newFace.descriptor ? newFace.descriptor.length : 0
                        })
                        
                        // 保存到IndexedDB
                        console.log('🗄️ 开始保存到IndexedDB...')
                        const savedFace = await faceDB.value.addFace(newFace)
                        
                        console.log('✅ 保存到数据库成功:', savedFace.id)
                        
                        // 更新本地人脸库
                        faceLibrary.value.push(savedFace)
                        console.log('📚 更新本地人脸库，当前数量:', faceLibrary.value.length)
                        
                        showAddDialog.value = false
                        
                        // 根据是否有描述符给出不同的提示
                        if (savedFace.descriptor && savedFace.descriptor.length === 128) {
                            console.log('🎯 添加成功 - 支持识别')
                            ElMessage.success(`已添加 "${savedFace.name}" 到人脸库（支持识别）`)
                        } else {
                            console.log('📸 添加成功 - 仅存储')
                            ElMessage.warning(`已添加 "${savedFace.name}" 到人脸库（仅存储，无法识别）\n请确保摄像头清晰并重新尝试`)
                        }
                        
                        // 验证保存结果
                        const allFaces = await faceDB.value.getAllFaces()
                        console.log('🔍 验证：数据库中的人脸总数:', allFaces.length)
                        
                    } catch (error) {
                        console.error('❌ 添加人脸失败:', error)
                        ElMessage.error('添加失败: ' + error.message)
                    }
                }
                
                // 文件处理
                const handleFileSelect = (event) => {
                    const files = Array.from(event.target.files)
                    processImageFiles(files)
                }
                
                const handleDrop = (event) => {
                    isDragging.value = false
                    const files = Array.from(event.dataTransfer.files)
                    processImageFiles(files.filter(file => file.type.startsWith('image/')))
                }
                
                const handleDragOver = () => {
                    isDragging.value = true
                }
                
                const handleDragLeave = () => {
                    isDragging.value = false
                }
                
                const processImageFiles = async (files) => {
                    if (files.length === 0) return
                    
                    if (!modelsLoaded.value) {
                        ElMessage.warning('模型尚未加载完成，请稍后再试')
                        return
                    }
                    
                    const loading = ElMessage({
                        message: '正在处理图片...',
                        type: 'info',
                        duration: 0
                    })
                    
                    let successCount = 0
                    let errorMessages = []
                    
                    try {
                        for (const file of files) {
                            try {
                                console.log(`📸 开始处理图片: ${file.name}`)
                            await processImageFile(file)
                                successCount++
                                console.log(`✅ 成功处理图片: ${file.name}`)
                            } catch (error) {
                                console.error(`❌ 处理图片失败: ${file.name}`, error)
                                errorMessages.push(`${file.name}: ${error.message}`)
                        }
                        }
                        
                        loading.close()
                        
                        if (successCount > 0) {
                            ElMessage.success(`成功处理 ${successCount} 张图片`)
                        }
                        
                        if (errorMessages.length > 0) {
                            ElMessage.warning(`部分图片处理失败:\n${errorMessages.slice(0, 3).join('\n')}${errorMessages.length > 3 ? '\n...' : ''}`)
                        }
                    } catch (error) {
                        loading.close()
                        console.error('批量处理图片失败:', error)
                        ElMessage.error('图片处理失败: ' + error.message)
                    }
                }
                
                const processImageFile = async (file) => {
                    return new Promise((resolve, reject) => {
                        const img = new Image()
                        const canvas = document.createElement('canvas')
                        const ctx = canvas.getContext('2d')
                        
                        img.onload = async () => {
                            // 调整图片尺寸
                            const maxSize = 640
                            let { width, height } = img
                            
                            if (width > maxSize || height > maxSize) {
                                const ratio = Math.min(maxSize / width, maxSize / height)
                                width *= ratio
                                height *= ratio
                            }
                            
                            canvas.width = width
                            canvas.height = height
                            ctx.drawImage(img, 0, 0, width, height)
                            
                            try {
                                // 多种检测策略，从宽松到严格
                                const detectionOptions = [
                                    new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.3 }),
                                    new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.4 }),
                                    new faceapi.TinyFaceDetectorOptions({ inputSize: 512, scoreThreshold: 0.5 }),
                                    new faceapi.TinyFaceDetectorOptions({ inputSize: 608, scoreThreshold: 0.6 })
                                ]
                                
                                let detection = null
                                
                                // 尝试不同的检测参数
                                for (let i = 0; i < detectionOptions.length && !detection; i++) {
                                    try {
                                        console.log(`🔍 尝试检测参数 ${i + 1}/${detectionOptions.length}:`, {
                                            inputSize: detectionOptions[i].inputSize,
                                            scoreThreshold: detectionOptions[i].scoreThreshold,
                                            fileName: file.name
                                        })
                                        
                                        detection = await faceapi
                                            .detectSingleFace(canvas, detectionOptions[i])
                                    .withFaceLandmarks()
                                    .withFaceDescriptor()
                                
                                if (detection) {
                                            console.log(`✅ 参数组合 ${i + 1} 成功检测到人脸:`, {
                                                score: detection.detection.score,
                                                box: detection.detection.box
                                            })
                                            break
                                        } else {
                                            console.log(`⚠️ 参数组合 ${i + 1} 未检测到人脸`)
                                        }
                                    } catch (error) {
                                        console.warn(`❌ 参数组合 ${i + 1} 检测失败:`, error.message)
                                    }
                                }
                                
                                if (detection) {
                                    // 提取人脸区域（添加padding）
                                    const { x, y, width: faceWidth, height: faceHeight } = detection.detection.box
                                    const faceCanvas = document.createElement('canvas')
                                    const faceCtx = faceCanvas.getContext('2d')
                                    
                                    faceCanvas.width = 300  // 增大输出尺寸
                                    faceCanvas.height = 300
                                    
                                    // 添加padding，扩展人脸区域
                                    const padding = Math.max(faceWidth, faceHeight) * 0.4  // 40%的padding
                                    const expandedX = Math.max(0, x - padding)
                                    const expandedY = Math.max(0, y - padding)
                                    const expandedWidth = Math.min(canvas.width - expandedX, faceWidth + padding * 2)
                                    const expandedHeight = Math.min(canvas.height - expandedY, faceHeight + padding * 2)
                                    
                                    console.log(`📏 人脸区域扩展 ${file.name}:`, {
                                        original: { x, y, width: faceWidth, height: faceHeight },
                                        expanded: { x: expandedX, y: expandedY, width: expandedWidth, height: expandedHeight },
                                        padding: padding
                                    })
                                    
                                    const scale = Math.min(300 / expandedWidth, 300 / expandedHeight)
                                    const scaledWidth = expandedWidth * scale
                                    const scaledHeight = expandedHeight * scale
                                    
                                    faceCtx.clearRect(0, 0, 300, 300)
                                    faceCtx.drawImage(
                                        canvas,
                                        expandedX, expandedY, expandedWidth, expandedHeight,
                                        (300 - scaledWidth) / 2, (300 - scaledHeight) / 2, scaledWidth, scaledHeight
                                    )
                                    
                                    const fileName = file.name.replace(/\.[^/.]+$/, "")
                                    const newFace = {
                                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                        name: fileName,
                                        note: '',
                                        image: faceCanvas.toDataURL('image/jpeg', 0.9),
                                        descriptor: Array.from(detection.descriptor),
                                        timestamp: new Date().toISOString(),
                                        source: 'upload'  // 标记数据来源
                                    }
                                    
                                    // 保存到IndexedDB数据库
                                    const savedFace = await faceDB.value.addFace(newFace)
                                    faceLibrary.value.push(savedFace)
                                    resolve()
                                } else {
                                    reject(new Error(`未在图片 ${file.name} 中检测到人脸。建议：确保图片清晰、人脸正面且占比较大`))
                                }
                            } catch (error) {
                                console.error(`人脸检测失败 ${file.name}:`, error)
                                reject(new Error(`人脸检测失败: ${error.message}`))
                            }
                        }
                        
                        img.onerror = () => {
                            console.error(`图片加载失败: ${file.name}`)
                            reject(new Error(`图片加载失败: ${file.name}`))
                        }
                        
                        try {
                        img.src = URL.createObjectURL(file)
                        } catch (error) {
                            console.error(`创建图片URL失败: ${file.name}`, error)
                            reject(new Error(`创建图片URL失败: ${error.message}`))
                        }
                    })
                }
                
                // 其他功能
                const toggleComparison = () => {
                    comparisonMode.value = !comparisonMode.value
                    
                    if (comparisonMode.value && faceLibrary.value.length === 0) {
                        ElMessage.warning('人脸库为空，请先添加人脸数据')
                        comparisonMode.value = false
                        return
                    }
                    
                    ElMessage.info(comparisonMode.value ? '人脸识别已开启' : '人脸识别已关闭')
                }
                
                const removeFace = async (index) => {
                    try {
                        const face = faceLibrary.value[index]
                        await ElMessageBox.confirm(
                            `确定要删除 "${face.name}" 吗？`,
                            '确认删除',
                            { type: 'warning' }
                        )
                        
                        // 从数据库删除
                        await faceDB.value.deleteFace(face.id)
                        
                        // 从本地数组删除
                        faceLibrary.value.splice(index, 1)
                        ElMessage.success('删除成功')
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除失败:', error)
                            ElMessage.error('删除失败: ' + error.message)
                        }
                    }
                }
                
                const clearLibrary = async () => {
                    try {
                        await ElMessageBox.confirm(
                            '确定要清空整个人脸库吗？此操作不可恢复！',
                            '确认清空',
                            { type: 'warning' }
                        )
                        
                        // 清空数据库
                        await faceDB.value.clearAllFaces()
                        
                        // 清空本地数组
                        faceLibrary.value = []
                        matchedFaces.value = []
                        ElMessage.success('人脸库已清空')
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('清空失败:', error)
                            ElMessage.error('清空失败: ' + error.message)
                        }
                    }
                }
                
                const exportLibrary = async () => {
                    try {
                        // 从数据库获取最新数据
                        const dbData = await faceDB.value.exportData()
                        
                        const blob = new Blob([JSON.stringify(dbData, null, 2)], { type: 'application/json' })
                        const url = URL.createObjectURL(blob)
                        const link = document.createElement('a')
                        link.href = url
                        link.download = `face-library-${new Date().toISOString().split('T')[0]}.json`
                        document.body.appendChild(link)
                        link.click()
                        document.body.removeChild(link)
                        URL.revokeObjectURL(url)
                        
                        ElMessage.success('人脸库数据已导出')
                    } catch (error) {
                        console.error('导出失败:', error)
                        ElMessage.error('导出失败: ' + error.message)
                    }
                }
                
                // 数据持久化已移至IndexedDB (loadFaceLibrary方法在下方)
                
                const updateFPS = () => {
                    fpsCounter.value++
                    const now = Date.now()
                    
                    if (now - lastFpsUpdate.value >= 1000) {
                        fps.value = fpsCounter.value
                        fpsCounter.value = 0
                        lastFpsUpdate.value = now
                    }
                }
                
                // 导出图片（简化版本）
                const exportImages = async () => {
                    try {
                        if (faceLibrary.value.length === 0) {
                            ElMessage.warning('人脸库为空，无法导出图片')
                            return
                        }
                        
                        ElMessage.info('正在逐个下载人脸图片...')
                        
                        // 逐个下载人脸图片
                        faceLibrary.value.forEach((face, index) => {
                            if (face.image) {
                                setTimeout(() => {
                                    const link = document.createElement('a')
                                    link.href = face.image
                                const safeName = face.name.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_')
                                    link.download = `${safeName}_${face.id}.jpg`
                                    document.body.appendChild(link)
                                    link.click()
                                    document.body.removeChild(link)
                                }, index * 300) // 每300ms下载一个，避免浏览器限制
                            }
                        })
                        
                        setTimeout(() => {
                            ElMessage.success(`已开始下载 ${faceLibrary.value.length} 张人脸图片`)
                        }, 1000)
                        
                    } catch (error) {
                        console.error('导出图片失败:', error)
                        ElMessage.error('导出图片失败: ' + error.message)
                    }
                }
                
                // 导入人脸库
                const importLibrary = async () => {
                    const input = document.createElement('input')
                    input.type = 'file'
                    input.accept = '.json'
                    
                    input.onchange = async (event) => {
                        const file = event.target.files[0]
                        if (!file) return
                        
                        const loading = ElMessage({
                            message: '正在导入人脸库...',
                            type: 'info',
                            duration: 0
                        })
                        
                        try {
                            const text = await file.text()
                            const data = JSON.parse(text)
                            
                            const results = await faceDB.value.importData(data)
                            
                            // 重新加载人脸库
                            await loadFaceLibrary()
                            
                            loading.close()
                            
                            if (results.success > 0) {
                                ElMessage.success(`导入成功: ${results.success} 个人脸`)
                            }
                            
                            if (results.failed > 0) {
                                ElMessage.warning(`导入失败: ${results.failed} 个人脸`)
                            }
                        } catch (error) {
                            loading.close()
                            console.error('导入失败:', error)
                            ElMessage.error('导入失败: ' + error.message)
                        }
                    }
                    
                    input.click()
                }
                
                // 显示存储使用情况
                const showStorageUsage = async () => {
                    try {
                        const usage = await faceDB.value.getStorageUsage()
                        
                        let message = `💾 浏览器存储使用情况\n\n`
                        
                        if (usage.total > 0) {
                            message += `总使用量: ${faceDB.value.formatBytes(usage.total)}\n`
                            message += `总配额: ${faceDB.value.formatBytes(usage.quota)}\n`
                            message += `使用率: ${usage.percentage.toFixed(1)}%\n\n`
                        }
                        
                        message += `📚 IndexedDB: ${faceDB.value.formatBytes(usage.indexedDB.size)}\n`
                        message += `🗂️ LocalStorage: ${faceDB.value.formatBytes(usage.localStorage.size)}\n`
                        message += `📋 SessionStorage: ${faceDB.value.formatBytes(usage.sessionStorage.size)}\n\n`
                        
                        message += `💡 提示：\n`
                        message += `• IndexedDB 存储人脸数据和图片\n`
                        message += `• LocalStorage 存储应用设置\n`
                        message += `• SessionStorage 存储临时数据`
                        
                        ElMessageBox.alert(message, '存储使用情况', {
                            type: 'info'
                        })
                    } catch (error) {
                        console.error('获取存储使用情况失败:', error)
                        ElMessage.error('获取存储使用情况失败')
                    }
                }
                
                // 清除所有缓存
                const clearAllCache = async () => {
                    try {
                        await ElMessageBox.confirm(
                            '⚠️ 警告：此操作将彻底清除所有本地数据！\n\n' +
                            '将会删除以下内容：\n' +
                            '• 所有人脸库数据 (IndexedDB)\n' +
                            '• 应用设置和缓存 (LocalStorage)\n' +
                            '• 临时数据 (SessionStorage)\n' +
                            '• 网页缓存 (Cache API)\n' +
                            '• Service Worker\n' +
                            '• 相关 Cookies\n\n' +
                            '此操作不可撤销，确定要继续吗？',
                            '清除所有缓存',
                            {
                                confirmButtonText: '确定清除',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        )
                        
                        // 二次确认
                        await ElMessageBox.confirm(
                            '🔥 最后确认：您真的要删除所有数据吗？\n\n' +
                            '这包括您辛苦建立的人脸库！\n' +
                            '请确保您已经导出了重要数据的备份。',
                            '最后确认',
                            {
                                confirmButtonText: '是的，全部删除',
                                cancelButtonText: '等等，我再想想',
                                type: 'error'
                            }
                        )
                        
                        const loading = ElLoading.service({
                            lock: true,
                            text: '正在清除所有缓存...'
                        })
                        
                        try {
                            // 执行清除操作
                            const results = await faceDB.value.clearAllCache()
                            
                            loading.close()
                            
                            // 重置本地状态
                            faceLibrary.value = []
                            matchedFaces.value = []
                            faceMatcher.value = null
                            
                            // 生成清除结果报告
                            let report = '🧹 缓存清除完成！\n\n'
                            report += `✅ IndexedDB: ${results.indexedDB ? '已清除' : '清除失败'}\n`
                            report += `✅ LocalStorage: ${results.localStorage ? '已清除' : '清除失败'}\n`
                            report += `✅ SessionStorage: ${results.sessionStorage ? '已清除' : '清除失败'}\n`
                            report += `✅ Cache API: ${results.cacheAPI ? '已清除' : '清除失败'}\n`
                            report += `✅ Service Worker: ${results.serviceWorker ? '已清除' : '清除失败'}\n`
                            report += `✅ Cookies: ${results.cookies ? '已清除' : '清除失败'}\n`
                            
                            if (results.errors.length > 0) {
                                report += `\n⚠️ 部分清除失败：\n${results.errors.slice(0, 3).join('\n')}`
                            }
                            
                            report += '\n\n💡 建议刷新页面以确保完全生效。'
                            
                            await ElMessageBox.alert(report, '清除结果', {
                                type: results.errors.length === 0 ? 'success' : 'warning'
                            })
                            
                            // 询问是否刷新页面
                            try {
                                await ElMessageBox.confirm(
                                    '清除完成！是否立即刷新页面？',
                                    '刷新页面',
                                    { type: 'info' }
                                )
                                window.location.reload()
                            } catch {
                                // 用户选择不刷新
                            }
                            
                        } catch (error) {
                            loading.close()
                            console.error('清除缓存失败:', error)
                            ElMessage.error('清除缓存失败: ' + error.message)
                        }
                        
                    } catch (error) {
                        // 用户取消或其他错误
                        console.log('清除操作已取消')
                    }
                }
                
                // 加载人脸库
                const loadFaceLibrary = async () => {
                    try {
                        console.log('📚 开始从数据库加载人脸库...')
                        
                        if (!faceDB.value) {
                            console.warn('⚠️ 数据库未初始化')
                            return
                        }
                        
                        const faces = await faceDB.value.getAllFaces()
                        faceLibrary.value = faces
                        console.log('✅ 人脸库加载完成，数量:', faceLibrary.value.length)
                        
                        // 获取统计信息
                        const stats = await faceDB.value.getStats()
                        console.log('📊 人脸库统计:', stats)
                        
                        // 更新人脸匹配器
                        updateFaceMatcher()
                    } catch (error) {
                        console.error('❌ 加载人脸库失败:', error)
                        console.log('📝 人脸库为空，这是首次使用')
                    }
                }
                
                const cleanup = () => {
                    if (stream.value) {
                        stream.value.getTracks().forEach(track => track.stop())
                        stream.value = null
                    }
                    
                    stopDetection()
                    
                    if (videoRef.value) {
                        videoRef.value.srcObject = null
                    }
                    
                    // 关闭数据库连接
                    if (faceDB.value) {
                        faceDB.value.close()
                    }
                }
                
                return {
                    // refs
                    videoRef,
                    canvasRef,
                    captureCanvas,
                    fileInput,
                    
                    // state
                    isRunning,
                    isLoading,
                    modelsLoaded,
                    comparisonMode,
                    faceData,
                    matchedFaces,
                    faceLibrary,
                    
                    // settings
                    recognitionThreshold,
                    detectionInterval,
                    showLandmarks,
                    showExpressions,
                    detectionScore,
                    inputSize,
                    targetFPS,
                    
                    // UI
                    showAddDialog,
                    newFaceName,
                    newFaceNote,
                    isDragging,
                    
                    // stats
                    fps,
                    detectionCount,
                    browserSupport,
                    features,
                    
                    // computed
                    isMatched,
                    getMatchConfidence,
                    averageConfidence,
                    
                    // functions
                    checkBrowserSupport,
                    getExpressionLabel,
                    
                    // methods
                    startCamera,
                    stopCamera,
                    captureAndAdd,
                    confirmAddFace,
                    drawCapturedFaceToDialog,
                    loadFaceLibrary,
                    toggleComparison,
                    removeFace,
                    clearLibrary,
                    exportLibrary,
                    exportImages,
                    importLibrary,
                    handleFileSelect,
                    handleDrop,
                    handleDragOver,
                    handleDragLeave,
                    showStorageUsage,
                    clearAllCache
                }
            }
        }).use(ElementPlus).mount('#app')
    </script>
</body>
</html>