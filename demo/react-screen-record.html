<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React录屏+音频转字幕系统</title>
    
    <!-- 全局错误拦截器 - 必须在所有脚本加载前设置 -->
    <script>
        (function() {
            // 保存原始方法
            const originalWarn = console.warn;
            const originalError = console.error;
            
            // 重写console.warn
            console.warn = function(...args) {
                const message = args[0];
                if (typeof message === 'string' && 
                    (message.includes('findDOMNode') || 
                     message.includes('Warning: findDOMNode'))) {
                    return; // 静默忽略findDOMNode警告
                }
                originalWarn.apply(console, args);
            };
            
            // 重写console.error
            console.error = function(...args) {
                const message = args[0];
                if (typeof message === 'string' && 
                    (message.includes('findDOMNode') || 
                     message.includes('Warning: findDOMNode'))) {
                    return; // 静默忽略findDOMNode错误
                }
                originalError.apply(console, args);
            };
            
            // 设置生产环境
            window.NODE_ENV = 'production';
        })();
    </script>
    
    <!-- React 18 - 使用生产版本 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Day.js -->
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/customParseFormat.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/weekday.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/localeData.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/weekOfYear.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/weekYear.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/advancedFormat.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/plugin/quarterOfYear.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/locale/zh-cn.js"></script>
    
    <!-- Ant Design CSS - 最新版本 -->
    <link rel="stylesheet" href="https://unpkg.com/antd@5.16.1/dist/reset.css">
    
    <!-- Ant Design JS - 最新版本 -->
    <script src="https://unpkg.com/antd@5.16.1/dist/antd.min.js"></script>
    
    <!-- Ant Design Icons - 最新版本 -->
    <script src="https://unpkg.com/@ant-design/icons@5.3.6/dist/index.umd.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #ffffff;
            color: #1a202c;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            min-height: 100vh;
            overflow: hidden;
            background: white;
            margin: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .header {
            background: #ffffff;
            color: #1a202c;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-container video {
            width: 100%;
            height: auto;
            max-height: 400px;
        }

        .video-placeholder {
            color: #666;
            font-size: 1.1rem;
            text-align: center;
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #ff4757;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .transcript-panel, .translation-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
        }

        .transcript-content, .translation-content {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            min-height: 150px;
            font-size: 1rem;
            line-height: 1.6;
            color: #495057;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .settings-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
        }

        .setting-item {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .control-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
        }

        .loading-message {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error-message {
            text-align: center;
            padding: 50px;
            color: red;
        }

        .translation-status {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            color: #0050b3;
        }
        
        .translation-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <!-- 返回文档链接 -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 2000; padding: 8px 12px; border-radius: 5px; border: 1px solid #dee2e6;">
        <a href="https://www.siqiongbiluo.love/article/23" style="text-decoration: none; color: #61dafb; font-size: 14px; font-weight: 500;">← 返回文档</a>
    </div>
    <div id="root">
        <div class="loading-message">
            <h2>⏳ 正在加载依赖...</h2>
            <p>请稍候，系统正在初始化</p>
        </div>
    </div>

    <script>
        // 等待所有依赖加载完成
        function waitForDependencies() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5秒超时
                
                const checkDependencies = () => {
                    attempts++;
                    
                    if (typeof React !== 'undefined' && 
                        typeof ReactDOM !== 'undefined' && 
                        typeof antd !== 'undefined' &&
                        typeof dayjs !== 'undefined') {
                        
                        // 配置dayjs插件
                        if (dayjs.extend) {
                            dayjs.extend(dayjs_plugin_customParseFormat);
                            dayjs.extend(dayjs_plugin_weekday);
                            dayjs.extend(dayjs_plugin_localeData);
                            dayjs.extend(dayjs_plugin_weekOfYear);
                            dayjs.extend(dayjs_plugin_weekYear);
                            dayjs.extend(dayjs_plugin_advancedFormat);
                            dayjs.extend(dayjs_plugin_quarterOfYear);
                            dayjs.locale('zh-cn');
                        }
                        
                        // 额外的警告抑制 - 双重保险
                        const suppressFindDOMNodeWarnings = () => {
                            const originalWarn = console.warn;
                            const originalError = console.error;
                            
                            console.warn = function(...args) {
                                const message = args[0];
                                if (typeof message === 'string' && 
                                    (message.includes('findDOMNode') || 
                                     message.includes('Warning: findDOMNode') ||
                                     message.includes('ReactDOM.findDOMNode'))) {
                                    return;
                                }
                                originalWarn.apply(console, args);
                            };
                            
                            console.error = function(...args) {
                                const message = args[0];
                                if (typeof message === 'string' && 
                                    (message.includes('findDOMNode') || 
                                     message.includes('Warning: findDOMNode') ||
                                     message.includes('ReactDOM.findDOMNode'))) {
                                    return;
                                }
                                originalError.apply(console, args);
                            };
                        };
                        
                        suppressFindDOMNodeWarnings();
                        
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('依赖加载超时'));
                    } else {
                        setTimeout(checkDependencies, 100);
                    }
                };
                
                checkDependencies();
            });
        }

        // 初始化应用
        async function initApp() {
            try {
                await waitForDependencies();
                
                const { useState, useEffect, useRef, useCallback } = React;
                const { 
                    Button, 
                    Alert, 
                    Progress, 
                    Card, 
                    Select, 
                    Switch, 
                    message 
                } = antd;
                
                // 检查图标是否可用
                let icons = {};
                if (typeof window.icons !== 'undefined' && window.icons) {
                    icons = window.icons;
                } else {
                    // 使用文本替代图标
                    icons = {
                        VideoCameraOutlined: () => React.createElement('span', {}, ''),
                PlayCircleOutlined: () => React.createElement('span', {}, ''),
                PauseCircleOutlined: () => React.createElement('span', {}, ''),
                DeleteOutlined: () => React.createElement('span', {}, ''),
                FileTextOutlined: () => React.createElement('span', {}, ''),
                CopyOutlined: () => React.createElement('span', {}, ''),
                FolderOutlined: () => React.createElement('span', {}, ''),
                ReloadOutlined: () => React.createElement('span', {}, ''),
                SettingOutlined: () => React.createElement('span', {}, '')
                    };
                }

                const { 
                    VideoCameraOutlined,
                    PauseCircleOutlined,
                    DownloadOutlined,
                    DeleteOutlined,
                    FileTextOutlined,
                    CopyOutlined,
                    FolderOutlined,
                    ReloadOutlined,
                    SettingOutlined
                } = icons;

                const ScreenRecordApp = () => {
                    // 录制相关状态
                    const [mediaRecorder, setMediaRecorder] = useState(null);
                    const [recordedChunks, setRecordedChunks] = useState([]);
                    const [stream, setStream] = useState(null);
                    const [recognition, setRecognition] = useState(null);
                    const [isRecording, setIsRecording] = useState(false);
                    const [startTime, setStartTime] = useState(null);
                    const [videoUrl, setVideoUrl] = useState('');
                    const [recordedVideo, setRecordedVideo] = useState(false);
                    
                    // 字幕相关
                    const [transcriptText, setTranscriptText] = useState('');
                    
                    // 翻译相关
                    const [translationText, setTranslationText] = useState('');
                    const [isTranslating, setIsTranslating] = useState(false);
                    const [translationSettings, setTranslationSettings] = useState({
                        targetLanguage: 'en'
                    });
                    const [translationStatus, setTranslationStatus] = useState({
                        show: false,
                        message: '',
                        type: 'info'
                    });
                    
                    // 翻译API配置
                    const [translateApis] = useState({
                        localTranslate: {
                            url: 'local',
                            name: '本地翻译 (无CORS问题)',
                            cors: true
                        },
                        myMemory: {
                            url: 'https://api.mymemory.translated.net/get',
                            name: 'MyMemory (免费)',
                            cors: true
                        },
                        googleTranslate: {
                            url: 'https://translate.googleapis.com/translate_a/single',
                            name: 'Google Translate (免费)',
                            cors: true
                        },
                        libreTranslate: {
                            url: 'https://libretranslate.de/translate',
                            name: 'LibreTranslate (免费)',
                            cors: false
                        }
                    });
                    
                    // 检测是否为本地文件运行
                    const [isLocalFile] = useState(window.location.protocol === 'file:');
                    const [currentTranslateApi, setCurrentTranslateApi] = useState(
                        window.location.protocol === 'file:' ? 'localTranslate' : 'myMemory'
                    );
                    
                    // 状态相关
                    const [statusMessage, setStatusMessage] = useState('系统就绪');
                    const [statusType, setStatusType] = useState('success');
                    const [recordingInfo, setRecordingInfo] = useState('等待开始录制...');
                    const [recordingTime, setRecordingTime] = useState('');
                    const [recordingProgress, setRecordingProgress] = useState(0);
                    const [browserSupported, setBrowserSupported] = useState(true);
                    
                    // 设置
                    const [settings, setSettings] = useState({
                        videoQuality: '720p',
                        audioSource: 'system',
                        language: 'zh-CN',
                        continuous: true
                    });

                    const videoRef = useRef(null);
                    const timerRef = useRef(null);

                    // 检查浏览器支持
                    useEffect(() => {
                        const checkBrowserSupport = () => {
                            const supported = !!(
                                navigator.mediaDevices &&
                                navigator.mediaDevices.getDisplayMedia &&
                                window.MediaRecorder &&
                                (window.webkitSpeechRecognition || window.SpeechRecognition)
                            );
                            
                            setBrowserSupported(supported);
                            
                            if (!supported) {
                                setStatusMessage('浏览器不支持录屏或语音识别功能');
                                setStatusType('error');
                                message.error('请使用支持的浏览器（Chrome、Edge等）');
                            }
                        };

                        checkBrowserSupport();
                    }, []);

                    // 获取视频约束
                    const getVideoConstraints = () => {
                        const constraints = {
                            '1080p': { width: 1920, height: 1080, frameRate: 30 },
                            '720p': { width: 1280, height: 720, frameRate: 30 },
                            '480p': { width: 854, height: 480, frameRate: 24 }
                        };
                        
                        return constraints[settings.videoQuality];
                    };

                    // 获取时间戳
                    const getTimestamp = () => {
                        if (!startTime) return '00:00:00';
                        
                        const elapsed = Date.now() - startTime;
                        const hours = Math.floor(elapsed / 3600000);
                        const minutes = Math.floor((elapsed % 3600000) / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        
                        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    };

                    // 初始化语音识别
                    const initSpeechRecognition = () => {
                        if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
                            console.warn('浏览器不支持语音识别');
                            message.error('浏览器不支持语音识别功能');
                            return false;
                        }

                        try {
                            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                            const newRecognition = new SpeechRecognition();
                            
                            newRecognition.continuous = settings.continuous;
                            newRecognition.interimResults = true;
                            newRecognition.lang = settings.language;
                            newRecognition.maxAlternatives = 1;

                            newRecognition.onstart = () => {
                                console.log('语音识别已启动');
                                message.success('语音识别已启动');
                            };

                            newRecognition.onresult = (event) => {
                                let finalTranscript = '';
                                let interimTranscript = '';

                                for (let i = event.resultIndex; i < event.results.length; i++) {
                                    const transcript = event.results[i][0].transcript;
                                    if (event.results[i].isFinal) {
                                        finalTranscript += transcript;
                                    } else {
                                        interimTranscript += transcript;
                                    }
                                }

                                if (finalTranscript) {
                                    const timestamp = getTimestamp();
                                    const newLine = `[${timestamp}] ${finalTranscript}\n`;
                                    setTranscriptText(prev => prev + newLine);
                                    console.log('识别结果:', finalTranscript);
                                }

                                // 显示临时结果（可选）
                                if (interimTranscript && !finalTranscript) {
                                    console.log('临时结果:', interimTranscript);
                                }
                            };

                            newRecognition.onerror = (event) => {
                                console.error('语音识别错误:', event.error);
                                switch(event.error) {
                                    case 'not-allowed':
                                        message.error('请允许麦克风权限以启用语音识别');
                                        break;
                                    case 'no-speech':
                                        console.log('未检测到语音，继续监听...');
                                        break;
                                    case 'audio-capture':
                                        message.error('无法捕获音频，请检查麦克风');
                                        break;
                                    case 'network':
                                        message.error('网络错误，语音识别服务不可用');
                                        break;
                                    default:
                                        message.error(`语音识别错误: ${event.error}`);
                                }
                            };

                            newRecognition.onend = () => {
                                console.log('语音识别结束');
                                if (isRecording) {
                                    // 如果还在录制中，重新启动语音识别
                                    setTimeout(() => {
                                        try {
                                            if (recognition && isRecording) {
                                                newRecognition.start();
                                                console.log('重新启动语音识别');
                                            }
                                        } catch (error) {
                                            console.error('重启语音识别失败:', error);
                                        }
                                    }, 100);
                                }
                            };

                            setRecognition(newRecognition);
                            return true;
                        } catch (error) {
                            console.error('初始化语音识别失败:', error);
                            message.error('初始化语音识别失败: ' + error.message);
                            return false;
                        }
                    };

                    // 测试语音识别（独立于录制）
                    const testSpeechRecognition = () => {
                        if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
                            message.error('浏览器不支持语音识别功能');
                            return;
                        }

                        try {
                            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                            const testRecognition = new SpeechRecognition();
                            
                            testRecognition.continuous = false;
                            testRecognition.interimResults = true;
                            testRecognition.lang = settings.language;
                            testRecognition.maxAlternatives = 1;

                            testRecognition.onstart = () => {
                                message.info('语音识别测试开始，请说话...');
                            };

                            testRecognition.onresult = (event) => {
                                let finalTranscript = '';
                                for (let i = event.resultIndex; i < event.results.length; i++) {
                                    if (event.results[i].isFinal) {
                                        finalTranscript += event.results[i][0].transcript;
                                    }
                                }

                                if (finalTranscript) {
                                    const timestamp = new Date().toLocaleTimeString();
                                    const newLine = `[${timestamp}] ${finalTranscript}\n`;
                                    setTranscriptText(prev => prev + newLine);
                                    message.success('语音识别成功！');
                                }
                            };

                            testRecognition.onerror = (event) => {
                                message.error(`语音识别错误: ${event.error}`);
                            };

                            testRecognition.onend = () => {
                                message.info('语音识别测试结束');
                            };

                            testRecognition.start();
                        } catch (error) {
                            message.error('语音识别测试失败: ' + error.message);
                        }
                    };

                    // 开始录制
                    const startRecording = async () => {
                        try {
                            setRecordedChunks([]);
                            setRecordedVideo(false);
                            setVideoUrl('');
                            setTranscriptText(''); // 清空之前的字幕

                            const displayStream = await navigator.mediaDevices.getDisplayMedia({
                                video: getVideoConstraints(),
                                audio: settings.audioSource === 'system' || settings.audioSource === 'both'
                            });

                            let audioStream = null;
                            if (settings.audioSource === 'microphone' || settings.audioSource === 'both') {
                                try {
                                    audioStream = await navigator.mediaDevices.getUserMedia({
                                        audio: true,
                                        video: false
                                    });
                                    
                                    const audioTrack = audioStream.getAudioTracks()[0];
                                    displayStream.addTrack(audioTrack);
                                } catch (err) {
                                    console.warn('无法获取麦克风权限:', err);
                                    message.warning('无法获取麦克风权限');
                                }
                            }

                            setStream(displayStream);

                            // 设置实时预览
                            if (videoRef.current) {
                                videoRef.current.srcObject = displayStream;
                                videoRef.current.onloadedmetadata = () => {
                                    videoRef.current.play().catch(e => 
                                        console.log('自动播放被阻止:', e)
                                    );
                                };
                            }

                            let mimeType = 'video/webm;codecs=vp9,opus';
                            if (!MediaRecorder.isTypeSupported(mimeType)) {
                                mimeType = 'video/webm;codecs=vp8,opus';
                            }
                            if (!MediaRecorder.isTypeSupported(mimeType)) {
                                mimeType = 'video/webm';
                            }

                            const recorder = new MediaRecorder(displayStream, { mimeType });

                            recorder.ondataavailable = (event) => {
                                if (event.data.size > 0) {
                                    setRecordedChunks(prev => [...prev, event.data]);
                                }
                            };

                            recorder.onstop = () => {
                                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                                const url = URL.createObjectURL(blob);
                                setVideoUrl(url);
                                setRecordedVideo(true);

                                // 清除实时预览
                                if (videoRef.current) {
                                    videoRef.current.srcObject = null;
                                }

                                setStatusMessage('录制完成，可以下载视频');
                                setStatusType('success');
                                message.success('录制完成');
                            };

                            recorder.start(1000);
                            setMediaRecorder(recorder);
                            setIsRecording(true);
                            setStartTime(Date.now());

                            // 启动语音识别
                            if (initSpeechRecognition() && recognition) {
                                try {
                                    recognition.start();
                                    console.log('语音识别已启动');
                                } catch (error) {
                                    console.error('启动语音识别失败:', error);
                                    message.warning('语音识别启动失败，但录制继续进行');
                                }
                            }

                            setStatusMessage('正在录制中...');
                            setStatusType('warning');
                            setRecordingInfo('录制进行中，语音识别已启动...');
                            startTimer();

                            displayStream.getVideoTracks()[0].onended = () => {
                                stopRecording();
                            };

                            message.success('录制开始，语音识别已启动');

                        } catch (err) {
                            console.error('开始录制失败:', err);
                            message.error('开始录制失败: ' + err.message);
                            setStatusMessage('录制失败: ' + err.message);
                            setStatusType('error');
                        }
                    };

                    // 停止录制
                    const stopRecording = () => {
                        if (!isRecording || !mediaRecorder) {
                            message.warning('当前没有进行录制');
                            return;
                        }

                        try {
                            mediaRecorder.stop();
                            
                            if (stream) {
                                stream.getTracks().forEach(track => track.stop());
                                setStream(null);
                            }

                            // 停止语音识别
                            if (recognition) {
                                try {
                                    recognition.stop();
                                    console.log('语音识别已停止');
                                } catch (error) {
                                    console.error('停止语音识别失败:', error);
                                }
                            }

                            setIsRecording(false);
                            setStartTime(null);
                            
                            if (timerRef.current) {
                                clearInterval(timerRef.current);
                                timerRef.current = null;
                            }

                            setRecordingInfo('录制已停止，语音识别已关闭');
                            setRecordingTime('');
                            setRecordingProgress(0);

                            message.success('录制已停止，语音识别已关闭');

                        } catch (err) {
                            console.error('停止录制失败:', err);
                            message.error('停止录制失败: ' + err.message);
                        }
                    };

                    // 开始计时器
                    const startTimer = () => {
                        timerRef.current = setInterval(() => {
                            if (!isRecording) {
                                clearInterval(timerRef.current);
                                return;
                            }

                            const elapsed = Date.now() - startTime;
                            const minutes = Math.floor(elapsed / 60000);
                            const seconds = Math.floor((elapsed % 60000) / 1000);

                            setRecordingTime(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);

                            const maxTime = 30 * 60 * 1000;
                            setRecordingProgress(Math.min((elapsed / maxTime) * 100, 100));
                        }, 1000);
                    };

                    // 下载视频
                    const downloadVideo = () => {
                        if (!videoUrl) {
                            message.warning('没有可下载的视频');
                            return;
                        }

                        const a = document.createElement('a');
                        a.href = videoUrl;
                        a.download = `react-screen-recording-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.webm`;
                        a.click();

                        message.success('视频下载开始');
                    };

                    // 格式化进度
                    const formatProgress = (percentage) => {
                        return percentage === 100 ? '录制即将结束' : `${percentage.toFixed(1)}%`;
                    };

                    // 清空字幕
                    const clearTranscript = () => {
                        setTranscriptText('');
                        message.success('字幕已清空');
                    };

                    // 导出字幕
                    const exportTranscript = () => {
                        if (!transcriptText) {
                            message.warning('没有字幕内容可导出');
                            return;
                        }

                        const blob = new Blob([transcriptText], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `react-transcript-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                        a.click();
                        URL.revokeObjectURL(url);

                        message.success('字幕导出成功');
                    };

                    // 复制字幕
                    const copyTranscript = async () => {
                        if (!transcriptText) {
                            message.warning('没有字幕内容可复制');
                            return;
                        }

                        try {
                            await navigator.clipboard.writeText(transcriptText);
                            message.success('字幕已复制到剪贴板');
                        } catch (error) {
                            console.error('复制失败:', error);
                            message.error('复制失败，请手动选择文本复制');
                        }
                    };

                    // 保存字幕
                    const saveTranscript = () => {
                        if (!transcriptText) {
                            message.warning('没有字幕内容可保存');
                            return;
                        }

                        localStorage.setItem('reactSavedTranscript', transcriptText);
                        localStorage.setItem('reactSavedTranscriptTime', new Date().toISOString());
                        message.success('字幕已保存到本地存储');
                    };

                    // 加载保存的字幕
                    const loadSavedTranscript = () => {
                        const savedTranscript = localStorage.getItem('reactSavedTranscript');
                        if (savedTranscript) {
                            const savedTime = localStorage.getItem('reactSavedTranscriptTime');
                            if (window.confirm(`发现保存的字幕内容 (${new Date(savedTime).toLocaleString()})，是否恢复？`)) {
                                setTranscriptText(savedTranscript);
                                message.success('字幕内容已恢复');
                            }
                        } else {
                            message.info('没有找到保存的字幕内容');
                        }
                    };

                    // 翻译单行文本
                    const translateText = async (text, sourceLang, targetLang) => {
                        const api = translateApis[currentTranslateApi];
                        
                        try {
                            let response;
                            
                            switch (currentTranslateApi) {
                                case 'localTranslate':
                                    // 本地翻译逻辑
                                    console.log('使用本地翻译API');
                                    // 在本地文件运行时，直接返回原始文本
                                    if (isLocalFile) {
                                        return text;
                                    }
                                    // 在服务器上运行时，模拟API调用
                                    await new Promise(resolve => setTimeout(resolve, 100)); // 模拟网络延迟
                                    return `[本地翻译] ${text}`; // 示例本地翻译
                                    
                                case 'myMemory':
                                    // MyMemory API - GET请求，CORS友好
                                    const myMemoryUrl = `${api.url}?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
                                    response = await fetch(myMemoryUrl);
                                    if (!response.ok) {
                                        throw new Error(`MyMemory API请求失败: ${response.status}`);
                                    }
                                    const myMemoryData = await response.json();
                                    return myMemoryData.responseData.translatedText;
                                    
                                case 'googleTranslate':
                                    // Google Translate API - GET请求，CORS友好
                                    const googleUrl = `${api.url}?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                                    response = await fetch(googleUrl);
                                    if (!response.ok) {
                                        throw new Error(`Google Translate API请求失败: ${response.status}`);
                                    }
                                    const googleData = await response.json();
                                    return googleData[0][0][0];
                                    
                                case 'libreTranslate':
                                    // LibreTranslate API - POST请求，可能有CORS问题
                                    response = await fetch(api.url, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            q: text,
                                            source: sourceLang,
                                            target: targetLang,
                                            format: 'text'
                                        })
                                    });
                                    if (!response.ok) {
                                        throw new Error(`LibreTranslate API请求失败: ${response.status}`);
                                    }
                                    const libreData = await response.json();
                                    return libreData.translatedText;
                                    
                                default:
                                    throw new Error('未知的翻译API');
                            }
                        } catch (error) {
                            console.error('翻译请求失败:', error);
                            // 如果当前API失败，尝试切换到其他API
                            if (currentTranslateApi !== 'localTranslate') { // 避免无限循环
                                console.log('尝试切换到本地翻译API...');
                                setCurrentTranslateApi('localTranslate');
                                return await translateText(text, sourceLang, targetLang);
                            }
                            throw error;
                        }
                    };

                    // 翻译字幕
                    const translateTranscript = async () => {
                        if (!transcriptText || transcriptText === '等待语音输入...') {
                            message.warning('没有字幕内容可翻译');
                            return;
                        }

                        if (isTranslating) {
                            message.warning('正在翻译中，请稍候...');
                            return;
                        }

                        setIsTranslating(true);
                        setTranslationStatus({ 
                            show: true, 
                            message: '正在翻译...', 
                            type: 'info' 
                        });
                        message.info('开始翻译字幕...');

                        try {
                            const lines = transcriptText.split('\n').filter(line => line.trim());
                            let translatedLines = [];

                            for (let i = 0; i < lines.length; i++) {
                                const line = lines[i];
                                if (line.trim()) {
                                    const match = line.match(/^(\[.*?\]) (.*)$/);
                                    if (match) {
                                        const timestamp = match[1];
                                        const text = match[2];
                                        
                                        try {
                                            const translatedText = await translateText(text, 'zh', translationSettings.targetLanguage);
                                            translatedLines.push(`${timestamp} ${translatedText}`);
                                            setTranslationStatus({
                                                show: true,
                                                message: `正在翻译第 ${i + 1}/${lines.length} 行...`,
                                                type: 'info'
                                            });
                                        } catch (err) {
                                            console.error('翻译失败:', err);
                                            translatedLines.push(`${timestamp} [翻译失败] ${text}`);
                                        }
                                    } else {
                                        translatedLines.push(line);
                                    }
                                }
                            }

                            setTranslationText(translatedLines.join('\n'));
                            setTranslationStatus({ 
                                show: true, 
                                message: '翻译完成！', 
                                type: 'success' 
                            });
                            message.success('翻译完成');
                            
                            setTimeout(() => {
                                setTranslationStatus({ show: false, message: '', type: 'info' });
                            }, 3000);
                        } catch (error) {
                            console.error('翻译失败:', error);
                            let errorMessage = '翻译失败: ' + error.message;
                            
                            // 如果是CORS错误，提供解决方案
                            if (error.message.includes('CORS') || error.message.includes('preflight')) {
                                errorMessage = '翻译失败: CORS跨域问题。请尝试切换到其他翻译API，或使用本地服务器运行此文件。';
                            }
                            
                            setTranslationStatus({ 
                                show: true, 
                                message: errorMessage, 
                                type: 'error' 
                            });
                            message.error(errorMessage);
                            
                            setTimeout(() => {
                                setTranslationStatus({ show: false, message: '', type: 'info' });
                            }, 8000);
                        } finally {
                            setIsTranslating(false);
                        }
                    };

                    // 清空翻译
                    const clearTranslation = () => {
                        setTranslationText('');
                        setTranslationStatus({ show: false, message: '', type: 'info' });
                        message.success('翻译已清空');
                    };

                    // 导出翻译
                    const exportTranslation = () => {
                        if (!translationText || translationText === '等待翻译...') {
                            message.warning('没有翻译内容可导出');
                            return;
                        }

                        const blob = new Blob([translationText], { type: 'text/plain;charset=utf-8' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `react-translation-${translationSettings.targetLanguage}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                        a.click();
                        URL.revokeObjectURL(url);

                        message.success('翻译导出成功');
                    };

                    // 复制翻译
                    const copyTranslation = async () => {
                        if (!translationText || translationText === '等待翻译...') {
                            message.warning('没有翻译内容可复制');
                            return;
                        }

                        try {
                            await navigator.clipboard.writeText(translationText);
                            message.success('翻译已复制到剪贴板');
                        } catch (error) {
                            console.error('复制失败:', error);
                            message.error('复制失败，请手动选择文本复制');
                        }
                    };
                    
                    // 保存翻译
                    const saveTranslation = () => {
                        if (!translationText || translationText === '等待翻译...') {
                            message.warning('没有翻译内容可保存');
                            return;
                        }
                        
                        localStorage.setItem('reactSavedTranslation', translationText);
                        localStorage.setItem('reactSavedTranslationTime', new Date().toISOString());
                        localStorage.setItem('reactSavedTranslationLang', translationSettings.targetLanguage);
                        message.success('翻译已保存到本地存储');
                    };
                    
                    // 加载保存的翻译
                    const loadSavedTranslation = () => {
                        const savedTranslation = localStorage.getItem('reactSavedTranslation');
                        if (savedTranslation) {
                            const savedTime = localStorage.getItem('reactSavedTranslationTime');
                            const savedLang = localStorage.getItem('reactSavedTranslationLang');
                            
                            if (window.confirm(`发现保存的翻译内容 (${new Date(savedTime).toLocaleString()}, 语言: ${savedLang})，是否恢复？`)) {
                                setTranslationText(savedTranslation);
                                setTranslationSettings(prev => ({ ...prev, targetLanguage: savedLang || 'en' }));
                                message.success('翻译内容已恢复');
                            }
                        } else {
                            message.info('没有找到保存的翻译内容');
                        }
                    };

                    // 组件卸载时清理
                    useEffect(() => {
                        return () => {
                            if (timerRef.current) {
                                clearInterval(timerRef.current);
                            }
                            if (stream) {
                                stream.getTracks().forEach(track => track.stop());
                            }
                            if (videoUrl) {
                                URL.revokeObjectURL(videoUrl);
                            }
                        };
                    }, []);

                    // 页面加载时检查是否有保存的字幕和翻译
                    useEffect(() => {
                        const savedTranscript = localStorage.getItem('reactSavedTranscript');
                        if (savedTranscript) {
                            // 可以选择自动加载或提示用户
                            console.log('发现保存的字幕内容');
                        }
                        
                        // 自动加载保存的翻译
                        loadSavedTranslation();
                    }, []);

                    return React.createElement('div', { className: 'container' }, [
                        React.createElement('div', { className: 'header', key: 'header' }, [
                            React.createElement('h1', { key: 'title' }, 'React录屏+音频转字幕系统'),
                            React.createElement('p', { key: 'subtitle' }, '基于React 18 + Ant Design的现代化录屏与语音识别解决方案')
                        ]),
                        React.createElement('div', { className: 'content', key: 'content' }, [
                            // 控制和预览面板
                            React.createElement('div', { className: 'control-row', key: 'control-row' }, [
                                // 控制面板
                                React.createElement('div', { className: 'panel', key: 'control-panel' }, [
                                    React.createElement('h2', { className: 'section-title', key: 'control-title' }, '控制面板'),
                                    React.createElement(Alert, {
                                        key: 'status-alert',
                                        message: statusMessage,
                                        type: statusType,
                                        showIcon: true,
                                        style: { marginBottom: 20 },
                                        icon: isRecording ? React.createElement('span', { className: 'recording-indicator' }) : undefined
                                    }),
                                    React.createElement('div', { className: 'button-group', key: 'button-group' }, [
                                        React.createElement(Button, {
                                            key: 'start-btn',
                                            type: 'primary',
                                            icon: React.createElement(VideoCameraOutlined),
                                            onClick: startRecording,
                                            disabled: isRecording || !browserSupported
                                        }, '开始录制'),
                                        React.createElement(Button, {
                                            key: 'stop-btn',
                                            danger: true,
                                            icon: React.createElement(PauseCircleOutlined),
                                            onClick: stopRecording,
                                            disabled: !isRecording
                                        }, '停止录制'),
                                        React.createElement(Button, {
                                            key: 'test-speech-btn',
                                            type: 'default',
                                            icon: React.createElement('span', {}),
                                            onClick: testSpeechRecognition,
                                            disabled: isRecording
                                        }, '测试语音识别'),
                                        React.createElement(Button, {
                                            key: 'download-btn',
                                            type: 'primary',
                                            ghost: true,
                                            icon: React.createElement(DownloadOutlined),
                                            onClick: downloadVideo,
                                            disabled: !recordedVideo
                                        }, '下载视频'),
                                        React.createElement(Button, {
                                            key: 'clear-btn',
                                            icon: React.createElement(DeleteOutlined),
                                            onClick: clearTranscript
                                        }, '清空字幕')
                                    ]),
                                    isRecording && React.createElement('div', { key: 'recording-status', style: { marginTop: 20 } }, [
                                        React.createElement('p', { key: 'time' }, `录制时间: ${recordingTime}`),
                                        React.createElement(Progress, {
                                            key: 'progress',
                                            percent: recordingProgress,
                                            format: formatProgress,
                                            strokeColor: '#ff4757'
                                        })
                                    ])
                                ]),
                                // 视频预览面板
                                React.createElement('div', { className: 'panel', key: 'video-panel' }, [
                                    React.createElement('h2', { className: 'section-title', key: 'video-title' }, '视频预览'),
                                    React.createElement('div', { className: 'video-container', key: 'video-container' }, [
                                        React.createElement('video', {
                                            key: 'video',
                                            ref: videoRef,
                                            controls: true,
                                            style: { display: recordedVideo || isRecording ? 'block' : 'none' },
                                            src: recordedVideo ? videoUrl : undefined
                                        }),
                                        (!isRecording && !recordedVideo) && React.createElement('div', {
                                            key: 'placeholder',
                                            className: 'video-placeholder'
                                        }, '点击"开始录制"开始录屏')
                                    ]),
                                    React.createElement(Card, {
                                        key: 'recording-info',
                                        size: 'small',
                                        title: '录制信息'
                                    }, React.createElement('div', {}, recordingInfo))
                                ])
                            ]),
                            // 字幕面板
                            React.createElement('div', { className: 'transcript-panel', key: 'transcript-panel' }, [
                                React.createElement('h2', { className: 'section-title', key: 'transcript-title' }, '实时字幕'),
                                React.createElement('div', {
                                    key: 'transcript-content',
                                    className: 'transcript-content'
                                }, transcriptText || '等待语音输入...'),
                                React.createElement('div', { className: 'button-group', key: 'transcript-buttons' }, [
                                    React.createElement(Button, {
                                        key: 'export-btn',
                                        icon: React.createElement(FileTextOutlined),
                                        onClick: exportTranscript
                                    }, '导出字幕'),
                                    React.createElement(Button, {
                                        key: 'copy-btn',
                                        icon: React.createElement(CopyOutlined),
                                        onClick: copyTranscript
                                    }, '复制文本'),
                                    React.createElement(Button, {
                                        key: 'save-btn',
                                        icon: React.createElement(FolderOutlined),
                                        onClick: saveTranscript
                                    }, '保存字幕'),
                                    React.createElement(Button, {
                                        key: 'load-btn',
                                        icon: React.createElement('span', {}),
                                        onClick: loadSavedTranscript
                                    }, '加载字幕')
                                ])
                            ]),
                            // 翻译面板
                            React.createElement('div', { className: 'translation-panel', key: 'translation-panel' }, [
                                React.createElement('h2', { className: 'section-title', key: 'translation-title' }, '翻译功能'),
                                React.createElement('div', {
                                    key: 'translation-controls',
                                    style: { marginBottom: 20 }
                                }, [
                                    React.createElement(Select, {
                                        key: 'api-select',
                                        value: currentTranslateApi,
                                        onChange: (value) => {
                                            setCurrentTranslateApi(value);
                                            if (isLocalFile && value !== 'localTranslate') {
                                                message.warning('注意：在本地文件运行时，网络翻译API可能遇到CORS问题。建议使用"本地翻译"选项。');
                                            }
                                        },
                                        style: { width: 180, marginRight: 15 },
                                        placeholder: '选择翻译API'
                                    }, [
                                        React.createElement(Select.Option, { key: 'localTranslate', value: 'localTranslate' }, '本地翻译 (无CORS问题)'),
                                        React.createElement(Select.Option, { key: 'myMemory', value: 'myMemory' }, 'MyMemory (免费)'),
                                        React.createElement(Select.Option, { key: 'googleTranslate', value: 'googleTranslate' }, 'Google Translate (免费)'),
                                        React.createElement(Select.Option, { key: 'libreTranslate', value: 'libreTranslate' }, 'LibreTranslate (免费)')
                                    ]),
                                    React.createElement(Select, {
                                        key: 'language-select',
                                        value: translationSettings.targetLanguage,
                                        onChange: (value) => setTranslationSettings(prev => ({ ...prev, targetLanguage: value })),
                                        style: { width: 200, marginRight: 15 },
                                        placeholder: '选择目标语言'
                                    }, [
                                        React.createElement(Select.Option, { key: 'en', value: 'en' }, '英语 (English)'),
                                        React.createElement(Select.Option, { key: 'ja', value: 'ja' }, '日语 (日本語)'),
                                        React.createElement(Select.Option, { key: 'ko', value: 'ko' }, '韩语 (한국어)'),
                                        React.createElement(Select.Option, { key: 'fr', value: 'fr' }, '法语 (Français)'),
                                        React.createElement(Select.Option, { key: 'de', value: 'de' }, '德语 (Deutsch)'),
                                        React.createElement(Select.Option, { key: 'es', value: 'es' }, '西班牙语 (Español)'),
                                        React.createElement(Select.Option, { key: 'ru', value: 'ru' }, '俄语 (Русский)'),
                                        React.createElement(Select.Option, { key: 'ar', value: 'ar' }, '阿拉伯语 (العربية)'),
                                        React.createElement(Select.Option, { key: 'pt', value: 'pt' }, '葡萄牙语 (Português)'),
                                        React.createElement(Select.Option, { key: 'it', value: 'it' }, '意大利语 (Italiano)')
                                    ]),
                                    React.createElement(Button, {
                                        key: 'translate-btn',
                                        type: 'primary',
                                        icon: React.createElement(ReloadOutlined),
                                        onClick: translateTranscript,
                                        loading: isTranslating,
                                        disabled: !transcriptText || transcriptText === '等待语音输入...'
                                    }, '翻译字幕'),
                                    React.createElement(Button, {
                                        key: 'clear-translation-btn',
                                        icon: React.createElement(DeleteOutlined),
                                        onClick: clearTranslation
                                    }, '清空翻译')
                                ]),
                                translationStatus.show && React.createElement('div', {
                                    key: 'translation-status',
                                    className: 'translation-status'
                                }, React.createElement(Alert, {
                                    key: 'status-alert',
                                    message: translationStatus.message,
                                    type: translationStatus.type,
                                    showIcon: true,
                                    closable: false
                                })),
                                React.createElement('div', {
                                    key: 'translation-content',
                                    className: 'translation-content'
                                }, translationText || '等待翻译...'),
                                React.createElement('div', { className: 'button-group', key: 'translation-buttons' }, [
                                    React.createElement(Button, {
                                        key: 'export-translation-btn',
                                        icon: React.createElement(FileTextOutlined),
                                        onClick: exportTranslation,
                                        disabled: !translationText || translationText === '等待翻译...'
                                    }, '导出翻译'),
                                    React.createElement(Button, {
                                        key: 'copy-translation-btn',
                                        icon: React.createElement(CopyOutlined),
                                        onClick: copyTranslation,
                                        disabled: !translationText || translationText === '等待翻译...'
                                    }, '复制翻译'),
                                    React.createElement(Button, {
                                        key: 'save-translation-btn',
                                        icon: React.createElement(FolderOutlined),
                                        onClick: saveTranslation,
                                        disabled: !translationText || translationText === '等待翻译...'
                                    }, '保存翻译'),
                                    React.createElement(Button, {
                                        key: 'load-translation-btn',
                                        icon: React.createElement('span', {}, ''),
                                        onClick: loadSavedTranslation
                                    }, '加载翻译')
                                ])
                            ]),
                            // 设置面板
                            React.createElement('div', { className: 'settings-panel', key: 'settings-panel' }, [
                                React.createElement('h2', { className: 'section-title', key: 'settings-title' }, '录制设置'),
                                React.createElement('div', { className: 'settings-grid', key: 'settings-grid' }, [
                                    React.createElement(Select, {
                                        key: 'quality-select',
                                        value: settings.videoQuality,
                                        onChange: (value) => setSettings(prev => ({ ...prev, videoQuality: value })),
                                        placeholder: '选择视频质量'
                                    }, [
                                        React.createElement(Select.Option, { key: '720p', value: '720p' }, '720p (推荐)'),
                                        React.createElement(Select.Option, { key: '1080p', value: '1080p' }, '1080p (高质量)'),
                                        React.createElement(Select.Option, { key: '480p', value: '480p' }, '480p (流畅)')
                                    ]),
                                    React.createElement(Select, {
                                        key: 'audio-select',
                                        value: settings.audioSource,
                                        onChange: (value) => setSettings(prev => ({ ...prev, audioSource: value })),
                                        placeholder: '选择音频来源'
                                    }, [
                                        React.createElement(Select.Option, { key: 'system', value: 'system' }, '系统音频'),
                                        React.createElement(Select.Option, { key: 'microphone', value: 'microphone' }, '麦克风'),
                                        React.createElement(Select.Option, { key: 'both', value: 'both' }, '系统+麦克风')
                                    ]),
                                    React.createElement(Select, {
                                        key: 'lang-select',
                                        value: settings.language,
                                        onChange: (value) => setSettings(prev => ({ ...prev, language: value })),
                                        placeholder: '识别语言'
                                    }, [
                                        React.createElement(Select.Option, { key: 'zh-CN', value: 'zh-CN' }, '中文 (简体)'),
                                        React.createElement(Select.Option, { key: 'en-US', value: 'en-US' }, 'English (US)'),
                                        React.createElement(Select.Option, { key: 'ja-JP', value: 'ja-JP' }, '日本語'),
                                        React.createElement(Select.Option, { key: 'ko-KR', value: 'ko-KR' }, '한국어')
                                    ]),
                                    React.createElement(Switch, {
                                        key: 'cont-switch',
                                        checked: settings.continuous,
                                        onChange: (checked) => setSettings(prev => ({ ...prev, continuous: checked })),
                                        checkedChildren: '连续识别',
                                        unCheckedChildren: '单次识别'
                                    })
                                ])
                            ])
                        ])
                    ]);
                };

                // 渲染应用
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(React.createElement(ScreenRecordApp));
                
            } catch (error) {
                console.error('初始化失败:', error);
                document.getElementById('root').innerHTML = `
                    <div class="error-message">
                        <h2>系统初始化失败</h2>
                        <p>错误信息: ${error.message}</p>
                        <p>请刷新页面重试，或检查网络连接</p>
                    </div>
                `;
            }
        }

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>