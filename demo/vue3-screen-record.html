<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue3录屏+音频转字幕系统</title>
    
    <!-- Vue3 + Element Plus -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    
    <style>
        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #ffffff;
            color: #1a202c;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background: #ffffff;
            color: #1a202c;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
            color: #1a202c;
        }
        
        .main-content {
            padding: 32px;
        }
        
        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 28px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: box-shadow 0.2s ease;
        }
        
        .panel:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 24px;
            color: #2d3748;
            position: relative;
            padding-bottom: 8px;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background: #667eea;
            border-radius: 2px;
        }
        
        .video-container {
            width: 100%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
            position: relative;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .video-container video {
            width: 100%;
            display: block;
            background: #000;
        }
        
        .video-container .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a202c;
            color: #a0aec0;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .video-placeholder {
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1em;
        }
        
        .status-card {
            margin-bottom: 20px;
        }
        
        .transcript-panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .transcript-content {
            background: #f8fafc;
            border-radius: 8px;
            padding: 24px;
            min-height: 300px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            line-height: 1.7;
            overflow-y: auto;
            max-height: 400px;
            color: #2d3748;
            font-size: 0.95em;
        }
        
        .translation-panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .translation-content {
            background: #f8fafc;
            border-radius: 8px;
            padding: 24px;
            min-height: 300px;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            line-height: 1.7;
            overflow-y: auto;
            max-height: 400px;
            color: #2d3748;
            font-size: 0.95em;
        }
        
        .settings-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #f56c6c;
            border-radius: 50%;
            animation: pulse 1s infinite;
            margin-left: 10px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .el-progress {
            margin: 15px 0;
        }
        
        .translation-controls {
            margin-bottom: 20px;
        }
        
        .translation-status {
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .control-row {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 返回文档链接 -->
    <div style="position: fixed; top: 10px; left: 10px; z-index: 2000; background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
        <a href="https://www.siqiongbiluo.love/article/23" style="text-decoration: none; color: #4fc08d; font-size: 14px; font-weight: 500;">← 返回文档</a>
    </div>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>Vue3录屏+音频转字幕系统</h1>
                <p>基于Vue3 Composition API + Element Plus的现代化录屏与语音识别解决方案</p>
            </div>
            
            <div class="main-content">
                <!-- 设置面板 -->
                <div class="settings-panel">
                    <h2 class="section-title">录制设置</h2>
                    <div class="settings-grid">
                        <el-select v-model="settings.videoQuality" placeholder="选择视频质量">
                            <el-option label="720p (推荐)" value="720p"></el-option>
                            <el-option label="1080p (高质量)" value="1080p"></el-option>
                            <el-option label="480p (流畅)" value="480p"></el-option>
                        </el-select>
                        
                        <el-select v-model="settings.audioSource" placeholder="选择音频来源">
                            <el-option label="系统音频" value="system"></el-option>
                            <el-option label="麦克风" value="microphone"></el-option>
                            <el-option label="系统+麦克风" value="both"></el-option>
                        </el-select>
                        
                        <el-select v-model="settings.language" placeholder="识别语言">
                            <el-option label="中文 (简体)" value="zh-CN"></el-option>
                            <el-option label="English (US)" value="en-US"></el-option>
                            <el-option label="日本語" value="ja-JP"></el-option>
                            <el-option label="한국어" value="ko-KR"></el-option>
                        </el-select>
                        
                        <el-switch
                            v-model="settings.continuous"
                            active-text="连续识别">
                        </el-switch>
                    </div>
                </div>
                
                <!-- 控制和预览面板 -->
                <div class="control-row">
                    <!-- 控制面板 -->
                    <div class="panel">
                        <h2 class="section-title">控制面板</h2>
                        
                        <el-alert
                            :title="statusMessage"
                            :type="statusType"
                            :closable="false"
                            class="status-card">
                            <span v-if="isRecording" class="recording-indicator"></span>
                        </el-alert>
                        
                        <div style="margin-bottom: 20px;">
                            <el-button
                                type="primary"
                                :icon="VideoCamera"
                                @click="startRecording"
                                :disabled="isRecording || !browserSupported">
                                开始录制
                            </el-button>
                            
                            <el-button
                                type="danger"
                                :icon="VideoPause"
                                @click="stopRecording"
                                :disabled="!isRecording">
                                停止录制
                            </el-button>
                            
                            <el-button
                                type="success"
                                :icon="Download"
                                @click="downloadVideo"
                                :disabled="!recordedVideo">
                                下载视频
                            </el-button>
                            
                            <el-button
                                :icon="Delete"
                                @click="clearTranscript">
                                清空字幕
                            </el-button>
                        </div>
                        
                        <el-progress
                            v-if="isRecording"
                            :percentage="recordingProgress"
                            :format="formatProgress">
                        </el-progress>
                        
                        <div v-if="recordingTime" style="color: #666; font-size: 14px;">
                            录制时间: {{ recordingTime }}
                        </div>
                    </div>
                    
                    <!-- 视频预览面板 -->
                    <div class="panel">
                        <h2 class="section-title">视频预览</h2>
                        
                        <div class="video-container">
                            <video ref="videoElement" controls style="display: block;"></video>
                            <div v-if="!isRecording && !recordedVideo" class="video-placeholder">
                                点击"开始录制"开始录屏
                            </div>
                        </div>
                        
                        <el-card shadow="never">
                            <template #header>录制信息</template>
                            <div>{{ recordingInfo }}</div>
                        </el-card>
                    </div>
                </div>
                
                <!-- 字幕面板 -->
                <div class="transcript-panel">
                    <h2 class="section-title">实时字幕</h2>
                    
                    <div class="transcript-content">{{ transcriptText || '等待语音输入...' }}</div>
                    
                    <div style="margin-top: 20px;">
                        <el-button
                            :icon="Document"
                            @click="exportTranscript">
                            导出字幕
                        </el-button>
                        
                        <el-button
                            :icon="CopyDocument"
                            @click="copyTranscript">
                            复制文本
                        </el-button>
                        
                        <el-button
                            :icon="Folder"
                            @click="saveTranscript">
                            保存字幕
                        </el-button>
                    </div>
                </div>
                
                <!-- 翻译面板 -->
                <div class="translation-panel">
                    <h2 class="section-title">翻译功能</h2>
                    
                    <div class="translation-controls">
                        <el-select v-model="currentTranslateApi" placeholder="选择翻译API" style="width: 180px; margin-right: 15px;">
                            <el-option label="本地翻译 (无CORS问题)" value="localTranslate"></el-option>
                            <el-option label="MyMemory (免费)" value="myMemory"></el-option>
                            <el-option label="Google Translate (免费)" value="googleTranslate"></el-option>
                            <el-option label="LibreTranslate (免费)" value="libreTranslate"></el-option>
                        </el-select>
                        <el-select v-model="translationSettings.targetLanguage" placeholder="选择目标语言" style="width: 200px; margin-right: 15px;">
                            <el-option label="英语 (English)" value="en"></el-option>
                            <el-option label="日语 (日本語)" value="ja"></el-option>
                            <el-option label="韩语 (한국어)" value="ko"></el-option>
                            <el-option label="法语 (Français)" value="fr"></el-option>
                            <el-option label="德语 (Deutsch)" value="de"></el-option>
                            <el-option label="西班牙语 (Español)" value="es"></el-option>
                            <el-option label="俄语 (Русский)" value="ru"></el-option>
                            <el-option label="阿拉伯语 (العربية)" value="ar"></el-option>
                            <el-option label="葡萄牙语 (Português)" value="pt"></el-option>
                            <el-option label="意大利语 (Italiano)" value="it"></el-option>
                        </el-select>
                        
                        <el-button
                            type="warning"
                            :icon="Refresh"
                            @click="translateTranscript"
                            :loading="isTranslating"
                            :disabled="!transcriptText || transcriptText === '等待语音输入...'">
                            翻译字幕
                        </el-button>
                        
                        <el-button
                            :icon="Delete"
                            @click="clearTranslation">
                            清空翻译
                        </el-button>
                    </div>
                    
                    <div class="translation-status" v-if="translationStatus.show">
                        <el-alert
                            :title="translationStatus.message"
                            :type="translationStatus.type"
                            :closable="false">
                        </el-alert>
                    </div>
                    
                    <div class="translation-content">{{ translationText || '等待翻译...' }}</div>
                    
                    <div style="margin-top: 20px;">
                        <el-button
                            :icon="Document"
                            @click="exportTranslation"
                            :disabled="!translationText || translationText === '等待翻译...'">
                            导出翻译
                        </el-button>
                        
                        <el-button
                            :icon="CopyDocument"
                            @click="copyTranslation"
                            :disabled="!translationText || translationText === '等待翻译...'">
                            复制翻译
                        </el-button>
                        
                        <el-button
                            :icon="Folder"
                            @click="saveTranslation"
                            :disabled="!translationText || translationText === '等待翻译...'">
                            保存翻译
                        </el-button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, onBeforeUnmount, watch, nextTick } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        // Element Plus Icons
        const {
            VideoCamera,
            VideoPause, 
            Download,
            Delete,
            Document,
            CopyDocument,
            Folder,
            Refresh
        } = ElementPlusIconsVue;

        const App = {
            components: {
                VideoCamera,
                VideoPause,
                Download,
                Delete,
                Document,
                CopyDocument,
                Folder,
                Refresh
            },
            
            setup() {
                // 录制相关响应式数据
                const mediaRecorder = ref(null);
                const recordedChunks = ref([]);
                const stream = ref(null);
                const recognition = ref(null);
                const isRecording = ref(false);
                const startTime = ref(null);
                const videoUrl = ref('');
                const recordedVideo = ref(false);
                
                // 字幕相关
                const transcriptText = ref('');
                
                // 翻译相关
                const translationText = ref('');
                const isTranslating = ref(false);
                const translationSettings = reactive({
                    targetLanguage: 'en'
                });
                const translationStatus = reactive({
                    show: false,
                    message: '',
                    type: 'info'
                });
                
                // 状态相关
                const statusMessage = ref('系统就绪');
                const statusType = ref('success');
                const recordingInfo = ref('等待开始录制...');
                const recordingTime = ref('');
                const recordingProgress = ref(0);
                const browserSupported = ref(true);
                
                // 设置
                const settings = reactive({
                    videoQuality: '720p',
                    audioSource: 'system',
                    language: 'zh-CN',
                    continuous: true
                });
                
                // 定时器
                const timer = ref(null);
                
                // 翻译API配置 - 提供多个选项
                const translateApis = reactive({
                    localTranslate: {
                        url: 'local',
                        name: '本地翻译 (无CORS问题)',
                        cors: true
                    },
                    myMemory: {
                        url: 'https://api.mymemory.translated.net/get',
                        name: 'MyMemory (免费)',
                        cors: true
                    },
                    googleTranslate: {
                        url: 'https://translate.googleapis.com/translate_a/single',
                        name: 'Google Translate (免费)',
                        cors: true
                    },
                    libreTranslate: {
                        url: 'https://libretranslate.de/translate',
                        name: 'LibreTranslate (免费)',
                        cors: false
                    }
                });
                
                // 检测是否为本地文件运行
                const isLocalFile = ref(window.location.protocol === 'file:');
                const currentTranslateApi = ref(window.location.protocol === 'file:' ? 'localTranslate' : 'myMemory'); // 本地文件默认使用本地翻译
                
                // 检查浏览器支持
                const checkBrowserSupport = () => {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                        browserSupported.value = false;
                        statusMessage.value = '浏览器不支持屏幕录制功能';
                        statusType.value = 'error';
                        ElMessage.error('浏览器不支持屏幕录制功能');
                    }
                };
                
                // 初始化语音识别
                const initSpeechRecognition = () => {
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                        recognition.value = new SpeechRecognition();
                        
                        recognition.value.lang = settings.language;
                        recognition.value.continuous = settings.continuous;
                        recognition.value.interimResults = true;
                        recognition.value.maxAlternatives = 1;

                        recognition.value.onstart = () => {
                            console.log('语音识别已开始');
                        };

                        recognition.value.onresult = (event) => {
                            let finalTranscript = '';

                            for (let i = event.resultIndex; i < event.results.length; i++) {
                                const transcript = event.results[i][0].transcript;
                                if (event.results[i].isFinal) {
                                    finalTranscript += transcript;
                                }
                            }

                            if (finalTranscript) {
                                const timestamp = getTimestamp();
                                const line = `[${timestamp}] ${finalTranscript}\n`;
                                transcriptText.value += line;
                            }
                        };

                        recognition.value.onerror = (event) => {
                            console.error('语音识别错误:', event.error);
                            ElMessage.error('语音识别错误: ' + event.error);
                        };

                        recognition.value.onend = () => {
                            if (isRecording.value) {
                                setTimeout(() => {
                                    if (isRecording.value) {
                                        recognition.value.start();
                                    }
                                }, 100);
                            }
                        };

                        return true;
                    } else {
                        ElMessage.error('浏览器不支持语音识别功能');
                        return false;
                    }
                };
                
                // 获取视频约束
                const getVideoConstraints = () => {
                    const constraints = {
                        '1080p': { width: 1920, height: 1080, frameRate: 30 },
                        '720p': { width: 1280, height: 720, frameRate: 30 },
                        '480p': { width: 854, height: 480, frameRate: 24 }
                    };
                    
                    return constraints[settings.videoQuality];
                };
                
                // 获取时间戳
                const getTimestamp = () => {
                    if (!startTime.value) return '00:00:00';
                    
                    const elapsed = Date.now() - startTime.value;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                };
                
                // 开始录制
                const startRecording = async () => {
                    try {
                        // 重置之前的录制状态
                        if (stream.value) {
                            stream.value.getTracks().forEach(track => track.stop());
                        }
                        
                        const displayStream = await navigator.mediaDevices.getDisplayMedia({
                            video: getVideoConstraints(),
                            audio: true
                        });

                        let audioStream = null;
                        if (settings.audioSource === 'microphone' || settings.audioSource === 'both') {
                            try {
                                audioStream = await navigator.mediaDevices.getUserMedia({
                                    audio: true
                                });
                            } catch (err) {
                                console.warn('无法获取麦克风权限:', err);
                                ElMessage.warning('无法获取麦克风权限');
                            }
                        }

                        stream.value = displayStream;

                        // 设置实时预览 - 使用srcObject而不是createObjectURL
                        videoUrl.value = '';
                        nextTick(() => {
                            const videoElement = document.querySelector('#app video');
                            if (videoElement) {
                                try {
                                    videoElement.srcObject = displayStream;
                                    videoElement.onloadedmetadata = () => {
                                        videoElement.play().catch(e => {
                                            console.log('自动播放被阻止:', e);
                                            ElMessage.info('请手动点击播放按钮开始预览');
                                        });
                                    };
                                    videoElement.onerror = (e) => {
                                        console.error('视频预览错误:', e);
                                        ElMessage.error('视频预览加载失败');
                                    };
                                } catch (err) {
                                    console.error('设置视频预览失败:', err);
                                    ElMessage.error('视频预览设置失败');
                                }
                            }
                        });

                        recordedChunks.value = [];
                        
                        // 检查支持的MIME类型
                        let mimeType = 'video/webm;codecs=vp9';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = 'video/webm;codecs=vp8';
                        }
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = 'video/webm';
                        }
                        
                        mediaRecorder.value = new MediaRecorder(stream.value, {
                            mimeType: mimeType
                        });

                        mediaRecorder.value.ondataavailable = (event) => {
                            if (event.data.size > 0) {
                                recordedChunks.value.push(event.data);
                            }
                        };

                        mediaRecorder.value.onstop = () => {
                            const blob = new Blob(recordedChunks.value, { type: 'video/webm' });
                            videoUrl.value = URL.createObjectURL(blob);
                            recordedVideo.value = true;
                            
                            // 清除实时预览的srcObject
                            nextTick(() => {
                                const videoElement = document.querySelector('#app video');
                                if (videoElement) {
                                    videoElement.srcObject = null;
                                }
                            });
                            
                            statusMessage.value = '录制完成，可以下载视频';
                            statusType.value = 'success';
                            ElMessage.success('录制完成');
                        };

                        mediaRecorder.value.start(1000);
                        isRecording.value = true;
                        startTime.value = Date.now();

                        if (initSpeechRecognition()) {
                            recognition.value.start();
                        }

                        statusMessage.value = '正在录制中...';
                        statusType.value = 'warning';
                        recordingInfo.value = '录制进行中...';
                        startTimer();

                        stream.value.getVideoTracks()[0].onended = () => {
                            stopRecording();
                        };

                        ElMessage.success('录制开始');

                    } catch (err) {
                        console.error('开始录制失败:', err);
                        ElMessage.error('开始录制失败: ' + err.message);
                        statusMessage.value = '录制失败: ' + err.message;
                        statusType.value = 'error';
                    }
                };
                
                // 停止录制
                const stopRecording = () => {
                    if (mediaRecorder.value && isRecording.value) {
                        mediaRecorder.value.stop();
                        isRecording.value = false;

                        if (recognition.value) {
                            recognition.value.stop();
                        }

                        if (stream.value) {
                            stream.value.getTracks().forEach(track => track.stop());
                        }

                        if (timer.value) {
                            clearInterval(timer.value);
                        }

                        statusMessage.value = '录制已停止';
                        statusType.value = 'info';
                        recordingInfo.value = '录制已完成';
                        recordingProgress.value = 0;
                        
                        ElMessage.info('录制已停止');
                    }
                };
                
                // 下载视频
                const downloadVideo = () => {
                    if (recordedChunks.value.length > 0) {
                        const blob = new Blob(recordedChunks.value, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `vue3-screen-recording-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.webm`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        ElMessage.success('视频下载开始');
                    }
                };
                
                // 开始计时器
                const startTimer = () => {
                    timer.value = setInterval(() => {
                        if (!isRecording.value) {
                            clearInterval(timer.value);
                            return;
                        }
                        
                        const elapsed = Date.now() - startTime.value;
                        const minutes = Math.floor(elapsed / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        
                        recordingTime.value = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        const maxTime = 30 * 60 * 1000;
                        recordingProgress.value = Math.min((elapsed / maxTime) * 100, 100);
                    }, 1000);
                };
                
                // 格式化进度
                const formatProgress = (percentage) => {
                    return percentage === 100 ? '录制即将结束' : `${percentage.toFixed(1)}%`;
                };
                
                // 清空字幕
                const clearTranscript = () => {
                    transcriptText.value = '';
                    ElMessage.success('字幕已清空');
                };
                
                // 导出字幕
                const exportTranscript = () => {
                    if (!transcriptText.value) {
                        ElMessage.warning('没有字幕内容可导出');
                        return;
                    }
                    
                    const blob = new Blob([transcriptText.value], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vue3-transcript-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    ElMessage.success('字幕导出成功');
                };
                
                // 复制字幕
                const copyTranscript = () => {
                    if (!transcriptText.value) {
                        ElMessage.warning('没有字幕内容可复制');
                        return;
                    }
                    
                    navigator.clipboard.writeText(transcriptText.value).then(() => {
                        ElMessage.success('字幕已复制到剪贴板');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        ElMessage.error('复制失败');
                    });
                };
                
                // 保存字幕
                const saveTranscript = () => {
                    if (!transcriptText.value) {
                        ElMessage.warning('没有字幕内容可保存');
                        return;
                    }
                    
                    localStorage.setItem('vue3SavedTranscript', transcriptText.value);
                    localStorage.setItem('vue3SavedTranscriptTime', new Date().toISOString());
                    ElMessage.success('字幕已保存到本地存储');
                };
                
                // 加载保存的字幕
                const loadSavedTranscript = () => {
                    const savedTranscript = localStorage.getItem('vue3SavedTranscript');
                    if (savedTranscript) {
                        const savedTime = localStorage.getItem('vue3SavedTranscriptTime');
                        ElMessageBox.confirm(`发现保存的字幕内容 (${new Date(savedTime).toLocaleString()})，是否恢复？`, '提示', {
                            confirmButtonText: '恢复',
                            cancelButtonText: '取消',
                            type: 'info'
                        }).then(() => {
                            transcriptText.value = savedTranscript;
                            ElMessage.success('字幕内容已恢复');
                        }).catch(() => {
                            // 用户取消
                        });
                    }
                };
                
                // 翻译功能
                const translateTranscript = async () => {
                    if (!transcriptText.value || transcriptText.value === '等待语音输入...') {
                        ElMessage.warning('没有字幕内容可翻译');
                        return;
                    }

                    if (isTranslating.value) {
                        ElMessage.warning('正在翻译中，请稍候...');
                        return;
                    }

                    isTranslating.value = true;
                    translationStatus.show = true;
                    translationStatus.message = '正在翻译...';
                    translationStatus.type = 'info';

                    try {
                        // 将字幕文本按行分割并翻译
                        const lines = transcriptText.value.split('\n').filter(line => line.trim());
                        let translatedLines = [];

                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            if (line.trim()) {
                                // 提取时间戳和文本内容
                                const match = line.match(/^(\[.*?\]) (.*)$/);
                                if (match) {
                                    const timestamp = match[1];
                                    const text = match[2];
                                    
                                    try {
                                        const translatedText = await translateText(text, 'zh', translationSettings.targetLanguage);
                                        translatedLines.push(`${timestamp} ${translatedText}`);
                                        translationStatus.message = `正在翻译第 ${i + 1}/${lines.length} 行...`;
                                    } catch (err) {
                                        console.error('翻译失败:', err);
                                        translatedLines.push(`${timestamp} [翻译失败] ${text}`);
                                    }
                                } else {
                                    translatedLines.push(line);
                                }
                            }
                        }

                        translationText.value = translatedLines.join('\n');
                        translationStatus.message = '翻译完成';
                        translationStatus.type = 'success';
                        
                        setTimeout(() => {
                            translationStatus.show = false;
                        }, 3000);

                    } catch (err) {
                        console.error('翻译过程出错:', err);
                        let errorMessage = '翻译失败: ' + err.message;
                        
                        // 如果是CORS错误，提供解决方案
                        if (err.message.includes('CORS') || err.message.includes('preflight')) {
                            errorMessage = '翻译失败: CORS跨域问题。请尝试切换到其他翻译API，或使用本地服务器运行此文件。';
                        }
                        
                        translationStatus.message = errorMessage;
                        translationStatus.type = 'error';
                        setTimeout(() => {
                            translationStatus.show = false;
                        }, 8000);
                    } finally {
                        isTranslating.value = false;
                    }
                };

                // 翻译单行文本
                const translateText = async (text, sourceLang, targetLang) => {
                    const api = translateApis[currentTranslateApi.value];
                    
                    try {
                        let response;
                        
                        switch (currentTranslateApi.value) {
                            case 'localTranslate':
                                // 本地翻译逻辑
                                console.log('使用本地翻译API');
                                // 在本地文件运行时，直接返回原始文本
                                if (isLocalFile.value) {
                                    return text;
                                }
                                // 在服务器上运行时，模拟API调用
                                await new Promise(resolve => setTimeout(resolve, 100)); // 模拟网络延迟
                                return `[本地翻译] ${text}`; // 示例本地翻译
                                
                            case 'myMemory':
                                // MyMemory API - GET请求，CORS友好
                                const myMemoryUrl = `${api.url}?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
                                response = await fetch(myMemoryUrl);
                                if (!response.ok) {
                                    throw new Error(`MyMemory API请求失败: ${response.status}`);
                                }
                                const myMemoryData = await response.json();
                                return myMemoryData.responseData.translatedText;
                                
                            case 'googleTranslate':
                                // Google Translate API - GET请求，CORS友好
                                const googleUrl = `${api.url}?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
                                response = await fetch(googleUrl);
                                if (!response.ok) {
                                    throw new Error(`Google Translate API请求失败: ${response.status}`);
                                }
                                const googleData = await response.json();
                                return googleData[0][0][0];
                                
                            case 'libreTranslate':
                                // LibreTranslate API - POST请求，可能有CORS问题
                                response = await fetch(api.url, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        q: text,
                                        source: sourceLang,
                                        target: targetLang,
                                        format: 'text'
                                    })
                                });
                                if (!response.ok) {
                                    throw new Error(`LibreTranslate API请求失败: ${response.status}`);
                                }
                                const libreData = await response.json();
                                return libreData.translatedText;
                                
                            default:
                                throw new Error('未知的翻译API');
                        }
                    } catch (error) {
                        console.error('翻译请求失败:', error);
                        // 如果当前API失败，尝试切换到其他API
                        if (currentTranslateApi.value !== 'localTranslate') { // 避免无限循环
                            console.log('尝试切换到本地翻译API...');
                            currentTranslateApi.value = 'localTranslate';
                            return await translateText(text, sourceLang, targetLang);
                        }
                        throw error;
                    }
                };

                // 清空翻译
                const clearTranslation = () => {
                    translationText.value = '';
                    translationStatus.show = false;
                    ElMessage.success('翻译已清空');
                };

                // 导出翻译
                const exportTranslation = () => {
                    if (!translationText.value || translationText.value === '等待翻译...') {
                        ElMessage.warning('没有翻译内容可导出');
                        return;
                    }
                    
                    const blob = new Blob([translationText.value], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vue3-translation-${translationSettings.targetLanguage}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    ElMessage.success('翻译导出成功');
                };

                // 复制翻译
                const copyTranslation = () => {
                    if (!translationText.value || translationText.value === '等待翻译...') {
                        ElMessage.warning('没有翻译内容可复制');
                        return;
                    }
                    
                    navigator.clipboard.writeText(translationText.value).then(() => {
                        ElMessage.success('翻译已复制到剪贴板');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        ElMessage.error('复制失败');
                    });
                };

                // 保存翻译
                const saveTranslation = () => {
                    if (!translationText.value || translationText.value === '等待翻译...') {
                        ElMessage.warning('没有翻译内容可保存');
                        return;
                    }
                    
                    localStorage.setItem('vue3SavedTranslation', translationText.value);
                    localStorage.setItem('vue3SavedTranslationTime', new Date().toISOString());
                    localStorage.setItem('vue3SavedTranslationLang', translationSettings.targetLanguage);
                    ElMessage.success('翻译已保存到本地存储');
                };

                // 加载保存的翻译
                const loadSavedTranslation = () => {
                    const savedTranslation = localStorage.getItem('vue3SavedTranslation');
                    if (savedTranslation) {
                        const savedTime = localStorage.getItem('vue3SavedTranslationTime');
                        const savedLang = localStorage.getItem('vue3SavedTranslationLang');
                        
                        ElMessageBox.confirm(`发现保存的翻译内容 (${new Date(savedTime).toLocaleString()}, 语言: ${savedLang})，是否恢复？`, '提示', {
                            confirmButtonText: '恢复',
                            cancelButtonText: '取消',
                            type: 'info'
                        }).then(() => {
                            translationText.value = savedTranslation;
                            translationSettings.targetLanguage = savedLang || 'en';
                            ElMessage.success('翻译内容已恢复');
                        }).catch(() => {
                            // 用户取消
                        });
                    }
                };
                
                // 生命周期钩子
                onMounted(() => {
                    checkBrowserSupport();
                    loadSavedTranscript();
                    loadSavedTranslation();
                });
                
                onBeforeUnmount(() => {
                    if (timer.value) {
                        clearInterval(timer.value);
                    }
                    if (isRecording.value) {
                        stopRecording();
                    }
                });
                
                // 监听设置变化
                watch(() => settings.language, (newVal) => {
                    if (recognition.value) {
                        recognition.value.lang = newVal;
                    }
                });
                
                watch(() => settings.continuous, (newVal) => {
                    if (recognition.value) {
                        recognition.value.continuous = newVal;
                    }
                });
                
                // 监听翻译API变化
                watch(() => currentTranslateApi.value, (newVal) => {
                    console.log('切换到翻译API:', translateApis[newVal].name);
                    
                    // 如果是本地文件且选择了需要网络的API，给出提示
                    if (isLocalFile.value && newVal !== 'localTranslate') {
                        ElMessage.warning('注意：在本地文件运行时，网络翻译API可能遇到CORS问题。建议使用"本地翻译"选项。');
                    }
                });
                
                return {
                    // 响应式数据
                    isRecording,
                    videoUrl,
                    recordedVideo,
                    transcriptText,
                    translationText,
                    isTranslating,
                    translationSettings,
                    translationStatus,
                    currentTranslateApi,
                    isLocalFile,
                    statusMessage,
                    statusType,
                    recordingInfo,
                    recordingTime,
                    recordingProgress,
                    browserSupported,
                    settings,
                    
                    // 图标
                    VideoCamera,
                    VideoPause,
                    Download,
                    Delete,
                    Document,
                    CopyDocument,
                    Folder,
                    Refresh,
                    
                    // 方法
                    startRecording,
                    stopRecording,
                    downloadVideo,
                    formatProgress,
                    clearTranscript,
                    exportTranscript,
                    copyTranscript,
                    saveTranscript,
                    translateTranscript,
                    clearTranslation,
                    exportTranslation,
                    copyTranslation,
                    saveTranslation
                };
            }
        };

        createApp(App).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
